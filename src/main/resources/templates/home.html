<!DOCTYPE html>
<!--<html lang="en" >-->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chatroom</title>
    <meta name="description" content="#">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap core CSS -->
    <!--    		<link href="css/lib" type="text/css" rel="stylesheet">-->
    <!-- Swipe core CSS -->
    <!--    <link href="/css/swipe.min.css" type="text/css" rel="stylesheet">-->
    <!-- Favicon -->
    <link rel="stylesheet" href="/css/lib/bootstrap.min.css">
    <link rel="stylesheet" href="/css/swipe.min.css">
    <!--    <link href="img/favicon.png" type="image/png" rel="icon">-->
<!--    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
    <style>
        p, a, i, h5, span, h1, h2, h3, h4, h5, h6 {
            text-decoration: none;
        }
        .tag-input-wrapper {
            padding: 0;
            border-radius: 8px;
            background-color: #f5f5f5;
            max-width: 600px;
            border: none;

            max-height: 150px;
            overflow-y: auto;
        }

        .tag-area {
            display: flex;
            flex-direction: column;  /* Mỗi thẻ nằm trên 1 dòng */
            gap: 10px;
        }

        .recipient-tag {
            display: flex;
            align-items: center;
            width: 80%;
            padding: 6px 10px;
            margin-left: 10px;
            border-radius: 20px;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .recipient-tag img.avatar-sm {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .recipient-tag h5 {
            margin: 0;
            font-size: 14px;
            margin-right: auto;
        }

        .recipient-tag button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
        }

        .tag-area input {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 6px;
            min-height: 50px;
            font-size: 14px;
            outline: none;
        }
        .alert {
            display: none;
            padding: 10px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: opacity 0.5s ease;
        }

        .alert.show {
            display: block;
            opacity: 1;
        }

        .alert.fade-out {
            opacity: 0;
        }

        .alert.warning {
            background-color: #f8d7da; 
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
<main>
    <div class="layout">
        <div class="navigation">
            <div class="container">
                <div class="inside">
                    <!--                    menu-->
                    <div class="nav nav-tab menu">
                        <button class="btn"><img class="avatar-xl" alt="avatar"></button>
                        <a href="#members" data-toggle="tab"><i class="material-icons">account_circle</i></a>
                        <a href="#discussions" data-toggle="tab" class="active"><i class="material-icons active">chat_bubble_outline</i></a>
                        <a href="#notifications" data-toggle="tab" class="f-grow1"><i class="material-icons">notifications_none</i></a>
                        <!--                        <button class="btn mode"><i class="material-icons">brightness_2</i></button>-->
                        <a href="#settings" data-toggle="tab"><i class="material-icons">settings</i></a>
                        <button class="btn power" id="logout1" ><i class="material-icons">power_settings_new</i></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="container">
                <div class="col-md-12">
                    <div class="tab-content">
                        <div class="tab-pane fade" id="members">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="people">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons">search</i></button>
                                </form>
                                <button class="btn create" data-toggle="modal" data-target="#exampleModalCenter"><i class="material-icons">person_add</i></button>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterMembersBtn active show" data-toggle="list" data-filter="all" style="border: none" th:text="#{filter.all}">All</button>
                                <button class="btn filterMembersBtn" data-toggle="list" data-filter="online" style="border: none" th:text="#{filter.online}">Online</button>
                                <button class="btn filterMembersBtn" data-toggle="list" data-filter="offline" style="border: none" th:text="#{filter.offline}">Offline</button>
                            </div>
                            <!--                            contact list-->
                            <div class="contacts">
                                <h1 th:text="#{contacts}">Contacts</h1>
                                <div class="list-group" id="contacts" role="tablist">
                                    <!--                                    <a href="#" class="filterMembers all online contact" data-toggle="list">-->
                                    <!--                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">-->
                                    <!--                                        <div class="status">-->
                                    <!--                                            <i class="material-icons online">fiber_manual_record</i>-->
                                    <!--                                        </div>-->
                                    <!--                                        <div class="data">-->
                                    <!--                                            <h5>Janette Dalton</h5>-->
                                    <!--                                        </div>-->
                                    <!--                                    </a>-->
                                </div>
                            </div>
                        </div>
                        <!--                        discussions-->


                        <div id="discussions" class="tab-pane fade active show">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="conversations">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons">search</i></button>
                                </form>
                                <button class="btn create" data-toggle="modal" data-target="#startnewchat"><i class="material-icons">create</i></button>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterDiscussionsBtn active show" data-toggle="list" data-filter="all" th:text="#{filter.all}">All</button>
                                <button class="btn filterDiscussionsBtn" data-toggle="list" data-filter="read" th:text="#{filter.read}">Read</button>
                                <button class="btn filterDiscussionsBtn" data-toggle="list" data-filter="unread" th:text="#{filter.unread}">Unread</button>
                            </div>
                            <div class="discussions">
                                <h1 th:text="#{discussions}">Discussions</h1>
                                <div class="list-group" id="chats" role="tablist">
                                    <!--                                    <a href="#list-chat" class="filterDiscussions all unread single active" id="list-chat-list" data-toggle="list" role="tab">-->
                                    <!--                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">-->
                                    <!--                                        <div class="status">-->
                                    <!--                                            <i class="material-icons online">fiber_manual_record</i>-->
                                    <!--                                        </div>-->
                                    <!--                                        <div class="new bg-yellow">-->
                                    <!--                                             <span>+7</span>-->
                                    <!--                                        </div>-->
                                    <!--                                        <div class="data">-->
                                    <!--                                            <h5>Name</h5>-->
                                    <!--                                            <span>Latest time here(format time & day: 11:00am 1/1/24)</span>-->
                                    <!--                                            <p>Newest message here...</p>-->
                                    <!--                                        </div>-->
                                    <!--                                    </a>-->
                                </div>
                            </div>
                        </div>
                        <!-- End of Discussions -->
                        <!-- Start of Notifications -->
                        <div id="notifications" class="tab-pane fade">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="notice">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons filter-list">filter_list</i></button>
                                </form>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterNotificationsBtn active show" data-toggle="list" data-filter="all" th:text="#{filter.all}">All</button>
                                <button class="btn filterNotificationsBtn" data-toggle="list" data-filter="latest" th:text="#{filter.latest}">Latest</button>
                                <button class="btn filterNotificationsBtn" data-toggle="list" data-filter="oldest" th:text="#{filter.oldest}">Oldest</button>
                            </div>
                            <div class="notifications">
                                <h1 th:text="#{notifications}">Notifications</h1>
                                <div class="list-group" id="alerts" role="tablist">
                                    <a href="#" class="filterNotifications all latest notification" data-toggle="list">
                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">
                                        <div class="status">
                                            <i class="material-icons online">fiber_manual_record</i>
                                        </div>
                                        <div class="data">
                                            <p>Janette has accepted your friend request on Swipe.</p>
                                            <span>Oct 17, 2018</span>
                                        </div>
                                    </a>
                                    <a href="#" class="filterNotifications all latest notification" data-toggle="list">
                                        <img class="avatar-md" src="img/avatars/avatar-male-1.jpg" data-toggle="tooltip" data-placement="top" title="Michael" alt="avatar">
                                        <div class="status">
                                            <i class="material-icons online">fiber_manual_record</i>
                                        </div>
                                        <div class="data">
                                            <p>Michael, you have a new friend suggestion today.</p>
                                            <span>Jun 21, 2018</span>
                                        </div>
                                        <button class="btn"><span class="material-icons">add</span></button>
                                        <button class="btn"><span class="material-icons">close</span></button>
                                    </a>

                                </div>
                            </div>
                        </div>
                        <!-- End of Notifications -->
                        <!-- Start of Settings -->
                        <div class="tab-pane fade" id="settings">
                            <div class="settings">
                                <div class="profile">
                                    <img class="avatar-xl" alt="avatar">
                                    <h1>Michael Knudsen</h1>
                                    <!--                                    <span>Helena, Montana</span>-->
                                    <!--                                    <div class="stats">-->
                                    <!--                                        <div class="item">-->
                                    <!--                                            <h2>122</h2>-->
                                    <!--                                            <h3>Fellas</h3>-->
                                    <!--                                        </div>-->
                                    <!--                                        <div class="item">-->
                                    <!--                                            <h2>305</h2>-->
                                    <!--                                            <h3>Chats</h3>-->
                                    <!--                                        </div>-->
                                    <!--                                        <div class="item">-->
                                    <!--                                            <h2>1538</h2>-->
                                    <!--                                            <h3>Posts</h3>-->
                                    <!--                                        </div>-->
                                    <!--                                    </div>-->
                                </div>
                                <div class="categories" id="accordionSettings">
                                    <h1 th:text="#{settings}">Settings</h1>
                                    <!-- Start of My Account -->
                                    <div class="category">
                                        <a href="#" class="title collapsed" id="headingOne" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            <i class="material-icons md-30 online">person_outline</i>
                                            <div class="data">
                                                <h5 th:text="#{myaccount}">My Account</h5>
                                                <p th:text="#{myaccount.setting}">Update your profile details</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                        <div class="collapse" id="collapseOne" aria-labelledby="headingOne" data-parent="#accordionSettings">
                                            <div class="content">
                                                <div class="upload">
                                                    <div class="data">
                                                        <img class="avatar-xl" alt="image">
                                                        <label>
                                                            <input type="file" id="uploadInput" style="display: none;">
                                                            <span class="btn button" th:text="#{upload.avatar}" id="uploadBtn">Upload avatar</span>
                                                        </label>
                                                    </div>
                                                    <p th:text="#{avatar.content}">For best results, use an image at least 256px by 256px in either .jpg or .png format!</p>
                                                </div>
                                                <form id="change_profile" >
                                                    <div class="parent">
                                                        <div class="field">
                                                            <label for="firstName" th:text="#{first.name}">First name <span>*</span></label>
                                                            <input type="text" class="form-control" id="firstName" placeholder="First name" required>
                                                        </div>
                                                        <div class="field">
                                                            <label for="lastName" th:text="#{last.name}">Last name <span>*</span></label>
                                                            <input type="text" class="form-control" id="lastName" placeholder="Last name" required>
                                                        </div>
                                                    </div>
                                                    <div class="field">
                                                        <label for="email" th:text="#{setting.email}">Email <span>*</span></label>
                                                        <input type="email" class="form-control" id="email" placeholder="Enter your email address" required>
                                                    </div>
                                                    <div class="field">
                                                        <label for="username" th:text="#{setting.username}">Username <span>*</span></label>
                                                        <input class="form-control" id="username" placeholder="Enter your username" required>
                                                    </div>
                                                    <div class="field">
                                                        <label for="password" th:text="#{setting.password}">Password</label>
                                                        <input type="password" class="form-control" id="password" th:placeholder='#{password.content}'>
                                                    </div>
                                                    <!--                                                    <div class="field">-->
                                                    <!--                                                        <label for="location">Location</label>-->
                                                    <!--                                                        <input type="text" class="form-control" id="location" placeholder="Enter your location" value="Helena, Montana" required>-->
                                                    <!--                                                    </div>-->
                                                    <button type="button" class="btn btn-link w-100" id="deleteAccountBtn" th:text="#{delete.account}">Delete Account</button>
                                                    <button type="submit" class="btn button w-100" th:text="#{apply}">Apply</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End of My Account -->
                                    <!-- Start of Chat History -->
                                    <!--                                    <div class="category">-->
                                    <!--                                        <a href="#" class="title collapsed" id="headingTwo" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">-->
                                    <!--                                            <i class="material-icons md-30 online">mail_outline</i>-->
                                    <!--                                            <div class="data">-->
                                    <!--                                                <h5>Chats</h5>-->
                                    <!--                                                <p>Check your chat history</p>-->
                                    <!--                                            </div>-->
                                    <!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
                                    <!--                                        </a>-->
                                    <!--                                        <div class="collapse" id="collapseTwo" aria-labelledby="headingTwo" data-parent="#accordionSettings">-->
                                    <!--                                            <div class="content layer">-->
                                    <!--                                                <div class="history">-->
                                    <!--                                                    <p>When you clear your conversation history, the messages will be deleted from your own device.</p>-->
                                    <!--                                                    <p>The messages won't be deleted or cleared on the devices of the people you chatted with.</p>-->
                                    <!--                                                    <div class="custom-control custom-checkbox">-->
                                    <!--                                                        <input type="checkbox" class="custom-control-input" id="same-address">-->
                                    <!--                                                        <label class="custom-control-label" for="same-address">Hide will remove your chat history from the recent list.</label>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <div class="custom-control custom-checkbox">-->
                                    <!--                                                        <input type="checkbox" class="custom-control-input" id="save-info">-->
                                    <!--                                                        <label class="custom-control-label" for="save-info">Delete will remove your chat history from the device.</label>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <button type="submit" class="btn button w-100">Clear blah-blah</button>-->
                                    <!--                                                </div>-->
                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                    <!--                                    </div>-->
                                    <!-- End of Chat History -->
                                    <!-- Start of Notifications Settings -->
                                    <!--                                    <div class="category">-->
                                    <!--                                        <a href="#" class="title collapsed" id="headingThree" data-toggle="collapse" data-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">-->
                                    <!--                                            <i class="material-icons md-30 online">notifications_none</i>-->
                                    <!--                                            <div class="data">-->
                                    <!--                                                <h5>Notifications</h5>-->
                                    <!--                                                <p>Turn notifications on or off</p>-->
                                    <!--                                            </div>-->
                                    <!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
                                    <!--                                        </a>-->
                                    <!--                                        <div class="collapse" id="collapseThree" aria-labelledby="headingThree" data-parent="#accordionSettings">-->
                                    <!--                                            <div class="content no-layer">-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Desktop Notifications</h5>-->
                                    <!--                                                        <p>You can set up Swipe to receive notifications when you have new messages.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Unread Message Badge</h5>-->
                                    <!--                                                        <p>If enabled shows a red badge on the Swipe app icon when you have unread messages.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Taskbar Flashing</h5>-->
                                    <!--                                                        <p>Flashes the Swipe app on mobile in your taskbar when you have new notifications.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Notification Sound</h5>-->
                                    <!--                                                        <p>Set the app to alert you via notification sound when you have unread messages.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Vibrate</h5>-->
                                    <!--                                                        <p>Vibrate when receiving new messages (Ensure system vibration is also enabled).</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Turn On Lights</h5>-->
                                    <!--                                                        <p>When someone send you a text message you will receive alert via notification light.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                    <!--                                    </div>-->
                                    <!--                                    <div class="category">-->
                                    <!--                                        <a href="#" class="title collapsed" id="headingFour" data-toggle="collapse" data-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">-->
                                    <!--                                            <i class="material-icons md-30 online">sync</i>-->
                                    <!--                                            <div class="data">-->
                                    <!--                                                <h5>Connections</h5>-->
                                    <!--                                                <p>Sync your social accounts</p>-->
                                    <!--                                            </div>-->
                                    <!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
                                    <!--                                        </a>-->
                                    <!--                                        <div class="collapse" id="collapseFour" aria-labelledby="headingFour" data-parent="#accordionSettings">-->
                                    <!--                                            <div class="content">-->
                                    <!--                                                <div class="app">-->
                                    <!--                                                    <img src="img/integrations/slack.svg" alt="app">-->
                                    <!--                                                    <div class="permissions">-->
                                    <!--                                                        <h5>Skrill</h5>-->
                                    <!--                                                        <p>Read, Write, Comment</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="app">-->
                                    <!--                                                    <img src="img/integrations/dropbox.svg" alt="app">-->
                                    <!--                                                    <div class="permissions">-->
                                    <!--                                                        <h5>Dropbox</h5>-->
                                    <!--                                                        <p>Read, Write, Upload</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="app">-->
                                    <!--                                                    <img src="img/integrations/drive.svg" alt="app">-->
                                    <!--                                                    <div class="permissions">-->
                                    <!--                                                        <h5>Google Drive</h5>-->
                                    <!--                                                        <p>No permissions set</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="app">-->
                                    <!--                                                    <img src="img/integrations/trello.svg" alt="app">-->
                                    <!--                                                    <div class="permissions">-->
                                    <!--                                                        <h5>Trello</h5>-->
                                    <!--                                                        <p>No permissions set</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                    <!--                                    </div>-->
                                    <!-- End of Connections -->
                                    <!-- Start of Appearance Settings -->
                                    <!--                                    <div class="category">-->
                                    <!--                                        <a href="#" class="title collapsed" id="headingFive" data-toggle="collapse" data-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">-->
                                    <!--                                            <i class="material-icons md-30 online">colorize</i>-->
                                    <!--                                            <div class="data">-->
                                    <!--                                                <h5>Appearance</h5>-->
                                    <!--                                                <p>Customize the look of Swipe</p>-->
                                    <!--                                            </div>-->
                                    <!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
                                    <!--                                        </a>-->
                                    <!--                                        <div class="collapse" id="collapseFive" aria-labelledby="headingFive" data-parent="#accordionSettings">-->
                                    <!--                                            <div class="content no-layer">-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Turn Off Lights</h5>-->
                                    <!--                                                        <p>The dark mode is applied to core areas of the app that are normally displayed as light.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round mode"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                    <!--                                    </div>-->
                                    <!-- End of Appearance Settings -->
                                    <!-- Start of Language -->
                                    <div class="category">
                                        <a href="#" class="title collapsed" id="headingSix" data-toggle="collapse" data-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
                                            <i class="material-icons md-30 online">language</i>
                                            <div class="data">
                                                <h5 th:text="#{language}">Language</h5>
                                                <p th:text="#{language.setting}">Select preferred language</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                        <div class="collapse" id="collapseSix" aria-labelledby="headingSix" data-parent="#accordionSettings">
                                            <div class="content layer">
                                                <div class="language">

                                                    <select class="custom-select" id="langSelect" required>
                                                        <option value="en" th:text="#{english}" th:selected="${#locale.language == 'en'}">English</option>
                                                        <option value="vi" th:text="#{vietnamese}" th:selected="${#locale.language == 'vi'}">Vietnamese</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End of Language -->
                                    <!-- Start of Privacy & Safety -->
                                    <!--                                    <div class="category">-->
                                    <!--                                        <a href="#" class="title collapsed" id="headingSeven" data-toggle="collapse" data-target="#collapseSeven" aria-expanded="true" aria-controls="collapseSeven">-->
                                    <!--                                            <i class="material-icons md-30 online">lock_outline</i>-->
                                    <!--                                            <div class="data">-->
                                    <!--                                                <h5>Privacy & Safety</h5>-->
                                    <!--                                                <p>Control your privacy settings</p>-->
                                    <!--                                            </div>-->
                                    <!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
                                    <!--                                        </a>-->
                                    <!--                                        <div class="collapse" id="collapseSeven" aria-labelledby="headingSeven" data-parent="#accordionSettings">-->
                                    <!--                                            <div class="content no-layer">-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Keep Me Safe</h5>-->
                                    <!--                                                        <p>Automatically scan and delete direct messages you receive from everyone that contain explict content.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>My Friends Are Nice</h5>-->
                                    <!--                                                        <p>If enabled scans direct messages from everyone unless they are listed as your friend.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Everyone can add me</h5>-->
                                    <!--                                                        <p>If enabled anyone in or out your friends of friends list can send you a friend request.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Friends of Friends</h5>-->
                                    <!--                                                        <p>Only your friends or your mutual friends will be able to send you a friend reuqest.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox" checked>-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Data to Improve</h5>-->
                                    <!--                                                        <p>This settings allows us to use and process information for analytical purposes.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div class="set">-->
                                    <!--                                                    <div class="details">-->
                                    <!--                                                        <h5>Data to Customize</h5>-->
                                    <!--                                                        <p>This settings allows us to use your information to customize Swipe for you.</p>-->
                                    <!--                                                    </div>-->
                                    <!--                                                    <label class="switch">-->
                                    <!--                                                        <input type="checkbox">-->
                                    <!--                                                        <span class="slider round"></span>-->
                                    <!--                                                    </label>-->
                                    <!--                                                </div>-->
                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                    <!--                                    </div>-->
                                    <!-- End of Privacy & Safety -->
                                    <!-- Start of Logout -->
                                    <div class="category">
                                        <a href="javascript:void(0)" class="title collapsed" id="logout">
                                            <i class="material-icons md-30 online">power_settings_new</i>
                                            <div class="data">
                                                <h5>Power Off</h5>
                                                <p>Log out of your account</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                    </div>
                                    <!-- End of Logout -->
                                </div>
                            </div>
                        </div>
                        <!-- End of Settings -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Sidebar -->
<!--        rename dialog-->
        <div class="modal fade" id="modalDeleteContact" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1>Delete contact?</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="content">
                        <form id="deleteContactForm">
                            <div class="form-group user-tag">
                                <button type="button" id="confirmDeleteContact" class="btn button w-100" style="margin: 10px">Accept</button>
                                <button type="button" class="btn button w-100" data-dismiss="modal" style="margin: 10px">Decline</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalRename" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1>Rename discussion</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="renameForm">
                            <div class="form-group user-tag">
                                <input type="text" class="form-control" id="renameDiscussion" required>
                            </div>
                            <button type="submit" class="btn button w-100">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
<!--        block contact confirm-->
        <div class="modal fade" id="modalBlockContact" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1>Block this contact?</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="content">
                        <form id="blockContactForm">
                            <div class="form-group user-tag">
                                <button type="button" id="confirmBlockContact" class="btn button w-100" style="margin: 10px">Accept</button>
                                <button type="button" class="btn button w-100" data-dismiss="modal" style="margin: 10px">Decline</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!--        clear history dialog confirm-->
        <div class="modal fade" id="modalClearHistory" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1>Clear chat history?</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="content">
                        <form id="clearHistoryForm">
                            <div class="form-group user-tag">
                                <button type="button" id="confirmClearHistory" class="btn button w-100" style="margin: 10px">Accept</button>
                                <button type="button" class="btn button w-100" data-dismiss="modal" style="margin: 10px">Decline</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!--      delete message  confirm dialog-->
        <div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1>Delete message?</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="confirmForm">
                            <div class="form-group user-tag">
                                <button type="button" id="confirmDelete" class="btn button w-100" style="margin: 10px">Accept</button>
                                <button type="button" id="cancelDelete" class="btn button w-100" style="margin: 10px">Decline</button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!--        update message dialog-->
        <div class="modal fade" id="modalUpdateMessage" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1>Edit message</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="updateMessage">
                            <div class="form-group user-tag">
                                <div id="alert-message3" class="alert"></div>
                                <input type="text" class="form-control" id="editMessage" required>
                            </div>
<!--                            <div class="tag-area tag-input-wrapper user-tag" id="userTag">-->
<!--                             -->
<!--                            </div>-->
                            <button type="submit" class="btn button w-100">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Start of Add Friends -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1 th:text="#{add.friend.title}">Add your friends</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="newFriend">
                            <div class="form-group user-tag">
                                <div id="alert-message1" class="alert"></div>
                                <label for="user" th:text="#{add.friend}">Email/Username</label>
                                <input type="text" class="form-control" id="user" required>
                            </div>
                            <div class="tag-area tag-input-wrapper user-tag" id="userTag">
                                <!--                                <label for="welcome" th:text="#{add.friend.message}">Message:</label>-->
                                <!--                                <textarea class="text-control" id="welcome"></textarea>-->
                            </div>
                            <button type="submit" class="btn button w-100" th:text="#{add.friend.send}">Send Friend Request</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Add Friends -->
        <!-- Start of Create Chat -->
        <div class="modal fade" id="startnewchat" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1 th:text="#{converstaion.title}">Start new chat</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="groupchat">
                            <div class="form-group ">

                                <label for="participant" th:text="#{recipient}">Recipients:</label>
                                <div id="alert-message2" class="alert" ></div>
                                <div id="recipient-list" class="tag-area tag-input-wrapper">
                                    <input type="text" class="form-control" id="participant">


                                </div>
                            </div>
                            <div class="form-group">
                                <label for="topic" th:text="#{topic}">Topic:</label>
                                <input type="text" class="form-control" id="topic" required>
                            </div>
                            <!--                            <div class="form-group">-->
                            <!--                                <label for="message" th:text="#{add.friend.message}">Message:</label>-->
                            <!--                                <textarea class="text-control" id="message"></textarea>-->
                            <!--                            </div>-->
                            <button type="submit" class="btn button w-100" th:text="#{start.conversation}">Start New Chat</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Create Chat -->
        <div class="main">
            <div class="tab-content" id="nav-tabContent">
                <!-- Start of Babble -->
                <div class="babble tab-pane fade active show" id="list-chat" role="tabpanel" aria-labelledby="list-chat-list">
                    <!-- Start of Chat -->
                    <div class="chat" id="chat">
                        <div class="top" id="top">
                        </div>
                        <div class="content" id="content">
                            <div class="container">
                                <div class="col-md-12" id="show-message" ></div>
                            </div>
                        </div>
                        <div class="container">
                            <div class="col-md-12">
                                <div class="bottom" id="send-message">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End of Chat -->
                    <!-- Start of Call -->
                    <!--                    <div class="call" id="call1">-->
                    <!--                        <div class="content">-->
                    <!--                            <div class="container">-->
                    <!--                                <div class="col-md-12">-->
                    <!--                                    <div class="inside">-->
                    <!--                                        <div class="panel">-->
                    <!--                                            <div class="participant">-->
                    <!--                                                <img class="avatar-xxl" src="img/avatars/avatar-female-5.jpg" alt="avatar">-->
                    <!--                                                <span>Connecting</span>-->
                    <!--                                            </div>-->
                    <!--                                            <div class="options">-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">mic</i></button>-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">videocam</i></button>-->
                    <!--                                                <button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">person_add</i></button>-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">volume_up</i></button>-->
                    <!--                                            </div>-->
                    <!--                                            <button class="btn back" name="1"><i class="material-icons md-24">chat</i></button>-->
                    <!--                                        </div>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                    </div>-->
                    <!-- End of Call -->
                </div>
                <!-- End of Babble -->
                <!-- Start of Babble -->
                <div class="babble tab-pane fade" id="list-empty" role="tabpanel" aria-labelledby="list-empty-list">
                    <!-- Start of Chat -->
                    <!--                    <div class="chat" id="chat2">-->
                    <!--                        <div class="top">-->
                    <!--                            <div class="container">-->
                    <!--                                <div class="col-md-12">-->
                    <!--                                    <div class="inside">-->
                    <!--                                        <a href="#"><img class="avatar-md" src="img/avatars/avatar-female-2.jpg" data-toggle="tooltip" data-placement="top" title="Lean" alt="avatar"></a>-->
                    <!--                                        <div class="status">-->
                    <!--                                            <i class="material-icons offline">fiber_manual_record</i>-->
                    <!--                                        </div>-->
                    <!--                                        <div class="data">-->
                    <!--                                            <h5><a href="#">Lean Avent</a></h5>-->
                    <!--                                            <span>Inactive</span>-->
                    <!--                                        </div>-->
                    <!--                                        <button class="btn connect d-md-block d-none" name="2"><i class="material-icons md-30">phone_in_talk</i></button>-->
                    <!--                                        <button class="btn connect d-md-block d-none" name="2"><i class="material-icons md-36">videocam</i></button>-->
                    <!--                                        <button class="btn d-md-block d-none"><i class="material-icons md-30">info</i></button>-->
                    <!--                                        <div class="dropdown">-->
                    <!--                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>-->
                    <!--                                            <div class="dropdown-menu dropdown-menu-right">-->
                    <!--                                                <button class="dropdown-item connect" name="2"><i class="material-icons">phone_in_talk</i>Voice Call</button>-->
                    <!--                                                <button class="dropdown-item connect" name="2"><i class="material-icons">videocam</i>Video Call</button>-->
                    <!--                                                <hr>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>-->
                    <!--                                            </div>-->
                    <!--                                        </div>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                        <div class="content empty">-->
                    <!--                            <div class="container">-->
                    <!--                                <div class="col-md-12">-->
                    <!--                                    <div class="no-messages">-->
                    <!--                                        <i class="material-icons md-48">forum</i>-->
                    <!--                                        <p>Seems people are shy to start the chat. Break the ice send the first message.</p>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                        <div class="container">-->
                    <!--                            <div class="col-md-12">-->
                    <!--                                <div class="bottom">-->
                    <!--                                    <form class="position-relative w-100">-->
                    <!--                                        <textarea class="form-control" placeholder="Start typing for reply..." rows="1"></textarea>-->
                    <!--&lt;!&ndash;                                        <button class="btn emoticons"><i class="material-icons">insert_emoticon</i></button>&ndash;&gt;-->
                    <!--                                        <button type="submit" class="btn send"><i class="material-icons">send</i></button>-->
                    <!--                                    </form>-->
                    <!--                                    <label>-->
                    <!--                                        <input type="file">-->
                    <!--                                        <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>-->
                    <!--                                    </label>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                    </div>-->
                    <!-- End of Chat -->
                    <!-- Start of Call -->
                    <!--                    <div class="call" id="call2">-->
                    <!--                        <div class="content">-->
                    <!--                            <div class="container">-->
                    <!--                                <div class="col-md-12">-->
                    <!--                                    <div class="inside">-->
                    <!--                                        <div class="panel">-->
                    <!--                                            <div class="participant">-->
                    <!--                                                <img class="avatar-xxl" src="img/avatars/avatar-female-2.jpg" alt="avatar">-->
                    <!--                                                <span>Connecting</span>-->
                    <!--                                            </div>-->
                    <!--                                            <div class="options">-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">mic</i></button>-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">videocam</i></button>-->
                    <!--                                                <button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">person_add</i></button>-->
                    <!--                                                <button class="btn option"><i class="material-icons md-30">volume_up</i></button>-->
                    <!--                                            </div>-->
                    <!--                                            <button class="btn back" name="2"><i class="material-icons md-24">chat</i></button>-->
                    <!--                                        </div>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                    </div>-->
                    <!-- End of Call -->
                </div>
                <!-- End of Babble -->
                <!-- Start of Babble -->
                <div class="babble tab-pane fade" id="list-request" role="tabpanel" aria-labelledby="list-request-list">
                    <!-- Start of Chat -->
                    <!--                    <div class="chat" id="chat3">-->
                    <!--                        <div class="top">-->
                    <!--                            <div class="container">-->
                    <!--                                <div class="col-md-12">-->
                    <!--                                    <div class="inside">-->
                    <!--                                        <a href="#"><img class="avatar-md" src="img/avatars/avatar-female-6.jpg" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>-->
                    <!--                                        <div class="status">-->
                    <!--                                            <i class="material-icons offline">fiber_manual_record</i>-->
                    <!--                                        </div>-->
                    <!--                                        <div class="data">-->
                    <!--                                            <h5><a href="#">Louis Martinez</a></h5>-->
                    <!--                                            <span>Inactive</span>-->
                    <!--                                        </div>-->
                    <!--                                        <button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-30">phone_in_talk</i></button>-->
                    <!--                                        <button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-36">videocam</i></button>-->
                    <!--                                        <button class="btn d-md-block disabled d-none" disabled><i class="material-icons md-30">info</i></button>-->
                    <!--                                        <div class="dropdown">-->
                    <!--                                            <button class="btn disabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled><i class="material-icons md-30">more_vert</i></button>-->
                    <!--                                            <div class="dropdown-menu dropdown-menu-right">-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">phone_in_talk</i>Voice Call</button>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">videocam</i>Video Call</button>-->
                    <!--                                                <hr>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>-->
                    <!--                                                <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>-->
                    <!--                                            </div>-->
                    <!--                                        </div>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                        <div class="content empty">-->
                    <!--                            <div class="container">-->
                    <!--                                <div class="col-md-12">-->
                    <!--                                    <div class="no-messages request">-->
                    <!--                                        <a href="#"><img class="avatar-xl" src="img/avatars/avatar-female-6.jpg" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>-->
                    <!--                                        <h5>Louis Martinez would like to add you as a contact. <span>Hi Keith, I'd like to add you as a contact.</span></h5>-->
                    <!--                                        <div class="options">-->
                    <!--                                            <button class="btn button"><i class="material-icons">check</i></button>-->
                    <!--                                            <button class="btn button"><i class="material-icons">close</i></button>-->
                    <!--                                        </div>-->
                    <!--                                    </div>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                        <div class="container">-->
                    <!--                            <div class="col-md-12">-->
                    <!--                                <div class="bottom">-->
                    <!--                                    <form class="position-relative w-100">-->
                    <!--                                        <textarea class="form-control" placeholder="Messaging unavailable" rows="1" disabled></textarea>-->
                    <!--                                        <button class="btn emoticons disabled" disabled><i class="material-icons">insert_emoticon</i></button>-->
                    <!--                                        <button class="btn send disabled" disabled><i class="material-icons">send</i></button>-->
                    <!--                                    </form>-->
                    <!--                                    <label>-->
                    <!--                                        <input type="file" disabled>-->
                    <!--                                        <span class="btn attach disabled d-sm-block d-none"><i class="material-icons">attach_file</i></span>-->
                    <!--                                    </label>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </div>-->
                    <!--                    </div>-->
                    <!-- End of Chat -->
                </div>
                <!-- End of Babble -->
            </div>
        </div>
    </div> <!-- Layout -->
</main>
<!-- Bootstrap/Swipe core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="/js/jquery-3.3.1.slim.min.js" ></script>
<!--<script>window.jQuery || document.write('<script src="js/vendor/jquery-slim.min.js"><\/script>')</script>-->
<script src="/js/vendor/popper.min.js"></script>
<script src="/js/swipe.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script>
    // const alertMessage = document.getElementsByClassName('alert-message');
    function showAlert(message, alertDiv, type = 'warning') {
        const alertMessage = document.getElementById(alertDiv);
        alertMessage.textContent = message;

        // Remove any existing type classes
        alertMessage.classList.remove('warning', 'success');

        // Add the appropriate type class
        alertMessage.classList.add(type);

        // Show the alert
        alertMessage.classList.add('show');
        alertMessage.classList.remove('fade-out');

        // Automatically hide the alert after 3 seconds
        setTimeout(() => {
            alertMessage.classList.add('fade-out');
            setTimeout(() => {
                alertMessage.classList.remove('show', type);
                alertMessage.textContent = '';
            }, 500); // Match the CSS transition duration
        }, 3000);
    }

    function scrollToBottom(el) {
        if (!el) {
            // Nếu không có phần tử được truyền vào, thử lấy phần tử content
            el = document.getElementById('content');
            console.log("Không có phần tử để cuộn, thử lấy phần tử 'content'");

            // Nếu vẫn không tìm thấy
            if (!el) {
                console.error("Không thể cuộn: không tìm thấy phần tử");
                return;
            }
        }

        try {
            // Đảm bảo cuộn đến cuối
            const scrollHeight = el.scrollHeight;
            el.scrollTop = scrollHeight;
            console.log("Đã cuộn xuống tin nhắn mới nhất, scrollHeight:", scrollHeight);
        } catch (error) {
            console.error("Lỗi khi cuộn xuống:", error);
        }
    }
    // Biến toàn cục cho WebSocket
    let stompClient = null;
    let currentUsername = null;
    let currentUserId = null;
    let currentConversationId = null;
    let currentRecipientUsername = null;
    let currentRecipientId = null;
    let isConnected = false;
    let isGroupConversation = false; // Cờ để xác định cuộc trò chuyện hiện tại là nhóm hay không
    let editSubscription = null;
    let deleteSubscription = null;
    let pendingDeleteMessageId = null;
    let messageSubscriptions = {
        edit: null,
        delete: null
    };

    const baseURL = "http://localhost:8080/api";

    // Kết nối WebSocket khi người dùng đã đăng nhập
    function connectWebSocket() {
        if (isConnected && stompClient && stompClient.connected) {
            console.log("WebSocket đã được kết nối trước đó");
            return;
        }

        const token = sessionStorage.getItem("token");
        if (!token) {
            console.error("Không tìm thấy token, không thể kết nối WebSocket");
            return;
        }

        console.log("Đang kết nối tới WebSocket server...");
        // Kết nối WebSocket thuần theo cấu hình trong WebSocketConfig
        const socket = new WebSocket('ws://localhost:8080/ws');

        // Thêm sự kiện theo dõi trạng thái kết nối WebSocket
        socket.onopen = function() {
            console.log("WebSocket Socket đã mở");
        };
        socket.onerror = function(error) {
            console.error("Lỗi WebSocket Socket:", error);
        };
        socket.onclose = function(event) {
            console.log("WebSocket Socket đã đóng:", event);
            // Thử kết nối lại sau 5 giây nếu đóng không phải do chủ ý
            if (!event.wasClean) {
                setTimeout(reconnectWebSocket, 5000);
            }
        };

        stompClient = Stomp.over(socket);

        // Bật log debug của STOMP để xem chi tiết gói tin
        stompClient.debug = function(str) {
            // Chỉ log các tin nhắn quan trọng để tránh quá nhiều log
            if (str.includes("CONNECTED") || str.includes("SUBSCRIBE") || str.includes("ERROR") || str.includes("DISCONNECT")) {
                console.log("STOMP: " + str);
            }
        };

        // Thêm header Authorization để server xác thực JWT token
        const headers = {
            'Authorization': 'Bearer ' + token
        };

        console.log("Đang kết nối STOMP với headers:", headers);
        stompClient.connect(headers, onConnected, onError);
    }

    // Xử lý khi kết nối thành công
    function onConnected() {
        console.log("Kết nối WebSocket thành công!");
        isConnected = true;

        subscribeToContextMenuUpdates()

        // Đăng ký nhận tin nhắn công khai (/topic/public)
        messageSubscriptions.public = stompClient.subscribe('/topic/public', onPublicMessageReceived);

        // Lưu thông tin các subscription để tiện quản lý
        messageSubscriptions = {
            public: true
        };

        // Lấy thông tin người dùng hiện tại
        currentUsername = sessionStorage.getItem('username');
        if (!currentUsername) {
            console.error("Username không tồn tại trong sessionStorage");
            return;
        }

        // Tìm userId từ username
        // fetchUserIdByUsername(currentUsername)
        //     .then(userId => {
        //         if (!userId) {
        //             console.error("Không tìm thấy userId cho username:", currentUsername);
        //             return;
        //         }
        //         currentUserId = userId;
        //         console.log(`Đã lấy userId=${userId} cho username=${currentUsername}`);
        //
        //         // Tải danh sách cuộc trò chuyện cho người dùng
        //         return fetchConversations(userId);
        //     })
        //     .catch(error => {
        //         console.error("Lỗi khi lấy dữ liệu người dùng:", error);
        //     });
    }
    function subscribeToContextMenuUpdates(options) {
        console.log("Bắt đầu đăng ký kênh cập nhật menu ngữ cảnh");

        if (stompClient) {
            // Lấy userId từ biến toàn cục hoặc từ sessionStorage
            let userId = currentUserId || sessionStorage.getItem('userId');

            // Nếu vẫn không có userId, đăng ký lại sau 1 giây
            if (!userId) {
                console.log("UserId chưa có sẵn, sẽ đăng ký lại sau 1 giây");
                setTimeout(subscribeToContextMenuUpdates, 1000);
                return;
            }

            console.log("Đăng ký kênh cập nhật menu ngữ cảnh với userId: " + userId);

            // Đăng ký nhận thông báo khi có thay đổi về cuộc trò chuyện
            stompClient.subscribe(`/user/${userId}/queue/conversation-changes`, onConversationChange);

            // Đăng ký nhận thông báo khi có thay đổi về liên hệ
            stompClient.subscribe(`/user/${userId}/queue/contact-changes`, onContactChange);

            // Đăng ký nhận thông báo khi có tin nhắn bị chỉnh sửa
            stompClient.subscribe(`/user/${userId}/queue/message-edited`, function(payload) {
                try {
                    const message = JSON.parse(payload.body);
                    console.log("Nhận thông báo chỉnh sửa tin nhắn:", message);
                    handleMessageEdit(message);
                } catch (error) {
                    console.error("Lỗi xử lý thông báo chỉnh sửa tin nhắn:", error);
                }
            });

            // Đăng ký nhận thông báo khi có tin nhắn bị xóa
            stompClient.subscribe(`/user/${userId}/queue/message-deleted`, function(payload) {
                try {
                    const message = JSON.parse(payload.body);
                    console.log("Nhận thông báo xóa tin nhắn:", message);
                    handleMessageDelete(message);
                } catch (error) {
                    console.error("Lỗi xử lý thông báo xóa tin nhắn:", error);
                }
            });

            // Đăng ký nhận thông báo khi lịch sử cuộc trò chuyện bị xóa
            stompClient.subscribe(`/user/${userId}/queue/conversation-cleared`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo xóa lịch sử cuộc trò chuyện:", data);
                    handleConversationHistoryCleared(data.conversationId);
                } catch (error) {
                    console.error("Lỗi xử lý thông báo xóa lịch sử cuộc trò chuyện:", error);
                }
            });

            console.log("Đã đăng ký WebSocket với userId: " + userId);
            console.log("Đường dẫn đăng ký message-edited: /user/" + userId + "/queue/message-edited");
            console.log("Đường dẫn đăng ký message-deleted: /user/" + userId + "/queue/message-deleted");
        } else {
            console.error("Không thể đăng ký kênh vì stompClient chưa được khởi tạo");
        }
    }

    // Xử lý lỗi kết nối
    function onError(error) {
        console.error("Lỗi kết nối WebSocket:", error);
        isConnected = false;

        // Hiển thị thông báo lỗi cho người dùng
        const errorElement = document.getElementById('message-error');
        if (errorElement) {
            errorElement.textContent = "Không thể kết nối đến máy chủ. Đang thử kết nối lại...";
            errorElement.style.display = 'block';
        }

        // Thử kết nối lại sau 5 giây
        setTimeout(reconnectWebSocket, 5000);
    }

    function onConversationChange(payload) {
        try {
            const data = JSON.parse(payload.body);

            const currentUserId = sessionStorage.getItem('userId');
            // Không xử lý nếu chính mình là người thực hiện thay đổi
            if (data.initiatorId === currentUserId) {
                return;
            }

            switch (data.type) {
                case "DELETE":
                    handleConversationDeleted(data.conversationId);
                    break;
                case "CLEAR_HISTORY":
                    handleConversationHistoryCleared(data.conversationId);
                    break;
                case "UPDATE":
                    handleConversationUpdated(data.conversationId, data.updatedData);
                    break;
                case "RENAME":
                    handleConversationRenamed(data.conversationId, data.newName);
                    break;
            }
        } catch (error) {
            console.error("Lỗi khi xử lý thay đổi cuộc trò chuyện:", error);
        }
    }

    // Xử lý khi cuộc trò chuyện bị xóa
    function handleConversationDeleted(conversationId) {
        // Xóa cuộc trò chuyện khỏi UI
        const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (conversationElement) {
            conversationElement.remove();
        }

        // Nếu đang xem cuộc trò chuyện này, xóa nội dung và hiển thị thông báo
        if (currentConversationId === conversationId) {
            const messageContainer = document.getElementById('show-message');
            if (messageContainer) {
                messageContainer.innerHTML = '';
            }

            const topElement = document.getElementById("top");
            if (topElement) {
                topElement.innerHTML = '';
            }

            const sendMessageElement = document.getElementById("send-message");
            if (sendMessageElement) {
                sendMessageElement.innerHTML = '';
            }

            // Reset biến toàn cục
            currentConversationId = null;
            currentRecipientId = null;
            currentRecipientUsername = null;

            showToast("Cuộc trò chuyện đã bị xóa bởi người dùng khác");
        }
    }

    // Xử lý khi lịch sử cuộc trò chuyện bị xóa
    function handleConversationHistoryCleared(conversationId) {
        // Nếu đang xem cuộc trò chuyện này, xóa nội dung tin nhắn
        if (currentConversationId === conversationId) {
            const messageContainer = document.getElementById('show-message');
            if (messageContainer) {
                messageContainer.innerHTML = '';

                // Cập nhật UI nếu cần
                const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (conversationElement) {
                    const lastMessageElement = conversationElement.querySelector('.data p');
                    if (lastMessageElement) {
                        lastMessageElement.textContent = "Không có tin nhắn";
                    }
                }

                // Hiển thị thông báo rõ ràng
                showToast("Lịch sử cuộc trò chuyện đã được xóa");
            }
        }
    }

    // Xử lý khi cuộc trò chuyện được cập nhật
    function handleConversationUpdated(conversationId, updatedData) {
        // Cập nhật thông tin cuộc trò chuyện trong UI
        const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (conversationElement) {
            // Cập nhật ảnh nhóm nếu có
            if (updatedData.groupAvatar) {
                const avatarElement = conversationElement.querySelector('img.avatar-md');
                if (avatarElement) {
                    avatarElement.src = updatedData.groupAvatar;
                }
            }

            // Cập nhật tên nhóm nếu có
            if (updatedData.name) {
                const nameElement = conversationElement.querySelector('.data h5');
                if (nameElement) {
                    nameElement.textContent = updatedData.name;
                }
            }

            // Cập nhật mô tả nếu có
            if (updatedData.description) {
                const descElement = conversationElement.querySelector('.data p');
                if (descElement) {
                    descElement.textContent = updatedData.description;
                }
            }

            // Hiển thị thông báo nếu đang xem cuộc trò chuyện này
            if (currentConversationId === conversationId) {
                // Cập nhật thông tin trong header cuộc trò chuyện
                if (updatedData.name) {
                    const topNameElement = document.querySelector('#top .data h5 a');
                    if (topNameElement) {
                        topNameElement.textContent = updatedData.name;
                    }
                }

                if (updatedData.groupAvatar) {
                    const topAvatarElement = document.querySelector('#top img.avatar-md');
                    if (topAvatarElement) {
                        topAvatarElement.src = updatedData.groupAvatar;
                    }
                }

                showToast("Thông tin cuộc trò chuyện đã được cập nhật");
            }
        }
    }

    // Xử lý khi cuộc trò chuyện được đổi tên
    function handleConversationRenamed(conversationId, newName) {
        // Cập nhật tên cuộc trò chuyện trong UI
        const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (conversationElement) {
            const nameElement = conversationElement.querySelector('.data h5');
            if (nameElement) {
                nameElement.textContent = newName;
            }

            // Hiển thị thông báo nếu đang xem cuộc trò chuyện này
            if (currentConversationId === conversationId) {
                const topNameElement = document.querySelector('#top .data h5 a');
                if (topNameElement) {
                    topNameElement.textContent = newName;
                }
                currentRecipientUsername = newName;
                showToast("Cuộc trò chuyện đã được đổi tên thành: " + newName);
            }
        }
    }

    // Xử lý các thay đổi về liên hệ
    function onContactChange(payload) {
        try {
            const data = JSON.parse(payload.body);
            const currentUserId = sessionStorage.getItem('userId');
            // Không xử lý nếu chính mình là người thực hiện thay đổi
            if (data.type === "CONFIRMATION") {
                handleContactActionConfirmation(data);
                return;
            }
            if (data.initiatorId === currentUserId) {
                return;
            }

            switch (data.type) {
                case "BLOCKED":
                    handleContactBlocked(data.userId);
                    break;
                case "UNBLOCKED":
                    handleContactUnblocked(data.userId);
                    break;
                case "DELETE":
                    handleContactDeleted(data.contactId, data.userId);
                    break;
                case "UPDATE":
                    handleContactUpdated(data.userId, data.updatedData);
                    break;
            }
        } catch (error) {
            console.error("Lỗi khi xử lý thay đổi liên hệ:", error);
        }
    }

    function handleContactActionConfirmation(data) {
        console.log("Xác nhận hành động liên hệ:", data);
        showToast(data.message || "Hành động đã được xác nhận");
    }

    // Xử lý khi bị chặn
    function handleContactBlocked(userId) {
        // Tìm cuộc trò chuyện với người dùng này
        const conversationElement = document.querySelector(`.filterDiscussions[data-recipient-id="${userId}"]`);
        if (conversationElement) {
            // Thêm chỉ báo đã bị chặn
            conversationElement.classList.add('blocked');

            // Nếu đang xem cuộc trò chuyện với người này
            if (currentRecipientId === userId) {
                // Vô hiệu hóa form gửi tin nhắn
                const messageForm = document.querySelector('.message-form');
                if (messageForm) {
                    const textarea = messageForm.querySelector('textarea');
                    const sendButton = messageForm.querySelector('button[type="submit"]');

                    if (textarea) textarea.disabled = true;
                    if (sendButton) sendButton.disabled = true;

                    showToast("Bạn đã bị chặn bởi người dùng này");
                }
            }
        }
    }

    // Xử lý khi được bỏ chặn
    function handleContactUnblocked(userId) {
        // Tìm cuộc trò chuyện với người dùng này
        const conversationElement = document.querySelector(`.filterDiscussions[data-recipient-id="${userId}"]`);
        if (conversationElement) {
            // Xóa chỉ báo đã bị chặn
            conversationElement.classList.remove('blocked');

            // Nếu đang xem cuộc trò chuyện với người này
            if (currentRecipientId === userId) {
                // Kích hoạt lại form gửi tin nhắn
                const messageForm = document.querySelector('.message-form');
                if (messageForm) {
                    const textarea = messageForm.querySelector('textarea');
                    const sendButton = messageForm.querySelector('button[type="submit"]');

                    if (textarea) textarea.disabled = false;
                    if (sendButton) sendButton.disabled = false;

                    showToast("Bạn đã được bỏ chặn bởi người dùng này");
                }
            }
        }
    }

    // Xử lý khi bị xóa khỏi danh sách liên hệ
    function handleContactDeleted(contactId, userId) {
        // Xóa liên hệ khỏi danh sách
        const contactElement = document.querySelector(`.contact[data-user-id="${userId}"]`);
        if (contactElement) {
            contactElement.remove();
        }

        showToast("Bạn đã bị xóa khỏi danh sách liên hệ của người dùng khác");
    }

    // Xử lý khi thông tin liên hệ được cập nhật
    function handleContactUpdated(userId, updatedData) {
        // Cập nhật thông tin liên hệ trong UI
        const contactElement = document.querySelector(`.contact[data-user-id="${userId}"]`);
        if (contactElement) {
            if (updatedData.username || updatedData.displayName) {
                const nameElement = contactElement.querySelector('h5');
                if (nameElement) {
                    nameElement.textContent = updatedData.displayName || updatedData.username;
                }
            }

            if (updatedData.profilePicture) {
                const avatarElement = contactElement.querySelector('img.avatar-md');
                if (avatarElement) {
                    avatarElement.src = updatedData.profilePicture;
                }
            }
        }

        // Cập nhật trong cuộc trò chuyện nếu có
        const conversationElement = document.querySelector(`.filterDiscussions[data-recipient-id="${userId}"]`);
        if (conversationElement) {
            if (updatedData.username || updatedData.displayName) {
                const nameElement = conversationElement.querySelector('.data h5');
                if (nameElement) {
                    nameElement.textContent = updatedData.displayName || updatedData.username;
                }
            }

            if (updatedData.profilePicture) {
                const avatarElement = conversationElement.querySelector('img.avatar-md');
                if (avatarElement) {
                    avatarElement.src = updatedData.profilePicture;
                }
            }

            // Cập nhật header cuộc trò chuyện nếu đang xem
            if (currentRecipientId === userId) {
                if (updatedData.username || updatedData.displayName) {
                    const topNameElement = document.querySelector('#top .data h5 a');
                    if (topNameElement) {
                        topNameElement.textContent = updatedData.displayName || updatedData.username;
                        currentRecipientUsername = updatedData.displayName || updatedData.username;
                    }
                }
            }
        }
    }

    // Thiết lập heartbeat để giữ kết nối WebSocket luôn mở
    function startHeartbeat() {
        // Gửi heartbeat mỗi 25 giây (thấp hơn timeout 30s thông thường của nhiều server)
        const heartbeatInterval = setInterval(() => {
            if (stompClient && stompClient.connected) {
                stompClient.send('/app/chat.heartbeat', {}, JSON.stringify({
                    sender: currentUsername,
                    type: MessageType.HEARTBEAT
                }));
                console.log("Đã gửi heartbeat");
            } else {
                clearInterval(heartbeatInterval);
                reconnectWebSocket();
            }
        }, 25000);

        // Lưu interval vào window để có thể xóa khi cần
        window.heartbeatInterval = heartbeatInterval;
    }

    // Hàm kết nối lại WebSocket
    function reconnectWebSocket() {
        if (stompClient) {
            try {
                stompClient.disconnect();
            } catch (e) {
                console.error("Lỗi khi ngắt kết nối WebSocket:", e);
            }
        }
        isConnected = false;
        stompClient = null;

        // Xóa tất cả subscriptions đã lưu
        messageSubscriptions = {};

        // Kết nối lại sau 2 giây
        setTimeout(connectWebSocket, 2000);
    }

    // Đăng ký nhận tin nhắn cho một nhóm cụ thể
    function subscribeToGroupMessages(groupId) {
        if (!isConnected || !stompClient) {
            console.error("Không thể đăng ký nhóm: WebSocket chưa kết nối");
            return;
        }

        // Kiểm tra nếu đã đăng ký trước đó thì không đăng ký lại
        if (messageSubscriptions[`group_${groupId}`]) {
            console.log(`Đã đăng ký nhận tin nhắn cho nhóm: ${groupId} trước đó`);
            return messageSubscriptions[`group_${groupId}`];
        }

        // Quan trọng: Đảm bảo định dạng topic khớp với định dạng server đang sử dụng
        const groupTopic = `/topic/group.${groupId}`;
        console.log(`Đăng ký nhóm với ID: ${groupId}, path=${groupTopic}`);

        try {
            const subscription = stompClient.subscribe(groupTopic, function(payload) {
                console.log(`NHẬN TIN NHẮN NHÓM từ ${groupTopic}:`, payload);
                onGroupMessageReceived(payload);
            });
            console.log(` ĐÃ ĐĂNG KÝ THÀNH CÔNG nhận tin nhắn cho nhóm: ${groupId}`);

            // Lưu subscription để có thể hủy đăng ký khi cần
            messageSubscriptions[`group_${groupId}`] = subscription;

            // Gửi tin nhắn test để kiểm tra kết nối (chỉ log, không gửi thực)
            console.log(`Muốn gửi tin nhắn đến nhóm, sử dụng destination: /app/chat.group`);

            // In ra danh sách đăng ký hiện tại
            console.log(`Danh sách đăng ký hiện tại:`, Object.keys(messageSubscriptions));

            return subscription;
        } catch (error) {
            console.error(` LỖI khi đăng ký nhóm ${groupId}:`, error);
        }
    }

    // Đăng ký nhận tin nhắn riêng tư cho một người dùng cụ thể
    function subscribeToPrivateMessages(conversationId) {
        if (!isConnected || !stompClient) {
            console.error("Không thể đăng ký tin nhắn riêng tư: WebSocket chưa kết nối");
            return;
        }

        try {
            console.log(`ĐĂNG KÝ PRIVATE: Bắt đầu đăng ký tin nhắn riêng tư cho cuộc trò chuyện ID=${conversationId}`);

            // Xóa subscription cũ nếu có
            if (messageSubscriptions[`private_${conversationId}`]) {
                console.log(`Hủy đăng ký kênh tin nhắn riêng tư cũ: ${messageSubscriptions[`private_${conversationId}`].destination}`);
                messageSubscriptions[`private_${conversationId}`].unsubscribe();
                delete messageSubscriptions[`private_${conversationId}`];
            }

            // Hủy các subscription cũ (edit, delete)
            if (messageSubscriptions.edit) {
                messageSubscriptions.edit.unsubscribe();
                messageSubscriptions.edit = null;
            }

            if (messageSubscriptions.delete) {
                messageSubscriptions.delete.unsubscribe();
                messageSubscriptions.delete = null;
            }

            // Format topic dựa trên conversationId
            const privateTopic = `/topic/private.${conversationId}`;

            console.log(`[TEST] ĐĂNG KÝ TIN NHẮN RIÊNG TƯ - TOPIC: ${privateTopic}`);

            // Đăng ký kênh chỉnh sửa tin nhắn
            console.log(`Đăng ký nhận thông báo chỉnh sửa tin nhắn cho conversation ID: ${conversationId}`);
            messageSubscriptions.edit = stompClient.subscribe(`/topic/conversations/${conversationId}/edit`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo chỉnh sửa tin nhắn:", data);
                    handleMessageEdit(data);
                } catch (error) {
                    console.error("Lỗi xử lý sự kiện chỉnh sửa tin nhắn:", error);
                }
            });

            // Đăng ký kênh xóa tin nhắn
            console.log(`Đăng ký nhận thông báo xóa tin nhắn cho conversation ID: ${conversationId}`);
            messageSubscriptions.delete = stompClient.subscribe(`/topic/conversations/${conversationId}/delete`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo xóa tin nhắn:", data);
                    handleMessageDelete(data);
                } catch (error) {
                    console.error("Lỗi xử lý sự kiện xóa tin nhắn:", error);
                }
            });

            // Đăng ký kênh xóa lịch sử cuộc trò chuyện
            console.log(`Đăng ký nhận thông báo xóa lịch sử cho conversation ID: ${conversationId}`);
            messageSubscriptions.clear = stompClient.subscribe(`/topic/conversations/${conversationId}/clear`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo xóa lịch sử cuộc trò chuyện:", data);
                    handleConversationHistoryCleared(conversationId);
                } catch (error) {
                    console.error("Lỗi xử lý sự kiện xóa lịch sử:", error);
                }
            });

            // Đăng ký kênh đổi tên cuộc trò chuyện
            console.log(`Đăng ký nhận thông báo đổi tên cho conversation ID: ${conversationId}`);
            messageSubscriptions.rename = stompClient.subscribe(`/topic/conversations/${conversationId}/rename`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo đổi tên cuộc trò chuyện:", data);
                    handleConversationRenamed(conversationId, data.newName);
                } catch (error) {
                    console.error("Lỗi xử lý sự kiện đổi tên:", error);
                }
            });

            // Đăng ký kênh chặn liên hệ
            console.log(`Đăng ký nhận thông báo chặn liên hệ`);
            messageSubscriptions.block = stompClient.subscribe(`/topic/user/${currentUserId}/block`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo chặn liên hệ:", data);
                    if (data.type === 'BLOCK') {
                        handleContactBlocked(data.targetUserId);
                    } else if (data.type === 'UNBLOCK') {
                        handleContactUnblocked(data.targetUserId);
                    }
                } catch (error) {
                    console.error("Lỗi xử lý sự kiện chặn liên hệ:", error);
                }
            });

            // Đăng ký kênh xóa liên hệ
            console.log(`Đăng ký nhận thông báo xóa liên hệ`);
            messageSubscriptions.deleteContact = stompClient.subscribe(`/topic/user/${currentUserId}/contacts`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo xóa liên hệ:", data);
                    if (data.type === 'DELETE_CONTACT') {
                        handleContactDeleted(data.contactId, data.userId);
                    }
                } catch (error) {
                    console.error("Lỗi xử lý sự kiện xóa liên hệ:", error);
                }
            });

            // Đăng ký kênh mới
            const subscription = stompClient.subscribe(privateTopic, function(payload) {
                console.log(`NHẬN TIN NHẮN từ ${privateTopic}:`, payload);
                onPrivateMessageReceived(payload);
            });

            const contactSubscription = stompClient.subscribe(`/user/${currentUserId}/queue/messages`, function(payload) {
                const data = JSON.parse(payload.body);
                console.log("Nhan thong bao chung:", data);

                if (data.type === 'DELETE') {
                    if (data.messageId){
                        handleMessageDelete(data);
                    }else if (data.contactId){
                        handleContactChange(data);
                    }
                }
                else if (data.type === "UPDATE" && data.messageId) {
                    handleMessageEdit(data);
                }
            });

            messageSubscriptions.conversationChanges = stompClient.subscribe(`/user/${currentUserId}/queue/conversation-changes`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo thay đổi cuộc trò chuyện:", data);

                    if (data.type === "RENAME" && data.conversationId) {
                        // Xử lý sự kiện đổi tên cuộc trò chuyện
                        updateConversationName(data.conversationId, data.newName);
                    }
                    else if (data.type === "CLEAR_HISTORY" && data.conversationId) {
                        // Xử lý sự kiện xóa lịch sử nếu đang ở cuộc trò chuyện này
                        if (currentConversationId === parseInt(data.conversationId)) {
                            document.getElementById('show-message').innerHTML = '';
                            showToast("Lịch sử cuộc trò chuyện đã bị xóa bởi người khác");
                        }
                    }
                } catch (error) {
                    console.error("Lỗi xử lý thông báo thay đổi cuộc trò chuyện:", error);
                }
            });
            // Đăng ký cho sự kiện thay đổi liên hệ (chặn, xóa...)
            messageSubscriptions.contactChanges = stompClient.subscribe(`/user/${currentUserId}/queue/contact-changes`, function(payload) {
                try {
                    const data = JSON.parse(payload.body);
                    console.log("Nhận thông báo thay đổi liên hệ:", data);

                    if (data.type === "BLOCKED") {
                        // Xử lý sự kiện bị chặn
                        showToast("Bạn đã bị chặn bởi người dùng này");
                        // Tải lại danh sách cuộc trò chuyện
                        fetchConversations(currentUserId);
                    }
                    else if (data.type === "DELETE") {
                        // Xử lý sự kiện bị xóa liên hệ
                        showToast("Liên hệ đã bị xóa bởi người dùng khác");
                        // Tải lại danh sách cuộc trò chuyện và liên hệ
                        fetchConversations(currentUserId);
                        fetchUserData(currentUserId);
                    }
                } catch (error) {
                    console.error("Lỗi xử lý thông báo thay đổi liên hệ:", error);
                }
            });

            // Lưu subscription
            messageSubscriptions[`private_${conversationId}`] = subscription;
            messageSubscriptions[`contact_${currentUserId}`] = contactSubscription;

            // Log ra toàn bộ subscriptions hiện tại để debug
            console.log("Danh sách subscriptions hiện tại:");
            console.table(Object.keys(messageSubscriptions).map(key => ({
                key: key,
                destination: messageSubscriptions[key]?.destination || 'N/A',
                id: messageSubscriptions[key]?.id || 'N/A'
            })));

            console.log(`ĐĂNG KÝ PRIVATE: Đã đăng ký nhận tin nhắn riêng tư cho cuộc trò chuyện ID=${conversationId} thành công!`);
        } catch (error) {
            console.error(`Lỗi khi đăng ký nhận tin nhắn riêng tư cho cuộc trò chuyện ${conversationId}:`, error);
        }
    }

    // Xử lý khi nhận tin nhắn công khai
    function onPublicMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn công khai:", message);

        // Hiển thị tin nhắn nếu đang xem kênh công khai
        if (currentConversationId === 'public') {
            displayMessage(message);
        }
    }

    // Xử lý khi nhận tin nhắn riêng tư
    function onPrivateMessageReceived(payload) {
        try {
            const message = JSON.parse(payload.body);
            console.log("Tin nhắn riêng tư nhận được:", message);

            if (message.type === 'UPDATE') {
                // Xử lý tin nhắn đã được chỉnh sửa
                handleMessageEdit(message);
            } else if (message.type === 'DELETE') {
                // Xử lý tin nhắn đã bị xóa
                handleMessageDelete(message);
            } else {

                // Thiết lập dữ liệu cần thiết để xử lý tin nhắn
                const messageContent = message.content || message.messageText;
                const messageSenderId = message.senderId?.toString();
                const messageRecipientId = message.recipientId?.toString();
                const messageConversationId = message.conversationId?.toString();

                // Kiểm tra xem tin nhắn có phải từ người gửi hiện tại không
                const isFromCurrentSender = message.sender === currentUsername || messageSenderId === currentUserId?.toString();

                // Kiểm tra xem tin nhắn có phải cho cuộc trò chuyện hiện tại không
                let isForCurrentConversation = false;

                if (messageConversationId && currentConversationId) {
                    // Kiểm tra trực tiếp bằng conversationId - đây là cách chính xác nhất
                    isForCurrentConversation = messageConversationId === currentConversationId.toString();
                    console.log("Kiểm tra theo conversationId:", messageConversationId, currentConversationId, isForCurrentConversation);
                }

                // Thêm log để debug
                console.log("Chi tiết tin nhắn riêng tư:", {
                    messageConvId: messageConversationId,
                    currentConvId: currentConversationId,
                    messageSenderId: messageSenderId,
                    messageRecipientId: messageRecipientId,
                    currentUserId: currentUserId?.toString(),
                    isForCurrentConversation: isForCurrentConversation,
                    topic: message._source || "Không xác định"
                });

                // Cập nhật UI danh sách cuộc trò chuyện
                if (!isFromCurrentSender) {
                    updateConversationList(message.sender);

                    // Hiển thị thông báo nếu tin nhắn không phải đang trong cuộc trò chuyện hiện tại
                    if (!isForCurrentConversation && Notification.permission === 'granted') {
                        new Notification('Tin nhắn mới', {
                            body: `${message.sender}: ${message.content}`
                        });
                    }
                }

                // Nếu là tin nhắn trong cuộc trò chuyện hiện tại, hiển thị ngay
                if (isForCurrentConversation) {
                    console.log("Hiển thị tin nhắn cho cuộc trò chuyện hiện tại");

                    // Đánh dấu tin nhắn đã đọc nếu cần
                    if (message.messageId && !isFromCurrentSender) {
                        markMessageAsRead(message.messageId);
                    }

                    // Kiểm tra xem tin nhắn đã tồn tại trong DOM chưa để tránh hiển thị trùng lặp
                    // Nếu tin nhắn có messageId, kiểm tra theo ID đó
                    if (message.messageId) {
                        const existingMessage = document.querySelector(`[data-message-id="${message.messageId}"]`);
                        if (existingMessage) {
                            console.log("Tin nhắn có ID đã tồn tại, không hiển thị lại:", message.messageId);
                            return;
                        }
                    }

                    // Đối với tin nhắn optimistic (không có messageId từ server)
                    // Kiểm tra theo nội dung và người gửi
                    const messageContent = message.content || message.messageText || "";
                    if (messageContent && message.senderId) {
                        const existingMessages = document.querySelectorAll('.message');
                        for (let i = 0; i < existingMessages.length; i++) {
                            const el = existingMessages[i];
                            const elContent = el.querySelector('p') ? el.querySelector('p').textContent : '';

                            // Nếu nội dung giống nhau và cùng người gửi, coi là tin nhắn trùng lặp
                            if (elContent === messageContent &&
                                message.sender === currentUsername &&
                                el.classList.contains('me')) {
                                console.log("Phát hiện tin nhắn trùng lặp theo nội dung và người gửi:", messageContent);
                                return;
                            }
                        }
                    }

                    // Hiển thị tin nhắn
                    displayMessage(message);

                    // Đảm bảo cuộn xuống sau khi hiển thị tin nhắn
                    setTimeout(() => {
                        const chatContainer = document.getElementById('content');
                        if (chatContainer) {
                            scrollToBottom(chatContainer);
                        }
                    }, 150);
                } else {
                    console.log("Tin nhắn không thuộc cuộc trò chuyện hiện tại, không hiển thị");

                    // Cập nhật số tin nhắn chưa đọc
                    const conversationElement = document.querySelector(`[data-conversation-id="${message.conversationId}"]`);
                    if (conversationElement) {
                        const unreadBadge = conversationElement.querySelector('.badge');
                        if (unreadBadge) {
                            const currentCount = parseInt(unreadBadge.textContent || '0');
                            unreadBadge.textContent = currentCount + 1;
                            unreadBadge.style.display = 'block';
                        }
                    }
                }
            }
        } catch (error) {
            console.error("Lỗi khi xử lý tin nhắn riêng tư:", error);
        }
    }

    function updateConversationName(conversationId, newName) {
        // Cập nhật tên cuộc trò chuyện trong danh sách
        const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (conversationElement) {
            const nameElement = conversationElement.querySelector('.data h5');
            if (nameElement) {
                nameElement.textContent = newName;
            }
        }

        // Nếu đang mở cuộc trò chuyện này, cập nhật tiêu đề
        if (currentConversationId === parseInt(conversationId)) {
            const topNameElement = document.querySelector('#top .data h5 a');
            if (topNameElement) {
                topNameElement.textContent = newName;
            }
            // Cập nhật biến toàn cục
            currentRecipientUsername = newName;
        }
    }

    function handleMessageEdit(data) {
        if (data.conversationId !== currentConversationId) return;

        const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
        if (messageElement) {
            const messageContent = messageElement.querySelector('p');
            if (messageContent) {
                messageContent.textContent = data.newContent;
                console.log(`Đã cập nhật tin nhắn ${data.messageId} trên UI`);

                // Hiển thị thông báo nhỏ
                showToast(`${data.senderName} đã chỉnh sửa một tin nhắn`);
            }
        }
        // if (currentConversationId) {
        //     fetchMessages(currentConversationId);
        // }
    }

    function handleMessageDelete(data) {
        if (data.conversationId !== currentConversationId) return;

        const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
        if (messageElement) {
            messageElement.remove();
            console.log(`Đã xóa tin nhắn ${data.messageId} khỏi UI`);

            // Hiển thị thông báo nhỏ
            showToast(`${data.senderName} đã xóa một tin nhắn`);
        }
        // if (currentConversationId) {
        //     fetchMessages(currentConversationId);
        // }
    }

    // Xử lý khi nhận tin nhắn nhóm
    function onGroupMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn nhóm:", message);

        // Kiểm tra cấu trúc tin nhắn
        const hasValidStructure = message && (message.groupId || message.conversationId || message.recipient);
        if (!hasValidStructure) {
            console.error("Cấu trúc tin nhắn nhóm không hợp lệ:", message);
            return;
        }

        // Kiểm tra xem tin nhắn có phải từ người gửi hiện tại không
        const isFromCurrentSender = message.sender === currentUsername || message.senderId === currentUserId?.toString();

        // Xác định ID của nhóm để so sánh
        const groupId = message.conversationId || message.groupId || message.recipient;

        // Kiểm tra xem tin nhắn có thuộc cuộc trò chuyện nhóm hiện tại không
        const isForCurrentGroup = currentConversationId && currentConversationId.toString() === groupId?.toString();

        // Log thông tin chi tiết để debug
        console.log("Thông tin tin nhắn nhóm:", {
            messageGroupId: groupId,
            currentConvId: currentConversationId,
            messageSenderId: message.senderId,
            currentUserId: currentUserId,
            isForCurrentGroup: isForCurrentGroup,
            isFromCurrentSender: isFromCurrentSender
        });

        // Nếu không phải từ người dùng hiện tại, cập nhật danh sách cuộc trò chuyện
        if (!isFromCurrentSender) {
            updateConversationList(message.sender || message.senderName);

            // Hiển thị thông báo nếu tin nhắn không phải đang xem cuộc trò chuyện nhóm này
            if (!isForCurrentGroup && Notification.permission === 'granted') {
                new Notification('Tin nhắn nhóm mới', {
                    body: `${message.sender || message.senderName}: ${message.content || message.messageText || message.message}`
                });
            }
        }

        // Hiển thị tin nhắn nếu đang xem cuộc trò chuyện nhóm này
        if (isForCurrentGroup) {
            console.log("Hiển thị tin nhắn cho cuộc trò chuyện nhóm hiện tại");

            // Đánh dấu tin nhắn đã đọc nếu cần
            if (message.messageId && !isFromCurrentSender) {
                markMessageAsRead(message.messageId);
            }

            // Hiển thị tin nhắn
            displayMessage(message);

            // Đảm bảo cuộn xuống sau khi hiển thị tin nhắn
            setTimeout(() => {
                const chatContainer = document.getElementById('content');
                if (chatContainer) {
                    scrollToBottom(chatContainer);
                }
            }, 100);
        } else {
            console.log("Tin nhắn không thuộc cuộc trò chuyện nhóm hiện tại, không hiển thị");

            // Cập nhật số tin nhắn chưa đọc
            const conversationElement = document.querySelector(`[data-conversation-id="${groupId}"]`);
            if (conversationElement) {
                const unreadBadge = conversationElement.querySelector('.badge');
                if (unreadBadge) {
                    const currentCount = parseInt(unreadBadge.textContent || '0');
                    unreadBadge.textContent = currentCount + 1;
                    unreadBadge.style.display = 'block';
                }
            }
        }
    }

    // Gửi tin nhắn
    function sendMessage(event) {
        event.preventDefault();

        if (!stompClient || !isConnected) {
            console.error("WebSocket chưa được kết nối, không thể gửi tin nhắn");
            const errorElement = document.getElementById('message-error');
            if (errorElement) {
                errorElement.textContent = "Không thể gửi tin nhắn do mất kết nối. Đang kết nối lại...";
                errorElement.style.display = 'block';
            }

            // Thử kết nối lại
            reconnectWebSocket();
            return;
        }

        const messageInput = document.getElementById('message-input');
        if (!messageInput) {
            console.error("Không tìm thấy phần tử message-input");
            return;
        }

        const messageContent = messageInput.value.trim();

        if (!messageContent) {
            console.log("Không gửi tin nhắn rỗng");
            return;
        }

        // Reset input và error message nếu có
        messageInput.value = '';
        const errorElement = document.getElementById('message-error');
        if (errorElement) {
            errorElement.style.display = 'none';
            errorElement.textContent = '';
        }

        // Tạo timestamp theo định dạng ISO
        const now = new Date();
        const timeISO = now.toISOString();

        // Thiết lập loại tin nhắn mặc định
        let messageType = 'CHAT';
        let destination = '/app/chat.sendMessage';

        // Kiểm tra xem các biến toàn cục đã được khởi tạo chưa
        if (!currentUsername || !currentUserId) {
            console.error("Thông tin người dùng chưa được khởi tạo đầy đủ");
            currentUsername = sessionStorage.getItem('username');
            const userData = JSON.parse(sessionStorage.getItem('user') || '{}');
            if (userData && userData.id) {
                currentUserId = userData.id;
            } else {
                console.error("Không thể lấy thông tin người dùng từ sessionStorage");
                return;
            }
        }

        // Chuẩn bị đối tượng tin nhắn với thông tin đầy đủ
        const chatMessage = {
            senderId: currentUserId,
            sender: currentUsername,
            content: messageContent,
            messageText: messageContent, // Thêm trường messageText để tương thích với phương thức hiển thị
            type: messageType,
            timestamp: timeISO,
            conversationId: currentConversationId  // Thêm conversationId vào tin nhắn
        };

        console.log("===== THÔNG TIN GỬI TIN NHẮN =====");
        console.log("SenderId:", currentUserId);
        console.log("ConversationId:", currentConversationId);
        console.log("IsGroupConversation:", isGroupConversation);

        // Phân biệt rõ ràng giữa tin nhắn nhóm và cá nhân dựa trên biến isGroupConversation
        if (isGroupConversation) {
            // TIN NHẮN NHÓM
            messageType = 'GROUP';
            destination = '/app/chat.group';
            chatMessage.type = messageType;
            chatMessage.groupId = currentConversationId.toString();
            chatMessage.recipient = currentConversationId.toString(); // Đặt recipient = groupId để controller có thể đọc

            console.log("TIN NHẮN NHÓM:");
            console.log("Destination:", destination);
            console.log("GroupId:", chatMessage.groupId);
        } else if (currentRecipientId) {
            // TIN NHẮN CÁ NHÂN
            console.log("TIN NHẮN RIÊNG TƯ:");

            // Đặt destination và type
            messageType = 'PRIVATE';
            destination = '/app/chat.private';
            chatMessage.type = messageType;

            // ĐẢM BẢO conversationId được đặt rõ ràng trong tin nhắn
            if (!chatMessage.conversationId || chatMessage.conversationId === 'undefined') {
                console.warn("ConversationId không hợp lệ trong tin nhắn riêng tư:", chatMessage.conversationId);
                chatMessage.conversationId = currentConversationId.toString();
                console.log("Đã đặt lại conversationId =", chatMessage.conversationId);
            }

            // Thiết lập thông tin người nhận
            chatMessage.recipientId = currentRecipientId.toString();
            chatMessage.recipient = currentRecipientUsername;

            // Log thông tin chi tiết để debug
            console.log("Destination:", destination);
            console.log("ConversationId:", chatMessage.conversationId);
            console.log("Recipient:", chatMessage.recipient);
            console.log("RecipientId:", chatMessage.recipientId);

            // Thêm trường nhận dạng để debug
            chatMessage._source = "client_private_send";

            // Hiển thị tin nhắn ngay khi gửi (optimistic UI)
            chatMessage.isMe = true;
            displayMessage(chatMessage);
        }
        // Tin nhắn nhóm
        else if (currentConversationId && currentConversationId !== 'group') {
            const conversation = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
            if (conversation && conversation.dataset.isGroup === "true") {
                messageType = 'GROUP'; // Đúng theo enum trong MessageType.java
                destination = `/app/chat.group`;
                chatMessage.type = messageType;
                chatMessage.groupId = currentConversationId.toString(); // Thêm groupId rõ ràng
                chatMessage.recipient = currentConversationId.toString();

                // Log chi tiết thông tin tin nhắn nhóm
                console.log(`===== GỬI TIN NHẮN NHÓM ĐẾN ${destination} =====`, {
                    type: chatMessage.type,
                    groupId: chatMessage.groupId,
                    recipient: chatMessage.recipient,
                    senderId: chatMessage.senderId,
                    message: chatMessage.content
                });

                // Hiển thị tin nhắn ngay khi gửi (optimistic UI)
                chatMessage.isMe = true;
                displayMessage(chatMessage);
            }
        }

        try {
            // Gửi tin nhắn qua WebSocket
            console.log(`Gửi tin nhắn ${messageType} tới ${destination}:`, chatMessage);
            stompClient.send(destination, {}, JSON.stringify(chatMessage));
        } catch (error) {
            console.error("Lỗi khi gửi tin nhắn:", error);
            const errorElement = document.getElementById('message-error');
            if (errorElement) {
                errorElement.textContent = "Lỗi khi gửi tin nhắn: " + error.message;
                errorElement.style.display = 'block';
            }
        }

        // Focus lại vào input để người dùng có thể tiếp tục gõ
        if (messageInput) {
            messageInput.focus();
        }
    }

    // Hàm xử lý submit form riêng biệt để đảm bảo không reload trang
    function handleFormSubmit(event) {
        event.preventDefault();
        event.stopPropagation();
        sendMessage(event);
        return false;
    }

    // Cập nhật UI khi nhận tin nhắn mới
    function updateConversationList(senderUsername) {
        // Nếu tin nhắn từ người dùng không có trong danh sách, thêm họ vào
        const userId = currentUserId;
        if (userId) {
            // Cập nhật lại danh sách cuộc trò chuyện để hiển thị tin nhắn mới nhất
            fetchConversations(userId).then(() => {
                console.log("Đã cập nhật danh sách cuộc hội thoại sau khi nhận tin nhắn mới");
            });
        }
    }

    // Đánh dấu tin nhắn đã đọc
    function markMessageAsRead(messageId) {
        fetch(`${baseURL}/messages/${messageId}/read`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + sessionStorage.getItem('token')
            }
        })
            .then(response => {
                if (response.ok) {
                    console.log(`Đã đánh dấu tin nhắn ${messageId} là đã đọc`);
                }
            })
            .catch(error => console.error('Lỗi khi đánh dấu tin nhắn đã đọc:', error));
    }

    // Hàm hiển thị tin nhắn trên giao diện
    function displayMessage(message) {
        const content = document.getElementById("show-message");
        if (!content) {
            console.error("Không tìm thấy phần tử hiển thị tin nhắn");
            return;
        }

        console.log("Chuẩn bị hiển thị tin nhắn:", message);

        // Kiểm tra tin nhắn đã tồn tại trong DOM chưa để tránh hiển thị trùng lặp
        // Nếu tin nhắn có messageId, kiểm tra theo ID đó
        if (message.messageId) {
            const existingMessage = document.querySelector(`[data-message-id="${message.messageId}"]`);
            if (existingMessage) {
                console.log("Tin nhắn có ID đã tồn tại, không hiển thị lại:", message.messageId);
                return;
            }
        }

        // Đối với tin nhắn optimistic (không có messageId từ server)
        // Kiểm tra theo nội dung và người gửi
        const messageContent = message.content || message.messageText || "";
        if (messageContent && message.senderId) {
            const existingMessages = document.querySelectorAll('.message');
            for (let i = 0; i < existingMessages.length; i++) {
                const el = existingMessages[i];
                const elContent = el.querySelector('p') ? el.querySelector('p').textContent : '';

                // Nếu nội dung giống nhau và cùng người gửi, coi là tin nhắn trùng lặp
                if (elContent === messageContent &&
                    message.sender === currentUsername &&
                    el.classList.contains('me')) {
                    console.log("Phát hiện tin nhắn trùng lặp theo nội dung và người gửi:", messageContent);
                    return;
                }
            }
        }

        // Xác định xem đây có phải là tin nhắn của người dùng hiện tại không
        const isMe = message.isMe || message.sender === currentUsername || message.senderId === currentUserId?.toString();

        // Định dạng thởi gian
        let time;
        try {
            time = formatTime(message.timestamp || message.createdAt || new Date().toISOString());
        } catch(e) {
            console.error("Lỗi định dạng thởi gian:", e);
            time = "Vừa xong";
        }

        // Tạo ID tin nhắn tạm thởi nếu không có
        const messageId = message.messageId || `temp-${new Date().getTime()}`;

        // Tạo các phần tử DOM thay vì sử dụng insertAdjacentHTML
        // Điều này giúp gắn sự kiện vào các nút một cách chính xác
        const messageDiv = document.createElement('div');
        messageDiv.className = isMe ? 'message me' : 'message';
        messageDiv.setAttribute('data-message-id', messageId);

        const textMainDiv = document.createElement('div');
        textMainDiv.className = 'text-main';
        messageDiv.appendChild(textMainDiv);

        if (isMe) {
            // Tin nhắn của người dùng hiện tại (bên phải, màu xanh)
            const textGroupDiv = document.createElement('div');
            textGroupDiv.className = 'text-group me align-items-center ml-2';
            textMainDiv.appendChild(textGroupDiv);

            // Dropdown menu
            const dropdownDiv = document.createElement('div');
            dropdownDiv.className = 'dropdown ml-2';
            textGroupDiv.appendChild(dropdownDiv);

            const dropdownButton = document.createElement('button');
            dropdownButton.className = 'btn';
            dropdownButton.setAttribute('data-toggle', 'dropdown');
            dropdownButton.setAttribute('aria-haspopup', 'true');
            dropdownButton.setAttribute('aria-expanded', 'false');
            dropdownDiv.appendChild(dropdownButton);

            const icon = document.createElement('i');
            icon.className = 'material-icons md-30';
            icon.textContent = 'more_vert';
            dropdownButton.appendChild(icon);

            const dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'dropdown-menu';
            dropdownDiv.appendChild(dropdownMenu);

            const editButton = document.createElement('button');
            editButton.className = 'dropdown-item';
            editButton.textContent = 'Update';
            editButton.onclick = function() { editMessage(messageId); };
            dropdownMenu.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'dropdown-item';
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = function() { deleteMessage(messageId); };
            dropdownMenu.appendChild(deleteButton);

            // Nội dung tin nhắn
            const textDiv = document.createElement('div');
            textDiv.className = 'text me';
            textGroupDiv.appendChild(textDiv);

            const paragraph = document.createElement('p');
            paragraph.textContent = message.content || message.messageText || '';
            textDiv.appendChild(paragraph);

            // Thời gian
            const timeSpan = document.createElement('span');
            timeSpan.textContent = time;
            textMainDiv.appendChild(timeSpan);
        } else {
            // Tin nhắn của người khác (bên trái, màu xám)
            // Tên người gửi
            const userNameDiv = document.createElement('div');
            userNameDiv.className = 'user-name mb-1';
            textMainDiv.appendChild(userNameDiv);

            const strongName = document.createElement('strong');
            strongName.textContent = message.sender?.username || message.sender || "Unknown";
            userNameDiv.appendChild(strongName);

            // Nhóm tin nhắn
            const textGroupDiv = document.createElement('div');
            textGroupDiv.className = 'text-group d-flex align-items-center mr-2';
            textMainDiv.appendChild(textGroupDiv);

            // Nội dung tin nhắn
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textGroupDiv.appendChild(textDiv);

            const paragraph = document.createElement('p');
            paragraph.textContent = message.content || message.messageText || '';
            textDiv.appendChild(paragraph);

            // Dropdown menu
            const dropdownDiv = document.createElement('div');
            dropdownDiv.className = 'dropdown ml-2';
            textGroupDiv.appendChild(dropdownDiv);

            const dropdownButton = document.createElement('button');
            dropdownButton.className = 'btn';
            dropdownButton.setAttribute('data-toggle', 'dropdown');
            dropdownButton.setAttribute('aria-haspopup', 'true');
            dropdownButton.setAttribute('aria-expanded', 'false');
            dropdownDiv.appendChild(dropdownButton);

            const icon = document.createElement('i');
            icon.className = 'material-icons md-30';
            icon.textContent = 'more_vert';
            dropdownButton.appendChild(icon);

            const dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'dropdown-menu';
            dropdownDiv.appendChild(dropdownMenu);

            const editButton = document.createElement('button');
            editButton.className = 'dropdown-item';
            editButton.textContent = 'UPDATE';
            editButton.onclick = function() { editMessage(messageId); };
            dropdownMenu.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'dropdown-item';
            deleteButton.textContent = 'Delete';
            deleteButton.onclick = function() { deleteMessage(messageId); };
            dropdownMenu.appendChild(deleteButton);

            // Thời gian
            const timeSpan = document.createElement('span');
            timeSpan.textContent = time;
            textMainDiv.appendChild(timeSpan);
        }

        // Thêm tin nhắn vào container
        content.appendChild(messageDiv);

        // Cuộn xuống dưới để hiển thị tin nhắn
        setTimeout(() => {
            const chatContainer = document.getElementById('content');
            if (chatContainer) {
                scrollToBottom(chatContainer);
            } else {
                console.error("Không tìm thấy container để cuộn");
            }
        }, 100);
    }
    document.getElementById("langSelect").addEventListener("change", function () {
        const selectedLang = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("lang", selectedLang);
        window.location.href = currentUrl.toString();
    });
    document.addEventListener("DOMContentLoaded", function () {
        let username = sessionStorage.getItem("username");

        // if (username) {
        //     username = decodeURIComponent(username);
        // }

        if (!username) {
            console.error("No username found in sessionStorage.");
            return;
        }

        console.log("test: ",username);

        // Kiểm tra flag kết nối WebSocket đã được đặt khi đăng nhập
        const shouldConnectWebSocket = sessionStorage.getItem("autoConnectWebSocket");
        if (shouldConnectWebSocket === "true") {
            console.log("Kết nối WebSocket ngay khi trang tải xong...");
            // Kết nối WebSocket ngay lập tức
            connectWebSocket();
            // Xóa flag để không kết nối lại vào lần tải trang tiếp theo
            sessionStorage.removeItem("autoConnectWebSocket");
        }

        fetchUserIdByUsername(username);
    });


    function fetchUserIdByUsername(username) {
        const token = sessionStorage.getItem("token");
        console.log(username);
        fetch(`${baseURL}/users/username/${username}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch user ID");
                }
                console.log(response);
                return response.json();
            })
            .then(user => {
                if (!user || !user.userId) {
                    console.error("User not found or invalid response");
                    return;
                }
                sessionStorage.setItem("userId", user.userId);

                // Thiết lập biến toàn cục currentUserId và user
                currentUserId = user.userId;

                // Lưu thông tin người dùng vào sessionStorage để truy cập sau này
                const userData = {
                    id: user.userId,
                    username: user.username,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    email: user.email
                };
                sessionStorage.setItem("user", JSON.stringify(userData));

                // Cập nhật UI
                document.getElementById("firstName").value = user.firstName;
                document.getElementById("lastName").value = user.lastName;
                document.getElementById("email").value = user.email;
                document.getElementById("username").value = user.username;
                document.getElementById("password").value = "";
                console.log("Đã lưu currentUserId:", user.userId);
                const profileName = `${user.firstName} ${user.lastName}`;
                const profileNameElement = document.querySelector(".profile h1");
                if (profileNameElement) {
                    profileNameElement.textContent = profileName;
                }
                const userImage = user.profilePicture ? user.profilePicture : "img/avatars/default-avatar.png";
                const avatarImages = document.querySelectorAll("img.avatar-xl");
                avatarImages.forEach(img => {
                    img.src = userImage;
                });
                fetchUserData(user.userId);
                fetchConversations(user.userId);
                fetchNotifications(user.userId);
                // loadMessages(user.userId);
            })
            .catch(error => console.error("Error fetching user ID:", error));
    }
    function fetchNotifications(userId) {
        const token = sessionStorage.getItem("token");
        fetch(`${baseURL}/contacts/notifications/${userId}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch notifications");
                }
                return response.json();
            })
            .then(data => {
                const alerts = document.getElementById('alerts');
                alerts.innerHTML = '';
                console.log('Fetched notifications:', data);

                data.forEach(req => {
                    const receiverId = Number(req.receiver.id);
                    const senderId = Number(req.sender.id);
                    const currentUserId = Number(userId);

                    const a = document.createElement('a');
                    a.className = "filterNotifications all latest notification";
                    a.href = "#";

                    const date = new Date(req.createdAt).toLocaleDateString();
                    let message = "";
                    let buttonsHtml = "";

                    if (receiverId === currentUserId && req.isAccepted === null) {
                        message = `${req.sender.firstName} ${req.sender.lastName} has sent you a friend request.`;
                        buttonsHtml = `
                        <button class="btn" onclick="acceptRequest(${req.id})">
                            <span class="material-icons">add</span>
                        </button>
                        <button class="btn" onclick="rejectRequest(${req.id})">
                            <span class="material-icons">close</span>
                        </button>
                    `;
                    } else if (senderId === currentUserId && req.isAccepted === true) {
                        message = `${req.receiver.firstName} ${req.receiver.lastName} has accepted your friend request.`;
                    } else {
                        return;
                    }

                    const profilePic = (receiverId === currentUserId
                        ? (req.sender.profilePicture || 'img/avatars/default-avatar.png')
                        : (req.receiver.profilePicture || 'img/avatars/default-avatar.png'));

                    const username = receiverId === currentUserId ? req.sender.username : req.receiver.username;

                    a.innerHTML = `
                    <img class="avatar-md" src="${profilePic}" title="${username}" alt="avatar">
                    <div class="status"><i class="material-icons online">fiber_manual_record</i></div>
                    <div class="data">
                        <p>${message}</p>
                        <span>${date}</span>
                    </div>
                    ${buttonsHtml}
                `;

                    alerts.appendChild(a);
                });
            })
            .catch(err => console.error(err));
    }

    function acceptRequest(requestId) {
        const token = sessionStorage.getItem("token");
        fetch(`${baseURL}/contacts/accept/${requestId}`, {
            method: 'POST',
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to accept request");
                return res.json();
            })
            .then(data => {
                // alert("Request accepted!");
                // Optionally reload or update UI
                // window.location.reload();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error accepting request");
            });
    }

    function rejectRequest(requestId) {
        const token = sessionStorage.getItem("token");
        fetch(`${baseURL}/contacts/decline/${requestId}`, {
            method: 'POST',
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to decline request");
                return res.json();
            })
            .then(data => {
                // alert("Request declined.");
                // Optionally reload or update UI
                // window.location.reload();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error declining request");
            });
    }


    function fetchUserData(userId) {
        const token = sessionStorage.getItem("token");
        console.log(userId);
        console.log(token);
        fetch(`${baseURL}/users/id/${userId}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch user data");
                }
                return response.json();
            })
            .then(data => {
                let contactsList = document.getElementById('contacts');
                contactsList.innerHTML = '';

                if (!data.contacts || data.contacts.length === 0) {
                    contactsList.innerHTML = "<p>No contacts found</p>";
                    return;
                }
                data.contacts.forEach(contact => {
                    let status = contact.status ? "online" : "offline";
                    let contactCard = `
                <a href="#" class="filterMembers all ${status} contact" data-toggle="list">
                    <img class="avatar-md" src="${contact.contactProfilePicture || 'img/avatars/default-avatar.png'}" data-toggle="tooltip" data-placement="top" title="${contact.contactFirstName}" alt="avatar">
                    <div class="status">
                        <i class="material-icons ${status}">fiber_manual_record</i>
                    </div>
                    <div class="data">
                        <h5>${contact.contactFirstName} ${contact.contactLastName}</h5>
                    </div>
                </a>
            `;
                    contactsList.innerHTML += contactCard;
                });
            })
            .catch(error => console.error("Error fetching user data:", error));
    }


    async function fetchConversations(userId) {
        const token = sessionStorage.getItem("token");
        console.log("Fetching conversations for user:", userId);
        console.log("Token:", token);

        try {
            const [conversationsRes, latestMessagesRes] = await Promise.all([
                fetch(`${baseURL}/conversations/user/${userId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                }),
                fetch(`${baseURL}/messages/latest/${userId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                })
            ]);

            if (!conversationsRes.ok || !latestMessagesRes.ok) {
                throw new Error("Failed to fetch conversations or messages");
            }

            const conversations = await conversationsRes.json();
            const latestMessages = await latestMessagesRes.json();

            const chatsList = document.getElementById('chats');
            chatsList.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                chatsList.innerHTML = "<p>No conversations found</p>";
                return;
            }

            const latestMessageMap = new Map();
            latestMessages.forEach(msg => {
                latestMessageMap.set(msg.conversation.id, msg);
            });

            conversations.forEach(conversation => {
                const latestMessage = latestMessageMap.get(conversation.id) || null;
                const latestTime = latestMessage ? formatTime(latestMessage.createdAt) : '';
                const latestText = latestMessage ? truncateText(latestMessage.messageText) : 'No messages yet...';
                const unreadCount = latestMessage && latestMessage.isRead === false && latestMessage.sender.id !== userId ? 1 : 0;
                const imageUrl = conversation.imageUrl || 'img/avatars/default-avatar.png';

                const isGroup = conversation.isGroup === true;
                const chatCard = `
                <a href="#list-chat" class="filterDiscussions all single" data-toggle="list" role="tab"
                   data-conversation-id="${conversation.id}"
                   data-recipient-id="${conversation.participantId || ''}"
                   data-recipient-name="${conversation.name}"
                   data-is-group="${isGroup}"
                   onclick="handleConversationClick(${conversation.id}, ${conversation.participantId || 'null'}, '${conversation.name}', ${isGroup});">
                    <img class="avatar-md" src="${imageUrl}" data-toggle="tooltip" data-placement="top" title="${conversation.name}" alt="avatar">
                    <div class="status">                        <i class="material-icons online">fiber_manual_record</i>
                    </div>
                    ${unreadCount > 0 ? `<div class="new bg-yellow"><span>+${unreadCount}</span></div>` : ''}
                    <div class="data">
                        <h5>${conversation.name}</h5>
                        <span style="color: black">${latestTime}</span>
                        <p style="color: black">${latestText}</p>
                    </div>
                </a>
            `;
                chatsList.insertAdjacentHTML('beforeend', chatCard);
                // fetchMessages(conversations.id, userId, conversation.name);
            });
            // $('[data-toggle="tooltip"]').tooltip();
            // if (conversations.length > 0) {
            //     await fetchMessages(conversations[0].id, userId, conversations[0].name);
            // }

        } catch (error) {
            console.error("Error fetching conversations or messages:", error);
            const chatsList = document.getElementById('chats');
            chatsList.innerHTML = "<p>Error loading conversations</p>";
        }

        // Cuộn đến tin nhắn mới nhất sau khi tải tin nhắn
        setTimeout(() => {
            const chatContainer = document.getElementById('content');
            if (chatContainer) {
                scrollToBottom(chatContainer);
                console.log("Đã cuộn xuống tin nhắn mới nhất sau khi chọn cuộc trò chuyện");
            }
        }, 300); // Đợi 300ms để đảm bảo tin nhắn đã được tải và hiển thị
    }

    function formatTime(dateTimeString) {
        const date = new Date(dateTimeString);
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'pm' : 'am';
        const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
        return `${formattedHours}:${minutes.toString().padStart(2, '0')}${ampm} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear().toString().slice(-2)}`;
    }

    function truncateText(text, maxLength = 25) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function countUnreadMessages(messages, userId) {
        return messages.filter(m => m.isRead === false && m.sender.id !== userId).length;
    }

    async function fetchMessages(conversationId, userId, conversationName) {
        const token = sessionStorage.getItem("token");
        const content = document.getElementById("show-message");
        content.innerHTML = '';

        try {
            const response = await fetch(`${baseURL}/messages/conversation/${conversationId}`, {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) {
                throw new Error("Failed to fetch messages");
            }

            const topConservation = document.getElementById("top");
            topConservation.innerHTML = `
                <div class="container">
                    <div class="col-md-12">
                        <div class="inside">
                            <div class="data">
                                <h5><a href="#">${conversationName}</a></h5>
                                <span th:text="#{status.online}">Active now</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item clear-history" th:text="#{clear.history}"><i class="material-icons" data-toggle="modal" data-target="#modalClearHistory">clear</i>Clear History</button>
                                    <button class="dropdown-item block-contact" th:text="#{block.contact}"><i class="material-icons" data-toggle="modal" data-target="#modalBlockContact">block</i>Block Contact</button>
                                    <button class="dropdown-item delete-contact" th:text="#{delete.contact}"><i class="material-icons" data-toggle="modal" data-target="#modalDeleteContact" >delete</i>Delete Contact</button>
                                    <button class="dropdown-item rename-conversation" th:text="#{rename}" data-toggle="modal" data-target="#modalRename"><i class="material-icons">edit</i>Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            const sendMessage = document.getElementById("send-message");
            sendMessage.innerHTML = `
                <form class="position-relative w-100" id="message-form">
                    <textarea id="message-input" class="form-control" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                    <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                </form>
                <label>
                    <input type="file">
                    <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                </label>`;

            // Thêm event handler cho form ngay sau khi tạo
            const messageForm = document.getElementById('message-form');
            if (messageForm) {
                // Xóa event listener cũ trước khi thêm cái mới (tránh duplicate)
                messageForm.removeEventListener('submit', handleFormSubmit);

                // Thêm event listener mới với hàm xử lý riêng biệt để ngăn form submit
                messageForm.addEventListener('submit', handleFormSubmit);
            }

            // Lưu thông tin cuộc trò chuyện hiện tại
            currentConversationId = conversationId;
            currentRecipientId = userId;
            currentRecipientUsername = conversationName;

            const messages = await response.json();
            if (!messages || messages.length === 0) {
                content.innerHTML = "<p>No messages yet</p>";
                return;
            }

            messages.forEach(message => {
                const isOwnMessage = message.sender.id === userId;
                const time = formatTime(message.createdAt);
                console.log("Sender ID:", message.sender.id, "Current User ID:", sessionStorage.getItem("userId"));
                if (isOwnMessage) {

                    //send message
                    const messageHTML = `
                                        <div class="message me" data-message-id="${message.id}">
												<div class="text-main">
													<div class="text-group me align-items-center ml-2" >
                                                        <div class="dropdown ml-2" >
                                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="material-icons md-30">more_vert</i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <button class="dropdown-item" onclick="editMessage('${message.id}')" data-toggle="modal" data-target="#modalUpdateMessage">Update</button>
                                                                <button class="dropdown-item" onclick="deleteMessage('${message.id}')" data-toggle="modal" data-target="#modalConfirm">Delete</button>
                                                            </div>
                                                        </div>
														<div class="text me">
															<p>${escapeHtml(message.messageText)}</p>
														</div>
													</div>
													<span>${message.isread ? '<i class="material-icons">check</i>' : ''}${time}</span>
												</div>
											</div>
    `;
                    content.insertAdjacentHTML('beforeend', messageHTML);
                } else {
                    // Received Message
                    const messageHTML = `
                                <div class="message" data-message-id="${message.id}">
												<div class="text-main">
													    <div class="user-name mb-1">
															<strong>${escapeHtml(message.sender?.username || message.sender || "Unknown")}</strong>
														</div>
													    <div class="text-group d-flex align-items-center mr-2" >
														<div class="text">
															<p>${escapeHtml(message.messageText)}</p>
														</div>
                                                        <div class="dropdown ml-2" >
                                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="material-icons md-30">more_vert</i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <button class="dropdown-item" onclick="editMessage('${message.id}')">Update</button>
                                                                <button class="dropdown-item" onclick="deleteMessage('${message.id}')">Delete</button>
                                                            </div>
                                                        </div>
													</div>
													<span>${message.isread ? '<i class="material-icons">check</i>' : ''}${time}</span>
												</div>
											</div>
`;
                    content.insertAdjacentHTML('beforeend', messageHTML);
                }
            });

        } catch (error) {
            console.error("Error fetching messages:", error);
            content.innerHTML = "<p>Error loading messages</p>";
        }

        // Cuộn đến tin nhắn mới nhất sau khi tải tin nhắn
        setTimeout(() => {
            const chatContainer = document.getElementById('content');
            if (chatContainer) {
                scrollToBottom(chatContainer);
                console.log("Đã cuộn xuống tin nhắn mới nhất sau khi chọn cuộc trò chuyện");
            }
        }, 300); // Đợi 300ms để đảm bảo tin nhắn đã được tải và hiển thị
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;',
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    function updateProfileUI(userData) {
        const profileNameElement = document.querySelector(".profile h1");
        if (profileNameElement) {
            profileNameElement.textContent = `${userData.firstName} ${userData.lastName}`;
        }

        // const avatarImages = document.querySelectorAll("img.avatar-xl");
        // avatarImages.forEach(img => {
        //     img.src = userData.image || 'img/avatars/default-avatar.png';
        // });
    }
    document.getElementById("change_profile").addEventListener("submit", function () {
        console.log("changeProfile called");
        event.preventDefault();
        const token = sessionStorage.getItem("token");
        const userId = sessionStorage.getItem("userId");
        const username = document.getElementById('username').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const update = {
            username,
            firstName,
            lastName,
            email
        };
        if (password && password.length > 8) {
            update.hashPassword = password;
        }
        fetch(`${baseURL}/users/update/${userId}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify(update),
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        }).then(update => {
            console.log(update);
            // sessionStorage.setItem("user", JSON.stringify(update));
            updateProfileUI(update);
            // document.getElementById("change_profile").reset();
        })
            .catch(error => console.log(error));
        console.log("this response from change profile");
    });
    document.getElementById("deleteAccountBtn").addEventListener("click", function () {


        const token = sessionStorage.getItem("token");
        const userId = sessionStorage.getItem("userId");

        fetch(`${baseURL}/users/delete/${userId}`, {
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to delete account. Status: ${response.status}`);
                }
                // Clear session and redirect
                // sessionStorage.clear();
                // alert("Your account has been deleted.");
                window.location.href = "/login"; // or your logout/homepage
            })
            .catch(error => {
                console.error("Error deleting account:", error);
                alert("Unable to delete account. Please try again later.");
            });
    });
    function handleConversationClick(conversationId, userId, conversationName, isGroup = false) {
        console.log(`Clicked on conversation: ID=${conversationId}, Name=${conversationName}, IsGroup=${isGroup}`);

        // Đánh dấu cuộc trò chuyện đang được chọn trong UI
        document.querySelectorAll('.discussions .person').forEach(item => {
            item.classList.remove('active');
        });

        const selectedConversation = document.querySelector(`.person[data-conversation-id="${conversationId}"]`);
        if (selectedConversation) {
            selectedConversation.classList.add('active');
        }

        // Reset và cập nhật biến toàn cục
        currentConversationId = conversationId;
        isGroupConversation = isGroup;

        if (isGroup) {
            // Nhóm: không có recipient cá nhân
            currentRecipientId = null;
            currentRecipientUsername = conversationName;
            subscribeToGroupMessages(conversationId);
        } else {
            // Cá nhân: lấy đúng participantId (khác với currentUserId)
            let recipientId = userId;
            if (!recipientId || recipientId === currentUserId) {
                // Nếu userId truyền vào là chính mình, tìm participant khác trong conversation
                const conversationElem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (conversationElem && conversationElem.dataset.recipientId && conversationElem.dataset.recipientId !== currentUserId.toString()) {
                    recipientId = conversationElem.dataset.recipientId;
                }
            }
            currentRecipientId = recipientId;
            currentRecipientUsername = conversationName;
            subscribeToPrivateMessages(conversationId);
        }

        console.log("Thông tin cuộc trò chuyện hiện tại:", {
            currentConversationId,
            currentRecipientId,
            currentRecipientUsername,
            currentUserId,
            currentUsername
        });

        const topElement = document.getElementById('top');
        if (topElement) {
            topElement.innerHTML = `
                <div class="container">
                    <div class="col-md-12">
                        <div class="inside">
                            <div class="data">
                                <h5><a href="#">${conversationName}</a></h5>
                                <span>${isGroup ? 'Nhóm chat' : 'Trực tuyến'}</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item clear-history" data-conversation-id="${conversationId}" th:text="#{clear.history}"><i class="material-icons">clear</i>Clear History</button>
                                    <button class="dropdown-item block-contact" data-user-id="${currentRecipientId}" th:text="#{block.contact}"><i class="material-icons">block</i>Block Contact</button>
                                    <button class="dropdown-item delete-contact" data-contact-id="${currentRecipientId}" th:text="#{delete.contact}"><i class="material-icons">delete</i>Delete Contact</button>
                                    <button class="dropdown-item rename-conversation" data-conversation-id="${conversationId}" th:text="#{rename}"><i class="material-icons">edit</i>Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Ngay sau khi cập nhật DOM, gắn các event listener
            setTimeout(() => {
                console.log("Thiết lập các event cho dropdown menu");
                // Clear history button
                const clearHistoryButton = document.querySelector('.clear-history');
                if (clearHistoryButton) {
                    clearHistoryButton.addEventListener('click', function () {
                        console.log("Đã nhấp vào nút xóa lịch sử");

                        const convId = this.getAttribute('data-conversation-id') || currentConversationId;
                        if (!convId) {
                            console.error("Không thể xác định cuộc trò chuyện");
                            return;
                        }

                        // Save convId temporarily
                        document.getElementById('confirmClearHistory').setAttribute('data-conversation-id', convId);
                        // clearConversationHistory(convId);
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('modalClearHistory'));
                        modal.show();
                    });
                } else {
                    console.error("Không tìm thấy nút Clear History");
                }

                document.getElementById('confirmClearHistory').addEventListener('click', function () {
                    const convId = this.getAttribute('data-conversation-id');
                    clearConversationHistory(convId);

                    // Close modal
                    // const modalElement = document.getElementById('modalClearHistory');
                    // const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    // modalInstance.hide();
                });

                // Block contact button
                const blockContactButton = document.querySelector('.block-contact');
                if (blockContactButton) {
                    blockContactButton.addEventListener('click', function () {
                        const uid = this.getAttribute('data-user-id') || currentRecipientId;
                        console.log(currentRecipientId);
                        if (!uid) {
                            console.error("Không thể xác định người dùng");
                            return;
                        }

                        document.getElementById('confirmBlockContact').setAttribute('data-user-id', uid);

                        const modal = new bootstrap.Modal(document.getElementById('modalBlockContact'));
                        modal.show();
                    });
                } else {
                    console.error("Không tìm thấy nút Block Contact");
                }


                // Delete contact button
                let pendingDeleteUserId = null;
                const deleteContactButton = document.querySelector('.delete-contact');
                if (deleteContactButton) {
                    deleteContactButton.addEventListener('click', function () {
                        console.log("Đã nhấp vào nút xóa liên hệ");
                        const contactId = this.getAttribute('data-contact-id') || currentRecipientId;
                        if (!contactId) {
                            console.error("Không thể xác định liên hệ");
                            return;
                        }
                        // deleteContact(contactId);
                        const token = sessionStorage.getItem("token");
                        const currentUserId = sessionStorage.getItem("userId");

                        // Bước 1: Lấy contactId dựa trên userId
                        fetch(`${baseURL}/contacts/find-by-users?userId=${currentUserId}&contactId=${userId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                                if (!response.ok) {
                                    throw new Error("Không thể tìm thấy thông tin liên hệ");
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data && data.id) {
                                    console.log("Đã tìm thấy contactId:", data.id);
                                    // Bước 2: Xóa liên hệ với contactId đúng
                                    deleteContact(data.id);
                                } else {
                                    throw new Error("Không tìm thấy ID liên hệ");
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi khi tìm contactId:", error);
                                showToast("Không thể xóa liên hệ: " + error.message, true);
                            });
                        pendingDeleteUserId = contactId;
                        const modal = new bootstrap.Modal(document.getElementById('modalDeleteContact'));
                        modal.show();
                    });
                } else {
                    console.error("Không tìm thấy nút Delete Contact");
                }
                const renameConversationButton = document.querySelector('.rename-conversation');
                if (renameConversationButton) {
                    renameConversationButton.addEventListener('click', function () {
                        console.log("Đã nhấp vào nút đổi tên cuộc trò chuyện");

                        const convId = this.getAttribute('data-conversation-id') || currentConversationId;
                        if (!convId) {
                            console.error("Không thể xác định cuộc trò chuyện");
                            return;
                        }

                        // Lưu convId vào một biến toàn cục hoặc dataset
                        document.getElementById('renameForm').setAttribute('data-conversation-id', convId);

                        // (Tuỳ chọn) điền tên hiện tại vào input
                        document.getElementById('renameDiscussion').value = currentRecipientUsername || '';

                        // Hiển thị modal
                        const modal = new bootstrap.Modal(document.getElementById('modalRename'));
                        modal.show();
                    });
                } else {
                    console.error("Không tìm thấy nút Rename");
                }
            }, 100); // Đợi một chút để DOM được cập nhật

            const sendMessageElement = document.getElementById("send-message");
            if (sendMessageElement) {
                sendMessageElement.innerHTML = `
                <form class="position-relative w-100" id="message-form">
                    <textarea id="message-input" class="form-control"  rows="1"></textarea>
                    <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                </form>
                <label>
                    <input type="file">
                    <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                </label>`;

                // Thêm event handler cho form ngay sau khi tạo
                const messageForm = document.getElementById('message-form');
                if (messageForm) {
                    // Xóa event listener cũ trước khi thêm cái mới (tránh duplicate)
                    messageForm.removeEventListener('submit', handleFormSubmit);

                    // Thêm event listener mới với hàm xử lý riêng biệt để ngăn form submit
                    messageForm.addEventListener('submit', handleFormSubmit);
                }

                // Lưu thông tin cuộc trò chuyện hiện tại
                currentConversationId = conversationId;
                currentRecipientId = isGroup ? null : userId;
                currentRecipientUsername = isGroup ? null : conversationName;

                if (currentConversationId) {
                    if (isGroup) {
                        subscribeToGroupMessages(currentConversationId);
                    } else {
                        subscribeToPrivateMessages(currentConversationId);
                    }
                }
                // Tải tin nhắn cho cuộc trò chuyện
                fetchMessages(conversationId, currentUserId, conversationName);
            }

            // Focus lại vào input để người dùng có thể tiếp tục gõ
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.focus();
            }
        }

        // Hàm định dạng thởi gian tin nhắn
        function formatMessageTime(timeISO) {
            const date = new Date(timeISO);
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
            return `${formattedHours}:${minutes.toString().padStart(2, '0')}${ampm} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear().toString().slice(-2)}`;
        }

        // Xử lý khi có lỗi kết nối
        function onError(error) {
            console.error("Lỗi kết nối WebSocket:", error);
            isConnected = false;

            // Thử kết nối lại sau 5 giây
            setTimeout(function () {
                if (!isConnected) {
                    console.log("Đang thử kết nối lại...");
                    connectWebSocket();
                }
            }, 5000);
        }
        document.getElementById('confirmDeleteContact').addEventListener('click', () => {
            if (!pendingDeleteUserId) return;

            const token = sessionStorage.getItem("token");

            fetch(`${baseURL}/contacts/delete`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    userOne: currentUserId,
                    userTwo: pendingDeleteUserId
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error("Không thể xóa liên hệ");
                    showToast("Đã xóa liên hệ");
                    // Refresh UI
                    if (sessionStorage.getItem("userId")) {
                        fetchConversations(sessionStorage.getItem("userId"));
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi xóa liên hệ:", error);
                    showToast("Lỗi khi xóa liên hệ: " + error.message, true);
                });

            // Hide modal
            // const modal = bootstrap.Modal.getInstance(document.getElementById('modalDeleteContact'));
            // modal.hide();
        });
        function deleteContact(contactId) {
            const token = sessionStorage.getItem("token");

            fetch(`${baseURL}/contacts`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    userOne: currentUserId,
                    userTwo: contactId
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error("Không thể xóa liên hệ");
                    showToast("Đã xóa liên hệ");
                    // Refresh UI
                    if (sessionStorage.getItem("userId")) {
                        fetchConversations(sessionStorage.getItem("userId"));
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi xóa liên hệ:", error);
                    showToast("Lỗi khi xóa liên hệ: " + error.message, true);
                });
        }

        document.getElementById('renameForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const newName = document.getElementById('renameDiscussion').value.trim();
            if (!newName) return;
            console.log(newName);
            const token = sessionStorage.getItem("token");

            fetch(`${baseURL}/conversations/${currentConversationId}/rename`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Rename failed");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Rename successful:", data);
                    // Update UI
                    const conversationElement = document.querySelector(`.person[data-conversation-id="${currentConversationId}"] .name`);
                    if (conversationElement) {
                        conversationElement.textContent = newName;
                    }

                    // Update title if current
                    const topTitle = document.querySelector('#top .data h5 a');
                    if (topTitle) {
                        topTitle.textContent = newName;
                    }

                    // $('#modalRename').modal('hide');
                })
                .catch(error => {
                    console.error("Rename error:", error);
                    showToast("Failed to rename conversation", true);
                });
        });




        // // Xử lý khi nhận tin nhắn công khai
        // function onPublicMessageReceived(payload) {
        //     const message = JSON.parse(payload.body);
        //     console.log("Nhận tin nhắn công khai:", message);
        //
        //     // Hiển thị tin nhắn nếu đang xem kênh công khai
        //     if (currentConversationId === 'public') {
        //         displayMessage(message);
        //     }
        // }

        // Xử lý khi nhận tin nhắn riêng tư
        // function onPrivateMessageReceived(payload) {
        //     try {
        //         const message = JSON.parse(payload.body);
        //         console.log("Tin nhắn riêng tư nhận được:", message);
        //
        //         // Kiểm tra xem tin nhắn có phải từ người gửi hiện tại không
        //         const isFromCurrentSender = message.sender === currentUsername || message.senderId === currentUserId?.toString();
        //
        //         // Kiểm tra xem tin nhắn có phải cho cuộc trò chuyện hiện tại không
        //         const isForCurrentConversation =
        //             (message.senderId === currentRecipientId && message.recipientId === currentUserId?.toString()) ||
        //             (message.recipientId === currentRecipientId && message.senderId === currentUserId?.toString());
        //
        //         // Cập nhật UI danh sách cuộc trò chuyện
        //         if (!isFromCurrentSender) {
        //             updateConversationList(message.sender);
        //
        //             // Hiển thị thông báo nếu tin nhắn không phải đang trong cuộc trò chuyện hiện tại
        //             if (!isForCurrentConversation && Notification.permission === 'granted') {
        //                 new Notification('Tin nhắn mới', {
        //                     body: `${message.sender}: ${message.content}`
        //                 });
        //             }
        //         }
        //
        //         // Nếu là tin nhắn trong cuộc trò chuyện hiện tại, hiển thị ngay
        //         if (isForCurrentConversation) {
        //             // Đánh dấu tin nhắn đã đọc nếu cần
        //             if (message.messageId && !isFromCurrentSender) {
        //                 markMessageAsRead(message.messageId);
        //             }
        //
        //             // Hiển thị tin nhắn
        //             displayMessage(message);
        //
        //             // Đảm bảo cuộn xuống sau khi hiển thị tin nhắn
        //             setTimeout(() => {
        //                 const chatContainer = document.getElementById('content');
        //                 if (chatContainer) {
        //                     scrollToBottom(chatContainer);
        //                 }
        //             }, 150);
        //         }
        //     } catch (error) {
        //         console.error("Lỗi khi xử lý tin nhắn riêng tư:", error);
        //     }
        // }
        //
        // // Xử lý khi nhận tin nhắn nhóm
        // function onGroupMessageReceived(payload) {
        //     const message = JSON.parse(payload.body);
        //     console.log("Nhận tin nhắn nhóm:", message);
        //
        //     // Hiển thị tin nhắn nếu đang xem cuộc trò chuyện nhóm này
        //     const groupId = message.groupId || message.recipient; // Có thể lấy từ groupId hoặc recipient
        //     if (currentConversationId && currentConversationId.toString() === groupId.toString()) {
        //         displayMessage(message);
        //     } else {
        //         // Cập nhật số tin nhắn chưa đọc
        //         updateUnreadMessageCount(null, groupId);
        //     }
        // }

        // Gửi tin nhắn
        function sendMessage(event) {
            event.preventDefault();

            if (!stompClient || !isConnected) {
                console.error("WebSocket chưa được kết nối, không thể gửi tin nhắn");
                const errorElement = document.getElementById('message-error');
                if (errorElement) {
                    errorElement.textContent = "Không thể gửi tin nhắn do mất kết nối. Đang kết nối lại...";
                    errorElement.style.display = 'block';
                }

                // Thử kết nối lại
                reconnectWebSocket();
                return;
            }

            const messageInput = document.getElementById('message-input');
            if (!messageInput) {
                console.error("Không tìm thấy phần tử message-input");
                return;
            }

            const messageContent = messageInput.value.trim();

            if (!messageContent) {
                console.log("Tin nhắn trống, không gửi");
                return;
            }

            // Reset input và error message nếu có
            messageInput.value = '';
            const errorElement = document.getElementById('message-error');
            if (errorElement) {
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }

            // Tạo timestamp theo định dạng ISO
            const now = new Date();
            const timeISO = now.toISOString();

            // Mặc định là tin nhắn công khai
            let messageType = 'PUBLIC';
            let destination = '/app/chat.sendMessage';

            // Kiểm tra xem các biến toàn cục đã được khởi tạo chưa
            if (!currentUsername || !currentUserId) {
                console.error("Thông tin người dùng chưa được khởi tạo đầy đủ");
                currentUsername = sessionStorage.getItem('username');
                const userData = JSON.parse(sessionStorage.getItem('user') || '{}');
                if (userData && userData.id) {
                    currentUserId = userData.id;
                } else {
                    console.error("Không thể lấy thông tin người dùng từ sessionStorage");
                    return;
                }
            }

            // Chuẩn bị đối tượng tin nhắn với thông tin đầy đủ
            const chatMessage = {
                senderId: currentUserId,
                sender: currentUsername,
                content: messageContent,
                messageText: messageContent, // Thêm trường messageText để tương thích với phương thức hiển thị
                type: messageType,
                timestamp: timeISO,
                conversationId: currentConversationId  // Thêm conversationId vào tin nhắn
            };

            console.log("===== THÔNG TIN GỬI TIN NHẮN =====");
            console.log("SenderId:", currentUserId);
            console.log("ConversationId:", currentConversationId);
            console.log("IsGroupConversation:", isGroupConversation);

            // Phân biệt rõ ràng giữa tin nhắn nhóm và cá nhân dựa trên biến isGroupConversation
            if (isGroupConversation) {
                // TIN NHẮN NHÓM
                messageType = 'GROUP';
                destination = '/app/chat.group';
                chatMessage.type = messageType;
                chatMessage.groupId = currentConversationId.toString();
                chatMessage.recipient = currentConversationId.toString(); // Đặt recipient = groupId để controller có thể đọc

                console.log("TIN NHẮN NHÓM:");
                console.log("Destination:", destination);
                console.log("GroupId:", chatMessage.groupId);
            } else if (currentRecipientId) {
                // TIN NHẮN CÁ NHÂN
                console.log("TIN NHẮN RIÊNG TƯ:");

                // Đặt destination và type
                messageType = 'PRIVATE';
                destination = '/app/chat.private';
                chatMessage.type = messageType;
                chatMessage.recipientId = currentRecipientId.toString();
                chatMessage.recipient = currentRecipientUsername;

                // Hiển thị tin nhắn ngay khi gửi (optimistic UI)
                chatMessage.isMe = true;
                displayMessage(chatMessage);
            }
            // Tin nhắn nhóm
            else if (currentConversationId && currentConversationId !== 'group') {
                const conversation = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
                if (conversation && conversation.dataset.isGroup === "true") {
                    messageType = 'GROUP'; // Đúng theo enum trong MessageType.java
                    destination = `/app/chat.group`;
                    chatMessage.type = messageType;
                    chatMessage.groupId = currentConversationId.toString(); // Thêm groupId rõ ràng
                    chatMessage.recipient = currentConversationId.toString();

                    // Log chi tiết thông tin tin nhắn nhóm
                    console.log(`===== GỬI TIN NHẮN NHÓM ĐẾN ${destination} =====`, {
                        type: chatMessage.type,
                        groupId: chatMessage.groupId,
                        recipient: chatMessage.recipient,
                        senderId: chatMessage.senderId,
                        message: chatMessage.content
                    });

                    // Hiển thị tin nhắn ngay khi gửi (optimistic UI)
                    chatMessage.isMe = true;
                    displayMessage(chatMessage);
                }
            }

            try {
                // Gửi tin nhắn qua WebSocket
                console.log(`Gửi tin nhắn ${messageType} tới ${destination}:`, chatMessage);
                stompClient.send(destination, {}, JSON.stringify(chatMessage));
            } catch (error) {
                console.error("Lỗi khi gửi tin nhắn:", error);
                const errorElement = document.getElementById('message-error');
                if (errorElement) {
                    errorElement.textContent = "Lỗi khi gửi tin nhắn: " + error.message;
                    errorElement.style.display = 'block';
                }
            }

            // Focus lại vào input để người dùng có thể tiếp tục gõ
            if (messageInput) {
                messageInput.focus();
            }
        }

        // Hàm xử lý submit form riêng biệt để đảm bảo không reload trang
        function handleFormSubmit(event) {
            event.preventDefault();
            event.stopPropagation();
            sendMessage(event);
            return false;
        }

        // Cập nhật UI khi nhận tin nhắn mới
        function updateConversationList(senderUsername) {
            // Nếu tin nhắn từ người dùng không có trong danh sách, thêm họ vào
            const userId = currentUserId;
            if (userId) {
                // Cập nhật lại danh sách cuộc trò chuyện để hiển thị tin nhắn mới nhất
                fetchConversations(userId).then(() => {
                    console.log("Đã cập nhật danh sách cuộc hội thoại sau khi nhận tin nhắn mới");
                });
            }
        }

        // Đánh dấu tin nhắn đã đọc
        function markMessageAsRead(messageId) {
            fetch(`${baseURL}/messages/${messageId}/read`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token')
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log(`Đã đánh dấu tin nhắn ${messageId} là đã đọc`);
                    }
                })
                .catch(error => console.error('Lỗi khi đánh dấu tin nhắn đã đọc:', error));
        }
    }
    document.getElementById('confirmClearHistory').addEventListener('click', function () {
        const convId = this.getAttribute('data-conversation-id');
        clearConversationHistory(convId);
    });

    document.getElementById('uploadInput').addEventListener('change', async function () {
        const file = this.files[0];
        if (!file) return;

        const userId = sessionStorage.getItem('userId');
        const formData = new FormData();
        formData.append("file", file);
        console.log(formData);
        try {
            const response = await fetch(`${baseURL}/users/${userId}/profile-picture`, {
                method: "POST",
                body: formData,
                headers: {
                    "Authorization": `Bearer ${sessionStorage.getItem('token')}`
                },
            });

            if (!response.ok) throw new Error("Upload failed");

            const user = await response.json();
            console.log(user);
            const avatarImages = document.querySelectorAll("img.avatar-xl");
            avatarImages.forEach(img => {
                img.src = user.profilePicture || 'img/avatars/default-avatar.png';
            });
        } catch (error) {
            console.error("Upload failed:", error);
            alert("Failed to upload profile picture.");
        }
    });
    function clearConversationHistory(conversationId) {
        // Lấy userId từ biến toàn cục hoặc từ sessionStorage
        let userId = currentUserId || sessionStorage.getItem('userId');

        // Nếu vẫn không có userId, thử lại sau 1 giây
        if (!userId) {
            console.log("UserId chưa có sẵn, sẽ thử xóa lịch sử cuộc trò chuyện sau 1 giây");
            setTimeout(() => clearConversationHistory(conversationId), 1000);
            return;
        }

        if (!conversationId) {
            console.error("No conversation selected");
            return;
        }

        const token = sessionStorage.getItem("token");

        fetch(`${baseURL}/messages/conversation/${conversationId}/clear`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Lỗi: ${response.status}`);
                }

                // Gửi thông báo WebSocket
                if (stompClient && stompClient.connected) {
                    const notificationMsg = {
                        type: "CLEAR_HISTORY",
                        conversationId: conversationId,
                        initiatorId: userId
                    };
                    stompClient.send("/app/conversation-change", {}, JSON.stringify(notificationMsg));
                }

                // Xóa tin nhắn khỏi UI
                const messageContainer = document.getElementById('show-message');
                if (messageContainer) {
                    messageContainer.innerHTML = '';
                    showToast("Đã xóa lịch sử cuộc trò chuyện");
                }
            })
            .catch(error => {
                console.error("Lỗi khi xóa lịch sử cuộc trò chuyện:", error);
                showToast("Không thể xóa lịch sử cuộc trò chuyện", true);
            });
    }
    document.getElementById('confirmBlockContact').addEventListener('click', function () {
        const userId = this.getAttribute('data-user-id');
        console.log("blockcontact", userId);
        blockContact(userId);
    });

    function blockContact(userId) {
        // Lấy currentUserId từ biến toàn cục hoặc từ sessionStorage
        let currentUser = currentUserId || sessionStorage.getItem("userId");

        // Nếu vẫn không có currentUserId, thử lại sau 1 giây
        if (!currentUser) {
            console.log("CurrentUserId chưa có sẵn, sẽ thử chặn liên hệ sau 1 giây");
            setTimeout(() => blockContact(userId), 1000);
            return;
        }

        if (!userId) {
            console.error("No user selected");
            return;
        }

        const token = sessionStorage.getItem("token");
        // const currentUserId = sessionStorage.getItem("userId");
        if (!token) {
            console.error("Not logged in");
            return;
        }

        fetch(`${baseURL}/users/${currentUserId}/block/${userId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Could not block user");
                }
                // Gửi thông báo WebSocket
                if (stompClient && stompClient.connected) {
                    const notificationMsg = {
                        type: "BLOCKED",
                        userId: userId,
                        initiatorId: currentUser
                    };
                    stompClient.send("/app/contact-change", {}, JSON.stringify(notificationMsg));
                }

                showToast("Đã chặn người liên hệ");

                // Refresh conversation list
                fetchConversations(currentUser);
            })
            .catch(error => {
                console.error('Error blocking user:', error);
                showToast("Không thể chặn người liên hệ", true);
            });

        // const modal = bootstrap.Modal.getInstance(document.getElementById('modalBlockContact'));
        // if (modal) modal.hide();
    }


    function handleContactChange(data){
        console.log("Xu ly thong bao thay doi lien he: ", data);

        if (data.type === "DELETE"){
            showToast("Mot lien he da bi xoa");

            const currentUserId = sessionStorage.getItem("userId");
            fetchUserData(currentUserId);
            fetchConversations(currentUserId)
        }
    }

    function deleteContact(contactId) {
        // Lấy currentUserId từ biến toàn cục hoặc từ sessionStorage
        let currentUser = currentUserId || sessionStorage.getItem("userId");

        // Nếu vẫn không có currentUserId, thử lại sau 1 giây
        if (!currentUser) {
            console.log("CurrentUserId chưa có sẵn, sẽ thử xóa liên hệ sau 1 giây");
            setTimeout(() => deleteContact(contactId), 1000);
            return;
        }

        if (!contactId) {
            console.error("No contact selected");
            return;
        }

        if (!confirm('Bạn có chắc chắn muốn xóa người liên hệ này? Điều này cũng sẽ xóa cuộc trò chuyện và lịch sử tin nhắn.')) {
            return;
        }

        const token = sessionStorage.getItem("token");

        // Thực hiện xóa liên hệ
        fetch(`${baseURL}/contacts/${contactId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Lỗi ${response.status}: ${response.statusText}`);
                }
                return response.text().then(text => text ? JSON.parse(text) : {});
            })
            .then(data => {
                console.log("Đã xóa liên hệ thành công, tìm cuộc trò chuyện liên quan");

                // Tìm cuộc trò chuyện liên quan đến liên hệ này
                return fetch(`${baseURL}/conversations/by-contact/${contactId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
            })
            .then(response => {
                if (!response.ok) {
                    console.log("Không tìm thấy cuộc trò chuyện liên quan hoặc có lỗi:", response.status);
                    // Không tìm thấy không phải lỗi nghiêm trọng, tiếp tục xử lý
                    return { conversations: [] };
                }
                return response.json();
            })
            .then(data => {
                const deletePromises = [];

                // Xóa tất cả cuộc trò chuyện liên quan
                if (data.conversations && data.conversations.length > 0) {
                    data.conversations.forEach(conversation => {
                        console.log("Xóa cuộc trò chuyện:", conversation.id);
                        deletePromises.push(
                            fetch(`${baseURL}/conversations/${conversation.id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            })
                        );
                    });
                }

                // Nếu có cuộc trò chuyện cần xóa, chờ tất cả hoàn thành
                if (deletePromises.length > 0) {
                    return Promise.all(deletePromises);
                }
                // Kiểm tra nếu có cuộc trò chuyện đang được xem bị xóa
                if (data.conversations && data.conversations.length > 0) {
                    data.conversations.forEach(conversation => {
                        // Nếu đang xem cuộc trò chuyện bị xóa, dọn dẹp UI
                        if (currentConversationId === conversation.id) {
                            // Xóa nội dung chat
                            const messageContainer = document.getElementById('show-message');
                            if (messageContainer) {
                                messageContainer.innerHTML = '';
                            }

                            const topElement = document.getElementById("top");
                            if (topElement) {
                                topElement.innerHTML = '';
                            }

                            const sendMessageElement = document.getElementById("send-message");
                            if (sendMessageElement) {
                                sendMessageElement.innerHTML = '';
                            }

                            // Reset biến toàn cục
                            currentConversationId = null;
                            currentRecipientId = null;
                            currentRecipientUsername = null;
                        }
                    });
                }
                return Promise.resolve();
            })
            .then(() => {
                // Gửi thông báo WebSocket
                if (stompClient && stompClient.connected) {
                    const notificationMsg = {
                        type: "DELETE",
                        contactId: contactId,
                        initiatorId: currentUser
                    };
                    stompClient.send("/app/contact-change", {}, JSON.stringify(notificationMsg));
                }

                showToast("Đã xóa người liên hệ và cuộc trò chuyện liên quan");

                // Tải lại danh sách cuộc trò chuyện và danh sách liên hệ
                fetchConversations(currentUser);
                fetchUserData(currentUser);
            })
            .catch(error => {
                console.error('Error deleting contact:', error);
                showToast(`Không thể xóa liên hệ: ${error.message}`, true);
            });
    }

    /**
     * Rename conversation
     */
    function renameConversation(conversationId) {
        // Lấy currentUserId từ biến toàn cục hoặc từ sessionStorage
        let currentUser = currentUserId || sessionStorage.getItem("userId");

        // Nếu vẫn không có currentUserId, thử lại sau 1 giây
        if (!currentUser) {
            console.log("CurrentUserId chưa có sẵn, sẽ thử đổi tên cuộc trò chuyện sau 1 giây");
            setTimeout(() => renameConversation(conversationId), 1000);
            return;
        }

        if (!conversationId) {
            console.error("No conversation selected");
            return;
        }

        const newName = prompt('Nhập tên mới cho cuộc trò chuyện:', currentRecipientUsername);
        if (!newName || newName.trim() === '' || (currentRecipientUsername && newName.trim() === currentRecipientUsername)) {
            return;
        }

        const trimmedName = newName.trim();
        if (trimmedName.length < 3) {
            showToast("Tên phải có ít nhất 3 ký tự", true);
            return;
        }

        const token = sessionStorage.getItem("token");

        fetch(`${baseURL}/conversations/${conversationId}/rename`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: trimmedName })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || `Lỗi: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Gửi thông báo WebSocket
                if (stompClient && stompClient.connected) {
                    const notificationMsg = {
                        type: "RENAME",
                        conversationId: conversationId,
                        initiatorId: currentUser,
                        newName: trimmedName
                    };
                    stompClient.send("/app/conversation-change", {}, JSON.stringify(notificationMsg));
                }
                showToast("Đã đổi tên cuộc trò chuyện thành công");

                // Update conversation name in UI
                const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (conversationElement) {
                    const nameElement = conversationElement.querySelector('.data h5');
                    if (nameElement) {
                        nameElement.textContent = trimmedName;
                    }
                }

                // Update current conversation header
                const topNameElement = document.querySelector('#top .data h5 a');
                if (topNameElement) {
                    topNameElement.textContent = trimmedName;
                }

                // Update variable
                currentRecipientUsername = trimmedName;
            })
            .catch(error => {
                console.error('Lỗi khi đổi tên cuộc trò chuyện:', error);
                showToast("Không thể đổi tên cuộc trò chuyện", true);
            });
    }

    /**
     * Hiển thị thông báo
     */
    function showToast(message, isError = false) {
        // Tạo phần tử toast nếu chưa tồn tại
        let toast = document.getElementById('custom-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'custom-toast';
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '10px 15px';
            toast.style.borderRadius = '4px';
            toast.style.zIndex = '9999';
            toast.style.transition = 'opacity 0.3s ease-in-out';
            document.body.appendChild(toast);
        }

        // Thiết lập style dựa trên loại thông báo
        if (isError) {
            toast.style.backgroundColor = '#f44336';
        } else {
            toast.style.backgroundColor = '#4CAF50';
        }
        toast.style.color = 'white';

        // Cập nhật nội dung và hiển thị
        toast.textContent = message;
        toast.style.opacity = '1';

        // Tự động ẩn sau 3 giây
        setTimeout(() => {
            toast.style.opacity = '0';
        }, 3000);
    }

    /**
     * Xóa một mục (tin nhắn)
     */
    function deleteMessage(messageId) {
        if (!messageId || !currentConversationId) {
            console.error("No message selected");
            return;
        }

        if (messageId.startsWith('temp-')) {
            console.log("Không thể xóa tin nhắn tạm thời");
            showToast("Không thể xóa tin nhắn chưa được lưu", true);
            return;
        }

        // Store pending messageId and show modal
        pendingDeleteMessageId = messageId;
        document.querySelector('#modalConfirm .title h1').innerText = "Bạn có chắc chắn muốn xóa tin nhắn này?";
        $('#modalConfirm').modal('show');
    }
    document.getElementById("confirmDelete").addEventListener("click", function () {
        if (!pendingDeleteMessageId) return;

        const messageId = pendingDeleteMessageId;
        const token = sessionStorage.getItem("token");

        // Gọi API để xóa tin nhắn
        fetch(`${baseURL}/messages/${messageId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) throw new Error(`Lỗi: ${response.status}`);

                const messageElementToUpdate = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElementToUpdate) messageElementToUpdate.remove();

                showToast("Đã xóa tin nhắn");

                if (stompClient && stompClient.connected) {
                    const deleteNotification = {
                        type: 'DELETE',
                        messageId: messageId,
                        conversationId: currentConversationId,
                        senderId: currentUserId,
                        senderName: currentUsername,
                        timestamp: new Date().toISOString()
                    };

                    stompClient.send(
                        `/app/conversations/${currentConversationId}/delete`,
                        {},
                        JSON.stringify(deleteNotification)
                    );
                    console.log("Đã gửi thông báo xóa tin nhắn qua WebSocket");
                } else {
                    console.warn("WebSocket không kết nối, không thể gửi thông báo xóa");
                }

                $('#modalConfirm').modal('hide');


                // Xóa tin nhắn khỏi UI
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                    showToast("Đã xóa tin nhắn");
                }
            })
            .catch(error => {
                console.error("Lỗi khi xóa tin nhắn:", error);
                showToast("Không thể xóa tin nhắn", true);
            });
    });

    document.getElementById("cancelDelete").addEventListener("click", function () {
        $('#modalConfirm').modal('hide');
    });

    /**
     * Chỉnh sửa tin nhắn
     */
    let currentEditMessageId = null;

    function editMessage(messageId) {
        if (!messageId) {
            console.error("No message selected");
            return;
        }

        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (!messageElement) {
            console.error("Message element not found");
            return;
        }

        const messageContent = messageElement.querySelector('p');
        if (!messageContent) {
            console.error("Message content element not found");
            return;
        }

        const currentContent = messageContent.textContent;
        const inputField = document.getElementById('editMessage');
        inputField.value = currentContent;

        // Store the messageId globally for use on form submit
        currentEditMessageId = messageId;

        // Open Bootstrap modal
        const modal = new bootstrap.Modal(document.getElementById('modalUpdateMessage'));
        modal.show();
    }

    // Handle form submit
    document.getElementById('updateMessage').addEventListener('submit', async function (e) {
        e.preventDefault();

        const newContent = document.getElementById('editMessage').value.trim();
        const messageId = currentEditMessageId;
        const token = sessionStorage.getItem("token");

        if (!messageId || !newContent) {
            showToast("Message content cannot be empty", true);
            return;
        }

        try {
            const response = await fetch(`${baseURL}/messages/${messageId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: newContent })
            });

            if (!response.ok) {
                throw new Error(`Update failed: ${response.status}`);
            }

            const updatedMessage = await response.json();

            // Update message in DOM
            const messageElement = document.querySelector(`[data-message-id="${messageId}"] p`);
            if (messageElement) {
                messageElement.textContent = newContent;
            }

            showToast("Message updated successfully");

            // Ẩn modal sau khi cập nhật thành công
            // const modal = bootstrap.Modal.getInstance(document.getElementById('modalUpdateMessage'));
            // if (modal) modal.hide();

            // Notify via WebSocket
            if (stompClient && stompClient.connected) {
                const editNotification = {
                    type: 'UPDATE',
                    messageId: messageId,
                    conversationId: currentConversationId,
                    newContent: newContent,
                    senderId: currentUserId,
                    senderName: currentUsername,
                    timestamp: new Date().toISOString()
                };

                    // stompClient.send(`/app/chat/${currentConversationId}/edit`, {}, JSON.stringify(editNotification));
                    stompClient.send(`/app/conversations/${currentConversationId}/edit`, {}, JSON.stringify(editNotification));
                    console.log("Đã gửi thông báo chỉnh sửa tin nhắn qua WebSocket");
                } else {
                    console.warn("WebSocket không kết nối, không thể gửi thông báo chỉnh sửa");
                }
            }
            catch(error) {
                console.error("Lỗi khi cập nhật tin nhắn:", error);
                showToast("Không thể cập nhật tin nhắn", true);
            };

    })
    document.addEventListener('DOMContentLoaded', function() {
        if (sessionStorage.getItem("token") && sessionStorage.getItem("userId")) {
            currentUserId = sessionStorage.getItem("userId");
            currentUsername = sessionStorage.getItem("username");
            console.log("Khởi tạo kết nối WebSocket với userId:", currentUserId);
            connectWebSocket();
        }
    });

    // Cập nhật badge cho menu Discussions
    function updateConversationMenuBadge() {
        const unreadConversations = document.querySelectorAll('#chats .filterDiscussions.unread').length;
        const discussionsTab = document.querySelector('a[href="#discussions"]');

        let badge = discussionsTab.querySelector('.badge');
        if (unreadConversations > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'badge badge-danger';
                discussionsTab.appendChild(badge);
            }
            badge.textContent = unreadConversations;
        } else if (badge) {
            badge.remove();
        }
    }

    // Cập nhật badge cho menu Notifications
    function updateNotificationBadge(count) {
        const notificationTab = document.querySelector('a[href="#notifications"]');

        let badge = notificationTab.querySelector('.badge');
        if (count > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'badge badge-danger';
                notificationTab.appendChild(badge);
            }
            badge.textContent = count;
        } else if (badge) {
            badge.remove();
        }
    }
    // Thêm hàm mới để đánh dấu thông báo là đã đọc
    function markAllNotificationsAsRead() {
        if (!stompClient || !currentUserId) return;

        const token = sessionStorage.getItem("token");

        fetch(`/api/notifications/mark-all-read/${currentUserId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        }).then(response => {
            if (response.ok) {
                const notifications = document.querySelectorAll('#alerts .notification.unread');
                notifications.forEach(notification => {
                    notification.classList.remove('unread');
                    notification.classList.add('read');
                });

                updateNotificationBadge(0);
            }
        }).catch(error => {
            console.error("Error marking notifications as read:", error);
        });
    }

    // Cập nhật số lượng ban đầu khi tải trang
    function updateInitialBadges() {
        // Lấy số lượng cuộc trò chuyện chưa đọc
        fetch(`/api/conversations/unread-count/${currentUserId}`, {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
            }
        })
            .then(response => response.json())
            .then(data => {
                updateConversationMenuBadge(data.count);
            })
            .catch(error => console.error('Error fetching unread conversation count:', error));

        // Lấy số lượng thông báo chưa đọc
        fetch(`/api/notifications/unread-count/${currentUserId}`, {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('token')}`
            }
        })
            .then(response => response.json())
            .then(data => {
                updateNotificationBadge(data.count);
            })
            .catch(error => console.error('Error fetching unread notification count:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (sessionStorage.getItem("token") && sessionStorage.getItem("userId")) {
            currentUserId = sessionStorage.getItem("userId");
            currentUsername = sessionStorage.getItem("username");
            console.log("Khởi tạo kết nối WebSocket với userId:", currentUserId);
            connectWebSocket();
        }
    });

    //group chat
    const input = document.getElementById('participant');
    const inputUser = document.getElementById('user');
    const recipientList = document.getElementById('recipient-list');
    let recipient = [sessionStorage.getItem('userId')];
    const formGroupChat = document.getElementById('groupchat');
    const formNewFriend = document.getElementById('newFriend');
    const userTag = document.getElementById('userTag');
    input.addEventListener('keydown', async function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const search = input.value.trim();
            if (search === ''){
                showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                return;
            }
            try {
                const currentUserId = sessionStorage.getItem('userId');
                const response = await fetch(`/api/users/search-contacts?info=${encodeURIComponent(search)}&user=${currentUserId}`);
                if (!response.ok) {
                    showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                    return;
                }
                const user = await response.json();
                recipient.push(user.id.toString());
                const tag = document.createElement('div');
                tag.className = 'recipient-tag';
                tag.innerHTML = `
                <img class="avatar-sm" src="${user.profilePicture || 'img/avatars/default-avatar.png'}" alt="avatar">
                <h5>${user.username}</h5>
                <button class="btn"><i class="material-icons">close</i></button>
            `;

                recipientList.insertBefore(tag, input);
                input.value = '';
                input.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } catch (error) {
                showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                console.error('Fetch error:', error);
                input.value = '';
            }
        }
    });

    recipientList.addEventListener('click', function (e) {
        const isCloseBtn = e.target.closest('button');
        if (isCloseBtn && isCloseBtn.closest('.recipient-tag')) {
            const tag = isCloseBtn.closest('.recipient-tag');
            tag.remove();
        }
    });


    formGroupChat.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (recipient.length < 2) {
            showAlert('Please enter a username or email.', 'alert-message2');
            return;
        }
        console.log(recipient);
        const topic = document.getElementById('topic').value.trim();
        // const message = document.getElementById('message').value.trim();


        const payload = recipient.map(id => parseInt(id));

        try {
            const response = await fetch(`/api/conversations/group?conversationName=${encodeURIComponent(topic || '')}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    "Authorization": `Bearer ${sessionStorage.getItem('token')}`
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                return;
            }

            const conversation = await response.json();
            // showAlert('Conversation created successfully!', 'success');

            formGroupChat.reset();

            recipient = [currentUserId];
            recipientList.querySelectorAll('.recipient-tag').forEach(tag => tag.remove());
        } catch (error) {
            showAlert('Please enter a username or email.', 'alert-message2', 'warning');
            console.error('Fetch error:', error);
        }
    });
    let newUser = null;
    inputUser.addEventListener('keydown', async function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const userInput = document.getElementById('user').value.trim();
            if (userInput === '') {
                showAlert('Please enter a username or email.', 'alert-message1', 'warning');
                return;
            }
            try {
                const currentUserId = sessionStorage.getItem('userId');
                const response = await fetch(`/api/users/search-new?info=${encodeURIComponent(userInput)}&user=${currentUserId}`);
                if (!response.ok) {
                    showAlert('Please enter a username or email.', 'alert-message1', 'warning');
                    return;
                }
                const userData = await response.json();
                // Assuming recipient is an array to store user IDs
                // recipient.push(userData.id.toString());
                const tag = document.createElement('div');
                tag.className = 'user-tag recipient-tag';
                tag.innerHTML = `
                <img class="avatar-sm" src="${userData.profilePicture || 'img/avatars/default-avatar.png'}" alt="avatar">
                <h5>${userData.username}</h5>
                <button class="btn close-btn"><i class="material-icons">close</i></button>
            `;
                newUser = userData.id;
                // Insert tag before the input (replace recipientList with a suitable container if different)
                const container = document.querySelector('.form-group.user-tag');
                container.insertBefore(tag, document.getElementById('user'));
                inputUser.setAttribute('type','hidden');
                // inputUser.
            } catch (error) {
                showAlert('Please enter a username or email.', 'alert-message1');
                console.error('Fetch error:', error);
                // document.getElementById('user').value = '';
                inputUser.removeAttribute('type');
            }
        }
    })
    const userTagContainer = document.querySelector('.form-group.user-tag');
    userTagContainer.addEventListener('click', function (e) {
        const closeBtn = e.target.closest('.close-btn');
        if (closeBtn && closeBtn.closest('.user-tag')) {
            const tag = closeBtn.closest('.user-tag');
            tag.remove();
            newUser = null;
            inputUser.removeAttribute('type');
            inputUser.value = '';
            inputUser.focus();
        }
    });
    formNewFriend.addEventListener('submit', async function (event) {
        event.preventDefault();
        console.log('formNewFriend:', formNewFriend);
        const userOneId = sessionStorage.getItem('userId');
        if(newUser !== null){
            try{
                const response = await fetch(`/api/contacts/create?userOne=${userOneId}&userTwo=${newUser}`,{
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${sessionStorage.getItem('token')}`
                    },
                });
                if (!response.ok) {
                    showAlert('Error when send request.', 'alert-message1', 'warning');

                }
                else{
                    showAlert('Successfully send request.', 'alert-message1', 'success');
                    formNewFriend.reset();
                    newUser = null;
                }
            }catch(error){

                showAlert('Error when send request.', 'alert-message2', 'warning');
                formNewFriend.reset();
                newUser = null;
            }
        }
        else{
            showAlert('Please enter a username or email.', 'alert-message2', 'warning');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logout');

        if (!logoutBtn) {
            console.error('Logout button not found');
            return;
        }

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const token = sessionStorage.getItem('token');
            if (!token) {
                console.warn('No token found in sessionStorage');
                return;
            }

            try {
                const response = await fetch(`${baseURL}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        // 'Content-Type': 'application/json',
                    },
                });

                const responseBody = await response.text();
                console.log('Response status:', response.status, 'Body:', responseBody);

                if (response.ok) {
                    // Cleanup session
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('userId');
                    sessionStorage.removeItem('username');
                    sessionStorage.removeItem('user');
                    // Redirect to login page
                    window.location.href = '/login';
                    // await fetch('http://localhost:8080/login');
                } else {
                    alert(`Logout failed: ${responseBody}`);
                }
            } catch (error) {
                console.error('Logout request failed:', error);
                alert('An error occurred during logout. Please try again.');
            }
        });
    });
    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logout1');

        if (!logoutBtn) {
            console.error('Logout button not found');
            return;
        }

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const token = sessionStorage.getItem('token');
            if (!token) {
                console.warn('No token found in sessionStorage');
                return;
            }

            try {
                const response = await fetch(`${baseURL}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        // 'Content-Type': 'application/json',
                    },
                });

                const responseBody = await response.text();
                console.log('Response status:', response.status, 'Body:', responseBody);

                if (response.ok) {
                    // Cleanup session
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('userId');
                    sessionStorage.removeItem('username');
                    sessionStorage.removeItem('user');
                    // Redirect to login page
                    window.location.href = '/login';
                    // await fetch('http://localhost:8080/login');
                } else {
                    alert(`Logout failed: ${responseBody}`);
                }
            } catch (error) {
                console.error('Logout request failed:', error);
                alert('An error occurred during logout. Please try again.');
            }
        });
    });
</script>
</body>
</html>