<!DOCTYPE html>
<!--<html lang="en" >-->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chatroom</title>
    <meta name="description" content="#">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap core CSS -->
<!--    		<link href="css/lib" type="text/css" rel="stylesheet">-->
    <!-- Swipe core CSS -->
<!--    <link href="/css/swipe.min.css" type="text/css" rel="stylesheet">-->
    <!-- Favicon -->
    <link rel="stylesheet" href="/css/lib/bootstrap.min.css">
    <link rel="stylesheet" href="/css/swipe.min.css">
<!--    <link href="img/favicon.png" type="image/png" rel="icon">-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
    <style>
        p, a, i, h5, span, h1, h2, h3, h4, h5, h6 {
            text-decoration: none;
        }
    </style>
</head>
<body>
<main>
    <div class="layout">
        <div class="navigation">
            <div class="container">
                <div class="inside">
<!--                    menu-->
                    <div class="nav nav-tab menu">
                        <button class="btn"><img class="avatar-xl" alt="avatar"></button>
                        <a href="#members" data-toggle="tab"><i class="material-icons">account_circle</i></a>
                        <a href="#discussions" data-toggle="tab" class="active"><i class="material-icons active">chat_bubble_outline</i></a>
                        <a href="#notifications" data-toggle="tab" class="f-grow1"><i class="material-icons">notifications_none</i></a>
<!--                        <button class="btn mode"><i class="material-icons">brightness_2</i></button>-->
                        <a href="#settings" data-toggle="tab"><i class="material-icons">settings</i></a>
                        <button class="btn power" onclick="visitPage();"><i class="material-icons">power_settings_new</i></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="container">
                <div class="col-md-12">
                    <div class="tab-content">
                        <div class="tab-pane fade" id="members">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="people">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons">search</i></button>
                                </form>
                                <button class="btn create" data-toggle="modal" data-target="#exampleModalCenter"><i class="material-icons">person_add</i></button>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterMembersBtn active show" data-toggle="list" data-filter="all" style="border: none" th:text="#{filter.all}">All</button>
                                <button class="btn filterMembersBtn" data-toggle="list" data-filter="online" style="border: none" th:text="#{filter.online}">Online</button>
                                <button class="btn filterMembersBtn" data-toggle="list" data-filter="offline" style="border: none" th:text="#{filter.offline}">Offline</button>
                            </div>
<!--                            contact list-->
                            <div class="contacts">
                                <h1 th:text="#{contacts}">Contacts</h1>
                                <div class="list-group" id="contacts" role="tablist">
<!--                                    <a href="#" class="filterMembers all online contact" data-toggle="list">-->
<!--                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons online">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5>Janette Dalton</h5>-->
<!--                                        </div>-->
<!--                                    </a>-->
                                </div>
                            </div>
                        </div>
<!--                        discussions-->
                        <div id="discussions" class="tab-pane fade active show">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="conversations">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons">search</i></button>
                                </form>
                                <button class="btn create" data-toggle="modal" data-target="#startnewchat"><i class="material-icons">create</i></button>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterDiscussionsBtn active show" data-toggle="list" data-filter="all" th:text="#{filter.all}">All</button>
                                <button class="btn filterDiscussionsBtn" data-toggle="list" data-filter="read" th:text="#{filter.read}">Read</button>
                                <button class="btn filterDiscussionsBtn" data-toggle="list" data-filter="unread" th:text="#{filter.unread}">Unread</button>
                            </div>
                            <div class="discussions">
                                <h1 th:text="#{discussions}">Discussions</h1>
                                <div class="list-group" id="chats" role="tablist">
<!--                                    <a href="#list-chat" class="filterDiscussions all unread single active" id="list-chat-list" data-toggle="list" role="tab">-->
<!--                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons online">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="new bg-yellow">-->
<!--                                             <span>+7</span>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5>Name</h5>-->
<!--                                            <span>Latest time here(format time & day: 11:00am 1/1/24)</span>-->
<!--                                            <p>Newest message here...</p>-->
<!--                                        </div>-->
<!--                                    </a>-->
                                </div>
                            </div>
                        </div>
                        <!-- End of Discussions -->
                        <!-- Start of Notifications -->
                        <div id="notifications" class="tab-pane fade">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="notice">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons filter-list">filter_list</i></button>
                                </form>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterNotificationsBtn active show" data-toggle="list" data-filter="all" th:text="#{filter.all}">All</button>
                                <button class="btn filterNotificationsBtn" data-toggle="list" data-filter="latest" th:text="#{filter.latest}">Latest</button>
                                <button class="btn filterNotificationsBtn" data-toggle="list" data-filter="oldest" th:text="#{filter.oldest}">Oldest</button>
                            </div>
                            <div class="notifications">
                                <h1 th:text="#{notifications}">Notifications</h1>
                                <div class="list-group" id="alerts" role="tablist">
                                    <a href="#" class="filterNotifications all latest notification" data-toggle="list">
                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">
                                        <div class="status">
                                            <i class="material-icons online">fiber_manual_record</i>
                                        </div>
                                        <div class="data">
                                            <p>Janette has accepted your friend request on Swipe.</p>
                                            <span>Oct 17, 2018</span>
                                        </div>
                                    </a>
                                    <a href="#" class="filterNotifications all latest notification" data-toggle="list">
                                        <img class="avatar-md" src="img/avatars/avatar-male-1.jpg" data-toggle="tooltip" data-placement="top" title="Michael" alt="avatar">
                                        <div class="status">
                                            <i class="material-icons online">fiber_manual_record</i>
                                        </div>
                                        <div class="data">
                                            <p>Michael, you have a new friend suggestion today.</p>
                                            <span>Jun 21, 2018</span>
                                        </div>
                                    </a>

                                </div>
                            </div>
                        </div>
                        <!-- End of Notifications -->
                        <!-- Start of Settings -->
                        <div class="tab-pane fade" id="settings">
                            <div class="settings">
                                <div class="profile">"
                                    <img class="avatar-xl" alt="avatar">
                                    <h1>Michael Knudsen</h1>
<!--                                    <span>Helena, Montana</span>-->
<!--                                    <div class="stats">-->
<!--                                        <div class="item">-->
<!--                                            <h2>122</h2>-->
<!--                                            <h3>Fellas</h3>-->
<!--                                        </div>-->
<!--                                        <div class="item">-->
<!--                                            <h2>305</h2>-->
<!--                                            <h3>Chats</h3>-->
<!--                                        </div>-->
<!--                                        <div class="item">-->
<!--                                            <h2>1538</h2>-->
<!--                                            <h3>Posts</h3>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                </div>
                                <div class="categories" id="accordionSettings">
                                    <h1 th:text="#{settings}">Settings</h1>
                                    <!-- Start of My Account -->
                                    <div class="category">
                                        <a href="#" class="title collapsed" id="headingOne" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            <i class="material-icons md-30 online">person_outline</i>
                                            <div class="data">
                                                <h5 th:text="#{myaccount}">My Account</h5>
                                                <p th:text="#{myaccount.setting}">Update your profile details</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                        <div class="collapse" id="collapseOne" aria-labelledby="headingOne" data-parent="#accordionSettings">
                                            <div class="content">
                                                <div class="upload">
                                                    <div class="data">
                                                        <img class="avatar-xl" alt="image">
                                                        <label>
                                                            <input type="file">
                                                            <span class="btn button" th:text="#{upload.avatar}">Upload avatar</span>
                                                        </label>
                                                    </div>
                                                    <p th:text="#{avatar.content}">For best results, use an image at least 256px by 256px in either .jpg or .png format!</p>
                                                </div>
                                                <form id="change_profile" >
                                                    <div class="parent">
                                                        <div class="field">
                                                            <label for="firstName" th:text="#{first.name}">First name <span>*</span></label>
                                                            <input type="text" class="form-control" id="firstName" placeholder="First name" required>
                                                        </div>
                                                        <div class="field">
                                                            <label for="lastName" th:text="#{last.name}">Last name <span>*</span></label>
                                                            <input type="text" class="form-control" id="lastName" placeholder="Last name" required>
                                                        </div>
                                                    </div>
                                                    <div class="field">
                                                        <label for="email" th:text="#{setting.email}">Email <span>*</span></label>
                                                        <input type="email" class="form-control" id="email" placeholder="Enter your email address" required>
                                                    </div>
                                                    <div class="field">
                                                        <label for="username" th:text="#{setting.username}">Username <span>*</span></label>
                                                        <input class="form-control" id="username" placeholder="Enter your username" required>
                                                    </div>
                                                    <div class="field">
                                                        <label for="password" th:text="#{setting.password}">Password</label>
                                                        <input type="password" class="form-control" id="password" th:placeholder='#{password.content}'>
                                                    </div>
<!--                                                    <div class="field">-->
<!--                                                        <label for="location">Location</label>-->
<!--                                                        <input type="text" class="form-control" id="location" placeholder="Enter your location" value="Helena, Montana" required>-->
<!--                                                    </div>-->
                                                    <button class="btn btn-link w-100" th:text="#{delete.account}">Delete Account</button>
                                                    <button type="submit" class="btn button w-100" th:text="#{apply}">Apply</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End of My Account -->
                                    <!-- Start of Chat History -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingTwo" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">-->
<!--                                            <i class="material-icons md-30 online">mail_outline</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Chats</h5>-->
<!--                                                <p>Check your chat history</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseTwo" aria-labelledby="headingTwo" data-parent="#accordionSettings">-->
<!--                                            <div class="content layer">-->
<!--                                                <div class="history">-->
<!--                                                    <p>When you clear your conversation history, the messages will be deleted from your own device.</p>-->
<!--                                                    <p>The messages won't be deleted or cleared on the devices of the people you chatted with.</p>-->
<!--                                                    <div class="custom-control custom-checkbox">-->
<!--                                                        <input type="checkbox" class="custom-control-input" id="same-address">-->
<!--                                                        <label class="custom-control-label" for="same-address">Hide will remove your chat history from the recent list.</label>-->
<!--                                                    </div>-->
<!--                                                    <div class="custom-control custom-checkbox">-->
<!--                                                        <input type="checkbox" class="custom-control-input" id="save-info">-->
<!--                                                        <label class="custom-control-label" for="save-info">Delete will remove your chat history from the device.</label>-->
<!--                                                    </div>-->
<!--                                                    <button type="submit" class="btn button w-100">Clear blah-blah</button>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Chat History -->
                                    <!-- Start of Notifications Settings -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingThree" data-toggle="collapse" data-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">-->
<!--                                            <i class="material-icons md-30 online">notifications_none</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Notifications</h5>-->
<!--                                                <p>Turn notifications on or off</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseThree" aria-labelledby="headingThree" data-parent="#accordionSettings">-->
<!--                                            <div class="content no-layer">-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Desktop Notifications</h5>-->
<!--                                                        <p>You can set up Swipe to receive notifications when you have new messages.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Unread Message Badge</h5>-->
<!--                                                        <p>If enabled shows a red badge on the Swipe app icon when you have unread messages.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Taskbar Flashing</h5>-->
<!--                                                        <p>Flashes the Swipe app on mobile in your taskbar when you have new notifications.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Notification Sound</h5>-->
<!--                                                        <p>Set the app to alert you via notification sound when you have unread messages.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Vibrate</h5>-->
<!--                                                        <p>Vibrate when receiving new messages (Ensure system vibration is also enabled).</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Turn On Lights</h5>-->
<!--                                                        <p>When someone send you a text message you will receive alert via notification light.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingFour" data-toggle="collapse" data-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">-->
<!--                                            <i class="material-icons md-30 online">sync</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Connections</h5>-->
<!--                                                <p>Sync your social accounts</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseFour" aria-labelledby="headingFour" data-parent="#accordionSettings">-->
<!--                                            <div class="content">-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/slack.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Skrill</h5>-->
<!--                                                        <p>Read, Write, Comment</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/dropbox.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Dropbox</h5>-->
<!--                                                        <p>Read, Write, Upload</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/drive.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Google Drive</h5>-->
<!--                                                        <p>No permissions set</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/trello.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Trello</h5>-->
<!--                                                        <p>No permissions set</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Connections -->
                                    <!-- Start of Appearance Settings -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingFive" data-toggle="collapse" data-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">-->
<!--                                            <i class="material-icons md-30 online">colorize</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Appearance</h5>-->
<!--                                                <p>Customize the look of Swipe</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseFive" aria-labelledby="headingFive" data-parent="#accordionSettings">-->
<!--                                            <div class="content no-layer">-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Turn Off Lights</h5>-->
<!--                                                        <p>The dark mode is applied to core areas of the app that are normally displayed as light.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round mode"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Appearance Settings -->
                                    <!-- Start of Language -->
                                    <div class="category">
                                        <a href="#" class="title collapsed" id="headingSix" data-toggle="collapse" data-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
                                            <i class="material-icons md-30 online">language</i>
                                            <div class="data">
                                                <h5 th:text="#{language}">Language</h5>
                                                <p th:text="#{language.setting}">Select preferred language</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                        <div class="collapse" id="collapseSix" aria-labelledby="headingSix" data-parent="#accordionSettings">
                                            <div class="content layer">
                                                <div class="language">

                                                    <select class="custom-select" id="langSelect" required>
                                                        <option value="en" th:text="#{english}" th:selected="${#locale.language == 'en'}">English</option>
                                                        <option value="vi" th:text="#{vietnamese}" th:selected="${#locale.language == 'vi'}">Vietnamese</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End of Language -->
                                    <!-- Start of Privacy & Safety -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingSeven" data-toggle="collapse" data-target="#collapseSeven" aria-expanded="true" aria-controls="collapseSeven">-->
<!--                                            <i class="material-icons md-30 online">lock_outline</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Privacy & Safety</h5>-->
<!--                                                <p>Control your privacy settings</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseSeven" aria-labelledby="headingSeven" data-parent="#accordionSettings">-->
<!--                                            <div class="content no-layer">-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Keep Me Safe</h5>-->
<!--                                                        <p>Automatically scan and delete direct messages you receive from everyone that contain explict content.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>My Friends Are Nice</h5>-->
<!--                                                        <p>If enabled scans direct messages from everyone unless they are listed as your friend.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Everyone can add me</h5>-->
<!--                                                        <p>If enabled anyone in or out your friends of friends list can send you a friend request.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Friends of Friends</h5>-->
<!--                                                        <p>Only your friends or your mutual friends will be able to send you a friend reuqest.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Data to Improve</h5>-->
<!--                                                        <p>This settings allows us to use and process information for analytical purposes.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Data to Customize</h5>-->
<!--                                                        <p>This settings allows us to use your information to customize Swipe for you.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Privacy & Safety -->
                                    <!-- Start of Logout -->
                                    <div class="category">
                                        <a href="http://localhost:8080/api/auth/logout" class="title collapsed">
                                            <i class="material-icons md-30 online">power_settings_new</i>
                                            <div class="data">
                                                <h5>Power Off</h5>
                                                <p>Log out of your account</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                    </div>
                                    <!-- End of Logout -->
                                </div>
                            </div>
                        </div>
                        <!-- End of Settings -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Sidebar -->
        <!-- Start of Add Friends -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1 th:text="#{add.friend.title}">Add your friends</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form>
                            <div class="form-group">
                                <label for="user" th:text="#{setting.email}">Email:</label>
                                <input type="text" class="form-control" id="user" required>
                            </div>
                            <div class="form-group">
                                <label for="welcome" th:text="#{add.friend.message}">Message:</label>
                                <textarea class="text-control" id="welcome"></textarea>
                            </div>
                            <button type="submit" class="btn button w-100" th:text="#{add.friend.send}">Send Friend Request</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Add Friends -->
        <!-- Start of Create Chat -->
        <div class="modal fade" id="startnewchat" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1 th:text="#{converstaion.title}">Start new chat</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form>
                            <div class="form-group">
                                <label for="participant" th:text="#{recipient}">Recipients:</label>
                                <input type="text" class="form-control" id="participant" required>
                                <div class="user" id="recipient">
                                    <img class="avatar-sm" src="img/avatars/avatar-female-5.jpg" alt="avatar">
                                    <h5>Keith Morris</h5>
                                    <button class="btn"><i class="material-icons">close</i></button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="topic" th:text="#{topic}">Topic:</label>
                                <input type="text" class="form-control" id="topic" required>
                            </div>
                            <div class="form-group">
                                <label for="message" th:text="#{add.friend.message}">Message:</label>
                                <textarea class="text-control" id="message"></textarea>
                            </div>
                            <button type="submit" class="btn button w-100" th:text="#{start.conversation}">Start New Chat</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Create Chat -->
        <div class="main">
            <div class="tab-content" id="nav-tabContent">
                <!-- Start of Babble -->
                <div class="babble tab-pane fade active show" id="list-chat" role="tabpanel" aria-labelledby="list-chat-list">
                    <!-- Start of Chat -->
                    <div class="chat" id="chat">
                        <div class="top" id="top">
                        </div>
                        <div class="content" id="content">
                            <div class="container">
                            <div class="col-md-12" id="show-message" ></div>
                            </div>
                        </div>
                        <div class="container">
                            <div class="col-md-12">
                                <div class="bottom" id="send-message">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End of Chat -->
                    <!-- Start of Call -->
<!--                    <div class="call" id="call1">-->
<!--                        <div class="content">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <div class="panel">-->
<!--                                            <div class="participant">-->
<!--                                                <img class="avatar-xxl" src="img/avatars/avatar-female-5.jpg" alt="avatar">-->
<!--                                                <span>Connecting</span>-->
<!--                                            </div>-->
<!--                                            <div class="options">-->
<!--                                                <button class="btn option"><i class="material-icons md-30">mic</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">videocam</i></button>-->
<!--                                                <button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">person_add</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">volume_up</i></button>-->
<!--                                            </div>-->
<!--                                            <button class="btn back" name="1"><i class="material-icons md-24">chat</i></button>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Call -->
                </div>
                <!-- End of Babble -->
                <!-- Start of Babble -->
                <div class="babble tab-pane fade" id="list-empty" role="tabpanel" aria-labelledby="list-empty-list">
                    <!-- Start of Chat -->
<!--                    <div class="chat" id="chat2">-->
<!--                        <div class="top">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <a href="#"><img class="avatar-md" src="img/avatars/avatar-female-2.jpg" data-toggle="tooltip" data-placement="top" title="Lean" alt="avatar"></a>-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons offline">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5><a href="#">Lean Avent</a></h5>-->
<!--                                            <span>Inactive</span>-->
<!--                                        </div>-->
<!--                                        <button class="btn connect d-md-block d-none" name="2"><i class="material-icons md-30">phone_in_talk</i></button>-->
<!--                                        <button class="btn connect d-md-block d-none" name="2"><i class="material-icons md-36">videocam</i></button>-->
<!--                                        <button class="btn d-md-block d-none"><i class="material-icons md-30">info</i></button>-->
<!--                                        <div class="dropdown">-->
<!--                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>-->
<!--                                            <div class="dropdown-menu dropdown-menu-right">-->
<!--                                                <button class="dropdown-item connect" name="2"><i class="material-icons">phone_in_talk</i>Voice Call</button>-->
<!--                                                <button class="dropdown-item connect" name="2"><i class="material-icons">videocam</i>Video Call</button>-->
<!--                                                <hr>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="content empty">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="no-messages">-->
<!--                                        <i class="material-icons md-48">forum</i>-->
<!--                                        <p>Seems people are shy to start the chat. Break the ice send the first message.</p>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="container">-->
<!--                            <div class="col-md-12">-->
<!--                                <div class="bottom">-->
<!--                                    <form class="position-relative w-100">-->
<!--                                        <textarea class="form-control" placeholder="Start typing for reply..." rows="1"></textarea>-->
<!--&lt;!&ndash;                                        <button class="btn emoticons"><i class="material-icons">insert_emoticon</i></button>&ndash;&gt;-->
<!--                                        <button type="submit" class="btn send"><i class="material-icons">send</i></button>-->
<!--                                    </form>-->
<!--                                    <label>-->
<!--                                        <input type="file">-->
<!--                                        <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>-->
<!--                                    </label>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Chat -->
                    <!-- Start of Call -->
<!--                    <div class="call" id="call2">-->
<!--                        <div class="content">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <div class="panel">-->
<!--                                            <div class="participant">-->
<!--                                                <img class="avatar-xxl" src="img/avatars/avatar-female-2.jpg" alt="avatar">-->
<!--                                                <span>Connecting</span>-->
<!--                                            </div>-->
<!--                                            <div class="options">-->
<!--                                                <button class="btn option"><i class="material-icons md-30">mic</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">videocam</i></button>-->
<!--                                                <button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">person_add</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">volume_up</i></button>-->
<!--                                            </div>-->
<!--                                            <button class="btn back" name="2"><i class="material-icons md-24">chat</i></button>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Call -->
                </div>
                <!-- End of Babble -->
                <!-- Start of Babble -->
                <div class="babble tab-pane fade" id="list-request" role="tabpanel" aria-labelledby="list-request-list">
                    <!-- Start of Chat -->
<!--                    <div class="chat" id="chat3">-->
<!--                        <div class="top">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <a href="#"><img class="avatar-md" src="img/avatars/avatar-female-6.jpg" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons offline">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5><a href="#">Louis Martinez</a></h5>-->
<!--                                            <span>Inactive</span>-->
<!--                                        </div>-->
<!--                                        <button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-30">phone_in_talk</i></button>-->
<!--                                        <button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-36">videocam</i></button>-->
<!--                                        <button class="btn d-md-block disabled d-none" disabled><i class="material-icons md-30">info</i></button>-->
<!--                                        <div class="dropdown">-->
<!--                                            <button class="btn disabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled><i class="material-icons md-30">more_vert</i></button>-->
<!--                                            <div class="dropdown-menu dropdown-menu-right">-->
<!--                                                <button class="dropdown-item"><i class="material-icons">phone_in_talk</i>Voice Call</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">videocam</i>Video Call</button>-->
<!--                                                <hr>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="content empty">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="no-messages request">-->
<!--                                        <a href="#"><img class="avatar-xl" src="img/avatars/avatar-female-6.jpg" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>-->
<!--                                        <h5>Louis Martinez would like to add you as a contact. <span>Hi Keith, I'd like to add you as a contact.</span></h5>-->
<!--                                        <div class="options">-->
<!--                                            <button class="btn button"><i class="material-icons">check</i></button>-->
<!--                                            <button class="btn button"><i class="material-icons">close</i></button>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="container">-->
<!--                            <div class="col-md-12">-->
<!--                                <div class="bottom">-->
<!--                                    <form class="position-relative w-100">-->
<!--                                        <textarea class="form-control" placeholder="Messaging unavailable" rows="1" disabled></textarea>-->
<!--                                        <button class="btn emoticons disabled" disabled><i class="material-icons">insert_emoticon</i></button>-->
<!--                                        <button class="btn send disabled" disabled><i class="material-icons">send</i></button>-->
<!--                                    </form>-->
<!--                                    <label>-->
<!--                                        <input type="file" disabled>-->
<!--                                        <span class="btn attach disabled d-sm-block d-none"><i class="material-icons">attach_file</i></span>-->
<!--                                    </label>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Chat -->
                </div>
                <!-- End of Babble -->
            </div>
        </div>
    </div> <!-- Layout -->
</main>
<!-- Bootstrap/Swipe core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="js/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="js/vendor/popper.min.js"></script>
<script src="js/swipe.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>
    function scrollToBottom(el) { el.scrollTop = el.scrollHeight; }
    scrollToBottom(document.getElementById('content'));
</script>
<script>
    const baseURL = "http://localhost:8080/api";
    document.getElementById("langSelect").addEventListener("change", function () {
        const selectedLang = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("lang", selectedLang);
        window.location.href = currentUrl.toString();
    });
    document.addEventListener("DOMContentLoaded", function () {
        let username = sessionStorage.getItem("username");

        // if (username) {
        //     username = decodeURIComponent(username);
        // }

        if (!username) {
            console.error("No username found in sessionStorage.");
            return;
        }
        console.log("test: ",username);
        fetchUserIdByUsername(username);
    });

    function fetchUserIdByUsername(username) {
        const token = sessionStorage.getItem("token");
        console.log(username);
        fetch(`${baseURL}/users/username/${username}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch user ID");
                }
                console.log(response);
                return response.json();
            })
            .then(user => {
                if (!user || !user.userId) {
                    console.error("User not found or invalid response");
                    return;
                }
                sessionStorage.setItem("userId", user.userId);
                document.getElementById("firstName").value = user.firstName;
                document.getElementById("lastName").value = user.lastName;
                document.getElementById("email").value = user.email;
                document.getElementById("username").value = user.username;
                document.getElementById("password").value = "";
                console.log(user.userId);
                const profileName = `${user.firstName} ${user.lastName}`;
                const profileNameElement = document.querySelector(".profile h1");
                if (profileNameElement) {
                    profileNameElement.textContent = profileName;
                }
                const userImage = user.image ? user.image : "img/avatars/default-avatar.png";
                const avatarImages = document.querySelectorAll("img.avatar-xl");
                avatarImages.forEach(img => {
                    img.src = userImage;
                });
                fetchUserData(user.userId);
                fetchConversations(user.userId);
                // loadMessages(user.userId);
            })
            .catch(error => console.error("Error fetching user ID:", error));
    }

    function fetchUserData(userId) {
        const token = sessionStorage.getItem("token");
        console.log(userId);
        console.log(token);
        fetch(`${baseURL}/users/id/${userId}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch user data");
                }
                return response.json();
            })
            .then(data => {
                let contactsList = document.getElementById('contacts');
                contactsList.innerHTML = '';

                if (!data.contacts || data.contacts.length === 0) {
                    contactsList.innerHTML = "<p>No contacts found</p>";
                    return;
                }
                data.contacts.forEach(contact => {
                    let status = contact.status ? "online" : "offline";
                    let contactCard = `
                <a href="#" class="filterMembers all ${status} contact" data-toggle="list">
                    <img class="avatar-md" src="${contact.contactProfilePicture || 'img/avatars/default-avatar.png'}" data-toggle="tooltip" data-placement="top" title="${contact.contactFirstName}" alt="avatar">
                    <div class="status">
                        <i class="material-icons ${status}">fiber_manual_record</i>
                    </div>
                    <div class="data">
                        <h5>${contact.contactFirstName} ${contact.contactLastName}</h5>
                    </div>
                </a>
            `;
                    contactsList.innerHTML += contactCard;
                });
            })
            .catch(error => console.error("Error fetching user data:", error));
    }

    async function fetchConversations(userId) {
        const token = sessionStorage.getItem("token");
        console.log("Fetching conversations for user:", userId);
        console.log("Token:", token);

        try {
            const [conversationsRes, latestMessagesRes] = await Promise.all([
                fetch(`${baseURL}/conversations/user/${userId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                }),
                fetch(`${baseURL}/messages/latest/${userId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                })
            ]);

            if (!conversationsRes.ok || !latestMessagesRes.ok) {
                throw new Error("Failed to fetch conversations or messages");
            }

            const conversations = await conversationsRes.json();
            const latestMessages = await latestMessagesRes.json();

            const chatsList = document.getElementById('chats');
            chatsList.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                chatsList.innerHTML = "<p>No conversations found</p>";
                return;
            }

            const latestMessageMap = new Map();
            latestMessages.forEach(msg => {
                latestMessageMap.set(msg.conversation.id, msg);
            });

            conversations.forEach(conversation => {
                const latestMessage = latestMessageMap.get(conversation.id) || null;
                const latestTime = latestMessage ? formatTime(latestMessage.createdAt) : '';
                const latestText = latestMessage ? truncateText(latestMessage.messageText) : 'No messages yet...';
                const unreadCount = latestMessage && latestMessage.isRead === false && latestMessage.sender.id !== userId ? 1 : 0;
                const imageUrl = conversation.imageUrl || 'img/avatars/default-avatar.png';

                const chatCard = `
                <a href="#list-chat" class="filterDiscussions all single" data-toggle="list" role="tab"
                onclick="fetchMessages(${conversation.id}, ${userId}, '${conversation.name}'); console.log('${userId}')">
                    <img class="avatar-md" src="${imageUrl}" data-toggle="tooltip" data-placement="top" title="${conversation.name}" alt="avatar">
                    <div class="status">                        <i class="material-icons online">fiber_manual_record</i>
                    </div>
                    ${unreadCount > 0 ? `<div class="new bg-yellow"><span>+${unreadCount}</span></div>` : ''}
                    <div class="data">
                        <h5>${conversation.name}</h5>
                        <span style="color: black">${latestTime}</span>
                        <p style="color: black">${latestText}</p>
                    </div>
                </a>
            `;

                chatsList.insertAdjacentHTML('beforeend', chatCard);
                // fetchMessages(conversations.id, userId, conversation.name);
            });
            // $('[data-toggle="tooltip"]').tooltip();
            // if (conversations.length > 0) {
            //     await fetchMessages(conversations[0].id, userId, conversations[0].name);
            // }

        } catch (error) {
            console.error("Error fetching conversations or messages:", error);
            const chatsList = document.getElementById('chats');
            chatsList.innerHTML = "<p>Error loading conversations</p>";
        }
    }


    function formatTime(dateTimeString) {
        const date = new Date(dateTimeString);
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'pm' : 'am';
        const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
        return `${formattedHours}:${minutes.toString().padStart(2, '0')}${ampm} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear().toString().slice(-2)}`;
    }

    function truncateText(text, maxLength = 25) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function countUnreadMessages(messages, userId) {
        return messages.filter(m => m.isRead === false && m.sender.id !== userId).length;
    }

    async function fetchMessages(conversationId, userId, conversationName) {
        const token = sessionStorage.getItem("token");
        const content = document.getElementById("show-message");
        content.innerHTML = '';

        try {
            const response = await fetch(`${baseURL}/messages/conversation/${conversationId}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                }
            });

            if (!response.ok) {
                throw new Error("Failed to fetch messages");
            }

            const topConservation = document.getElementById("top");
            topConservation.innerHTML = `<div class="container">
                                <div class="col-md-12">
                                    <div class="inside">
                                        <div class="data">
                                            <h5><a href="#">${conversationName}</a></h5>
                                            <span th:text="#{status.online}">Active now</span>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <button class="dropdown-item" th:text="#{clear.history}"><i class="material-icons">clear</i>Clear History</button>
                                                <button class="dropdown-item" th:text="#{block.contact}"><i class="material-icons">block</i>Block Contact</button>
                                                <button class="dropdown-item" th:text="#{delete.contact}"><i class="material-icons">delete</i>Delete Contact</button>
                                                <button class="dropdown-item" th:text="#{rename}"><i class="material-icons">edit</i>Rename</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            const sendMessage = document.getElementById("send-message");
            sendMessage.innerHTML = `<form class="position-relative w-100">
                                        <textarea class="form-control" rows="1"></textarea>

                                        <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                                    </form>
                                    <label>
                                        <input type="file">
                                        <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                                    </label>`;
            const messages = await response.json();

            if (!messages || messages.length === 0) {
                content.innerHTML = "<p>No messages yet</p>";
                return;
            }

            messages.forEach(message => {
                const isOwnMessage = message.sender.id === userId;
                const time = formatTime(message.createdAt);
                console.log(message.sender.id, userId);
                if (isOwnMessage) {

                    //send message
                    const messageHTML = `
                                        <div class="message me" >
												<div class="text-main">
													<div class="text-group me align-items-center ml-2" >
                                                        <div class="dropdown ml-2" >
                                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="material-icons md-30">more_vert</i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <button class="dropdown-item" th:text="#{message.update}">Update</button>
                                                                <button class="dropdown-item" th:text="#{message.delete}">Delete</button>
                                                            </div>
                                                        </div>
														<div class="text me">
															<p>${escapeHtml(message.messageText)}</p>
														</div>
													</div>
													<span>${message.isread ? '<i class="material-icons">check</i>' : ''}${time}</span>
												</div>
											</div>
    `;
                    content.insertAdjacentHTML('beforeend', messageHTML);
                } else {
                    // Received Message
                    const messageHTML = `
                                <div class="message" >
												<div class="text-main">
													    <div class="text-group d-flex align-items-center mr-2" >
														<div class="text">
															<p>${escapeHtml(message.messageText)}</p>
														</div>
                                                        <div class="dropdown ml-2" >
                                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="material-icons md-30">more_vert</i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <button class="dropdown-item" th:text="#{message.update}">Update</button>
                                                                <button class="dropdown-item" th:text="#{message.delete}">Delete</button>
                                                            </div>
                                                        </div>
													</div>
													<span>${message.isread ? '<i class="material-icons">check</i>' : ''}${time}</span>
												</div>
											</div>
`;
                    content.insertAdjacentHTML('beforeend', messageHTML);
                }
            });

        } catch (error) {
            console.error("Error fetching messages:", error);
            content.innerHTML = "<p>Error loading messages</p>";
        }
    }
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;',
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function handleConversationClick(conversationId, userId, conversationName, isGroup = false) {
        console.log("Mở cuộc trò chuyện:", conversationId, conversationName, isGroup);
        
        // Lưu thông tin cuộc trò chuyện hiện tại
        currentConversationId = conversationId;
        if (!isGroup) {
            currentRecipientId = userId;
            currentRecipientUsername = conversationName;
        } else {
            currentRecipientId = null;
        }
        
        // Lấy ID người dùng hiện tại
        const currentUserId = sessionStorage.getItem('userId');
        
        // Tải tin nhắn
        console.log("Tải tin nhắn cho cuộc trò chuyện:", conversationId);
        fetchMessages(conversationId, currentUserId, conversationName, isGroup);
    }

    document.getElementById("change_profile").addEventListener("submit", function(event) {
        console.log("changeProfile called");
        event.preventDefault();
        const token = sessionStorage.getItem("token");
        const userId = sessionStorage.getItem("userId");
        const username = document.getElementById('username').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const update = {
            username,
            firstName,
            lastName,
            email
        };
        if (password && password.length > 8) {
            update.hashPassword = password;
        }
            fetch(`${baseURL}/users/update/${userId}`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(update),
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            }).then(update => {
                console.log(update);
                  sessionStorage.setItem("user", JSON.stringify(update));
                  updateProfileUI(update);
                  // document.getElementById("change_profile").reset();
                })
                .catch(error => console.log(error));
            console.log("this response from change profile");
    });

    function updateProfileUI(user) {
        document.getElementById("firstName").value = user.firstName;
        document.getElementById("lastName").value = user.lastName;
        document.getElementById("email").value = user.email;
        document.getElementById("username").value = user.username;
        document.getElementById("password").value = "";
        const profileHeader = document.querySelector(".profile h1");
        if (profileHeader) {
            profileHeader.textContent = `${user.firstName || ''} ${user.lastName || ''}`.trim();
        } else {
            console.error("Profile h1 element not found");
        }
    }


    // Biến toàn cục cho WebSocket
    let stompClient = null;
    let currentUsername = null;
    let currentUserId = null;
    let currentConversationId = null;
    let currentRecipientUsername = null;
    let currentRecipientId = null;
    let isConnected = false;

    // Kết nối WebSocket khi người dùng đã đăng nhập
    function connectWebSocket() {
        if (isConnected) {
            console.log("WebSocket đã được kết nối trước đó");
            return;
        }

        const token = sessionStorage.getItem('token');
        if (!token) {
            console.error("Không tìm thấy token, không thể kết nối WebSocket");
            return;
        }

        console.log("Đang kết nối tới WebSocket server...");
        // Kết nối WebSocket thuần theo cấu hình trong WebSocketConfig
        const socket = new WebSocket('ws://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        // Tắt log debug của STOMP để không làm rối console
        stompClient.debug = null;

        // Thêm header Authorization để server xác thực JWT token
        const headers = {
            'Authorization': 'Bearer ' + token
        };

        stompClient.connect(headers, onConnected, onError);
    }

    // Xử lý khi kết nối thành công
    function onConnected() {
        console.log("Kết nối WebSocket thành công!");
        isConnected = true;

        // Đăng ký nhận tin nhắn công khai (/topic/public)
        stompClient.subscribe('/topic/public', onPublicMessageReceived);

        // Đăng ký nhận tin nhắn riêng tư (/user/queue/private)
        stompClient.subscribe('/user/queue/private', onPrivateMessageReceived);

        // Lấy thông tin người dùng hiện tại từ sessionStorage
        currentUsername = sessionStorage.getItem('username');

        // Gửi tin nhắn JOIN khi kết nối thành công
        if (currentUsername) {
            const chatMessage = {
                sender: currentUsername,
                type: 'JOIN'
            };
            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
            console.log("Đã gửi tin nhắn JOIN cho: " + currentUsername);
        }

        // Đăng ký nhận tin nhắn nhóm nếu đang trong cuộc trò chuyện nhóm
        if (currentConversationId && currentConversationId !== 'public') {
            // Kiểm tra xem có phải là nhóm không
            const conversation = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
            if (conversation && conversation.dataset.isGroup === "true") {
                subscribeToGroupMessages(currentConversationId);
            }
        }
    }

    // Đăng ký nhận tin nhắn cho một nhóm cụ thể
    function subscribeToGroupMessages(groupId) {
        if (!isConnected || !stompClient) return;

        const subscription = stompClient.subscribe(`/topic/group.${groupId}`, onGroupMessageReceived);
        console.log(`Đã đăng ký nhận tin nhắn cho nhóm: ${groupId}`);
        return subscription;
    }

    // Xử lý khi có lỗi kết nối
    function onError(error) {
        console.error("Lỗi kết nối WebSocket:", error);
        isConnected = false;

        // Thử kết nối lại sau 5 giây
        setTimeout(function() {
            if (!isConnected) {
                console.log("Đang thử kết nối lại...");
                connectWebSocket();
            }
        }, 5000);
    }

    // Xử lý khi nhận tin nhắn công khai
    function onPublicMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn công khai:", message);

        // Hiển thị tin nhắn nếu đang xem kênh công khai
        if (currentConversationId === 'public') {
            displayMessage(message);
        }
    }

    // Xử lý khi nhận tin nhắn riêng tư
    function onPrivateMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn riêng tư:", message);

        // Kiểm tra cả hai chiều tin nhắn
        const isSenderCurrentRecipient = message.sender === currentRecipientUsername;
        const isMessageForCurrentUser = message.recipientId === currentUserId?.toString() || message.recipient === currentUsername;

        if (isSenderCurrentRecipient || isMessageForCurrentUser) {
            // Đánh dấu tin nhắn là từ người dùng hiện tại nếu sender là username hiện tại
            if (message.sender === currentUsername) {
                message.isMe = true;
            }
            displayMessage(message);

            // Đánh dấu tin nhắn đã đọc nếu đang xem hội thoại
            if (message.messageId) {
                markMessageAsRead(message.messageId);
            }
        }

        // Cập nhật UI khi nhận tin nhắn mới
        updateConversationList(message.sender);

        // Cập nhật số tin nhắn chưa đọc nếu không phải tin nhắn của mình
        if (message.sender !== currentUsername) {
            updateUnreadMessageCount(message.sender);
        }
    }

    // Xử lý khi nhận tin nhắn nhóm
    function onGroupMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn nhóm:", message);

        // Hiển thị tin nhắn nếu đang xem cuộc trò chuyện nhóm này
        const groupId = message.groupId || message.recipient; // Có thể lấy từ groupId hoặc recipient
        if (currentConversationId && currentConversationId.toString() === groupId.toString()) {
            displayMessage(message);
        } else {
            // Cập nhật số tin nhắn chưa đọc
            updateUnreadMessageCount(null, groupId);
        }
    }

    // Gửi tin nhắn
    function sendMessage(event) {
        if (event) {
            event.preventDefault();
        }

        if (!stompClient || !isConnected) {
            console.error("WebSocket chưa được kết nối. Đang kết nối lại...");
            connectWebSocket();
            setTimeout(sendMessage, 1000); // Thử lại sau 1 giây
            return;
        }

        const messageInput = document.getElementById('message-input');
        if (!messageInput || !messageInput.value.trim()) {
            return;
        }

        const messageContent = messageInput.value.trim();

        // Xác định loại tin nhắn: công khai, riêng tư hoặc nhóm
        let messageType = 'CHAT'; // Mặc định là công khai
        let destination = '/app/chat.sendMessage';

        // Chuẩn bị đối tượng tin nhắn với thông tin đầy đủ
        const chatMessage = {
            sender: currentUsername,
            senderId: currentUserId?.toString(),
            content: messageContent,
            type: messageType,
            timestamp: new Date().toISOString()
        };

        // Tin nhắn riêng tư
        if (currentRecipientId && currentConversationId !== 'public') {
            messageType = 'PRIVATE';
            destination = '/app/chat.private';
            chatMessage.type = messageType;
            chatMessage.recipientId = currentRecipientId.toString();
            chatMessage.recipient = currentRecipientUsername;
        }
        // Tin nhắn nhóm
        else if (currentConversationId && currentConversationId !== 'public') {
            const conversation = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
            if (conversation && conversation.dataset.isGroup === "true") {
                messageType = 'GROUP';
                destination = '/app/chat.group';
                chatMessage.type = messageType;
                // Đặt recipient để server xử lý như groupId
                chatMessage.recipient = currentConversationId.toString();
                chatMessage.groupId = parseInt(currentConversationId);
            }
        }

        console.log(`Gửi tin nhắn ${messageType} tới ${destination}:`, chatMessage);
        stompClient.send(destination, {}, JSON.stringify(chatMessage));

        // Hiển thị tin nhắn của mình ngay lập tức
        displayMessage({
            sender: currentUsername,
            content: messageContent,
            type: messageType,
            isMe: true // Đánh dấu là tin nhắn của mình
        });

        // Xóa nội dung input sau khi gửi
        messageInput.value = '';
    }

    // Hiển thị tin nhắn trên giao diện
    function displayMessage(message) {
        const messagesArea = document.getElementById('show-message');
        if (!messagesArea) return;

        const isFromMe = message.sender === currentUsername || message.isMe;

        if (message.type === 'JOIN') {
            // Hiển thị thông báo tham gia
            const joinElement = document.createElement('div');
            joinElement.className = 'message system';
            joinElement.innerHTML = `<p>${escapeHtml(message.sender)} đã tham gia cuộc trò chuyện</p>`;
            messagesArea.appendChild(joinElement);
        } else if (message.type === 'LEAVE') {
            // Hiển thị thông báo rời đi
            const leaveElement = document.createElement('div');
            leaveElement.className = 'message system';
            leaveElement.innerHTML = `<p>${escapeHtml(message.sender)} đã rời khỏi cuộc trò chuyện</p>`;
            messagesArea.appendChild(leaveElement);
        } else {
            // Hiển thị tin nhắn thông thường
            const messageElement = document.createElement('div');
            messageElement.className = isFromMe ? 'message me' : 'message';

            const now = new Date();
            const formattedTime = now.getHours().toString().padStart(2, '0') + ':' +
                                now.getMinutes().toString().padStart(2, '0');

            messageElement.innerHTML = `
                <div class="text-main">
                    <div class="text-group ${isFromMe ? 'me' : ''}">
                        <div class="text ${isFromMe ? 'me' : ''}">
                            <p>${escapeHtml(message.content)}</p>
                        </div>
                    </div>
                    <span>${formattedTime}</span>
                </div>
            `;

            messagesArea.appendChild(messageElement);
        }

        // Cuộn xuống tin nhắn mới nhất
        scrollToBottom(document.getElementById('content'));
    }

    // Cập nhật số lượng tin nhắn chưa đọc
    function updateUnreadMessageCount(username, groupId) {
        // Tìm conversation element tương ứng trong danh sách
        let conversationElement;

        if (username) {
            // Tìm theo tên người dùng
            conversationElement = document.querySelector(`.conversation[data-username="${username}"]`);
        } else if (groupId) {
            // Tìm theo ID nhóm
            conversationElement = document.querySelector(`.conversation[data-conversation-id="${groupId}"][data-is-group="true"]`);
        }

        if (conversationElement) {
            const unreadBadge = conversationElement.querySelector('.unread');
            if (unreadBadge) {
                let count = parseInt(unreadBadge.textContent || '0');
                count++;
                unreadBadge.textContent = count;
                unreadBadge.style.display = 'block';
            } else {
                // Tạo badge nếu chưa có
                const newBadge = document.createElement('div');
                newBadge.className = 'unread';
                newBadge.textContent = '1';
                conversationElement.querySelector('.data').appendChild(newBadge);
            }
        }
    }

    // Khởi tạo giao diện chat
    function initializeChatUI(conversationId, userId, name, isGroup = false) {
        currentConversationId = conversationId;
        currentRecipientId = isGroup ? null : userId;
        currentRecipientUsername = isGroup ? null : name;

        // Đăng ký nhận tin nhắn nhóm nếu cần
        if (isGroup && stompClient && isConnected) {
            subscribeToGroupMessages(conversationId);
        }

        // Khởi tạo UI chat
        const topElement = document.getElementById('top');
        if (topElement) {
            topElement.innerHTML = `
                <div class="container">
                    <div class="col-md-12">
                        <div class="inside">
                            <div class="data">
                                <h5><a href="#">${escapeHtml(name)}</a></h5>
                                <span>${isGroup ? 'Nhóm chat' : 'Trực tuyến'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        const sendMessageElement = document.getElementById('send-message');
        if (sendMessageElement) {
            sendMessageElement.innerHTML = `
                <form class="position-relative w-100" id="message-form">
                    <textarea id="message-input" class="form-control" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                    <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                </form>
                <label>
                    <input type="file">
                    <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                </label>
            `;

            // Thêm event listener để gửi tin nhắn
            const form = document.getElementById('message-form');
            if (form) {
                form.addEventListener('submit', sendMessage);
            }
        }
    }

    // Cập nhật fetchMessages để kết nối với WebSocket khi chuyển đổi hội thoại
    const originalFetchMessages = fetchMessages;
    fetchMessages = function(conversationId, userId, conversationName, isGroup = false) {
        originalFetchMessages(conversationId, userId, conversationName, isGroup);

        // Lưu thông tin người dùng và cuộc trò chuyện hiện tại
        currentUserId = userId;
        currentUsername = sessionStorage.getItem('username');

        // Khởi tạo giao diện chat
        initializeChatUI(conversationId, userId, conversationName, isGroup);

        // Kết nối WebSocket nếu chưa kết nối
        if (!isConnected) {
            connectWebSocket();
        }
    };

    // Kết nối WebSocket khi trang được tải
    document.addEventListener('DOMContentLoaded', function() {
        // Lấy thông tin người dùng và kết nối WebSocket
        const username = sessionStorage.getItem('username');
        if (username) {
            currentUsername = username;
            // Trì hoãn kết nối WebSocket để đảm bảo đã lấy được thông tin người dùng
            setTimeout(function() {
                connectWebSocket();
            }, 1000);
        }
    });

    // Cập nhật UI khi nhận tin nhắn mới
    function updateConversationList(senderUsername) {
        // Nếu tin nhắn từ người dùng không có trong danh sách, thêm họ vào
        const userId = currentUserId;
        if (userId) {
            // Cập nhật lại danh sách cuộc hội thoại để hiển thị tin nhắn mới nhất
            fetchConversations(userId).then(() => {
                console.log("Đã cập nhật danh sách cuộc hội thoại sau khi nhận tin nhắn mới");
            });
        }
    }

    // Đánh dấu tin nhắn đã đọc
    function markMessageAsRead(messageId) {
        fetch(`${baseURL}/messages/${messageId}/read`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + sessionStorage.getItem('token')
            }
        })
        .then(response => {
            if (response.ok) {
                console.log(`Đã đánh dấu tin nhắn ${messageId} là đã đọc`);
            }
        })
        .catch(error => console.error('Lỗi khi đánh dấu tin nhắn đã đọc:', error));
    }
</script>
</body>
</html>