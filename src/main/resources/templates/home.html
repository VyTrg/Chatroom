<!DOCTYPE html>
<!--<html lang="en" >-->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chatroom</title>
    <meta name="description" content="#">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap core CSS -->
<!--    		<link href="css/lib" type="text/css" rel="stylesheet">-->
    <!-- Swipe core CSS -->
<!--    <link href="/css/swipe.min.css" type="text/css" rel="stylesheet">-->
    <!-- Favicon -->
    <link rel="stylesheet" href="/css/lib/bootstrap.min.css">
    <link rel="stylesheet" href="/css/swipe.min.css">
<!--    <link href="img/favicon.png" type="image/png" rel="icon">-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js"></script>
    <style>
        p, a, i, h5, span, h1, h2, h3, h4, h5, h6 {
            text-decoration: none;
        }
        .tag-input-wrapper {
            padding: 0;
            border-radius: 8px;
            background-color: #f5f5f5;
            max-width: 600px;
            border: none;

            max-height: 150px;
            overflow-y: auto;
        }

        .tag-area {
            display: flex;
            flex-direction: column;  /* Mỗi thẻ nằm trên 1 dòng */
            gap: 10px;
        }

        .recipient-tag {
            display: flex;
            align-items: center;
            width: 80%;
            padding: 6px 10px;
            margin-left: 10px;
            border-radius: 20px;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .recipient-tag img.avatar-sm {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .recipient-tag h5 {
            margin: 0;
            font-size: 14px;
            margin-right: auto;
        }

        .recipient-tag button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
        }

        .tag-area input {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 6px;
            min-height: 50px;
            font-size: 14px;
            outline: none;
        }
        .alert {
            display: none;
            padding: 10px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: opacity 0.5s ease;
        }

        .alert.show {
            display: block;
            opacity: 1;
        }

        .alert.fade-out {
            opacity: 0;
        }

        .alert.warning {
            background-color: #f8d7da; /
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
<main>
    <div class="layout">

        <div class="navigation">
            <div class="container">
                <div class="inside">
<!--                    menu-->
                    <div class="nav nav-tab menu">
                        <button class="btn"><img class="avatar-xl" alt="avatar"></button>
                        <a href="#members" data-toggle="tab"><i class="material-icons">account_circle</i></a>
                        <a href="#discussions" data-toggle="tab" class="active"><i class="material-icons active">chat_bubble_outline</i></a>
                        <a href="#notifications" data-toggle="tab" class="f-grow1"><i class="material-icons">notifications_none</i></a>
<!--                        <button class="btn mode"><i class="material-icons">brightness_2</i></button>-->
                        <a href="#settings" data-toggle="tab"><i class="material-icons">settings</i></a>
                        <button class="btn power" onclick="visitPage();"><i class="material-icons">power_settings_new</i></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="container">
                <div class="col-md-12">
                    <div class="tab-content">
                        <div class="tab-pane fade" id="members">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="people">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons">search</i></button>
                                </form>
                                <button class="btn create" data-toggle="modal" data-target="#exampleModalCenter"><i class="material-icons">person_add</i></button>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterMembersBtn active show" data-toggle="list" data-filter="all" style="border: none" th:text="#{filter.all}">All</button>
                                <button class="btn filterMembersBtn" data-toggle="list" data-filter="online" style="border: none" th:text="#{filter.online}">Online</button>
                                <button class="btn filterMembersBtn" data-toggle="list" data-filter="offline" style="border: none" th:text="#{filter.offline}">Offline</button>
                            </div>
<!--                            contact list-->
                            <div class="contacts">
                                <h1 th:text="#{contacts}">Contacts</h1>
                                <div class="list-group" id="contacts" role="tablist">
<!--                                    <a href="#" class="filterMembers all online contact" data-toggle="list">-->
<!--                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons online">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5>Janette Dalton</h5>-->
<!--                                        </div>-->
<!--                                    </a>-->
                                </div>
                            </div>
                        </div>
<!--                        discussions-->
                        <div id="discussions" class="tab-pane fade active show">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="conversations">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons">search</i></button>
                                </form>
                                <button class="btn create" data-toggle="modal" data-target="#startnewchat"><i class="material-icons">create</i></button>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterDiscussionsBtn active show" data-toggle="list" data-filter="all" th:text="#{filter.all}">All</button>
                                <button class="btn filterDiscussionsBtn" data-toggle="list" data-filter="read" th:text="#{filter.read}">Read</button>
                                <button class="btn filterDiscussionsBtn" data-toggle="list" data-filter="unread" th:text="#{filter.unread}">Unread</button>
                            </div>
                            <div class="discussions">
                                <h1 th:text="#{discussions}">Discussions</h1>
                                <div class="list-group" id="chats" role="tablist">
<!--                                    <a href="#list-chat" class="filterDiscussions all unread single active" id="list-chat-list" data-toggle="list" role="tab">-->
<!--                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons online">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="new bg-yellow">-->
<!--                                             <span>+7</span>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5>Name</h5>-->
<!--                                            <span>Latest time here(format time & day: 11:00am 1/1/24)</span>-->
<!--                                            <p>Newest message here...</p>-->
<!--                                        </div>-->
<!--                                    </a>-->
                                </div>
                            </div>
                        </div>
                        <!-- End of Discussions -->
                        <!-- Start of Notifications -->
                        <div id="notifications" class="tab-pane fade">
                            <div class="search">
                                <form class="form-inline position-relative">
                                    <input type="search" class="form-control" id="notice">
                                    <button type="button" class="btn btn-link loop"><i class="material-icons filter-list">filter_list</i></button>
                                </form>
                            </div>
                            <div class="list-group sort">
                                <button class="btn filterNotificationsBtn active show" data-toggle="list" data-filter="all" th:text="#{filter.all}">All</button>
                                <button class="btn filterNotificationsBtn" data-toggle="list" data-filter="latest" th:text="#{filter.latest}">Latest</button>
                                <button class="btn filterNotificationsBtn" data-toggle="list" data-filter="oldest" th:text="#{filter.oldest}">Oldest</button>
                            </div>
                            <div class="notifications">
                                <h1 th:text="#{notifications}">Notifications</h1>
                                <div class="list-group" id="alerts" role="tablist">
                                    <a href="#" class="filterNotifications all latest notification" data-toggle="list">
                                        <img class="avatar-md" src="img/avatars/avatar-female-1.jpg" data-toggle="tooltip" data-placement="top" title="Janette" alt="avatar">
                                        <div class="status">
                                            <i class="material-icons online">fiber_manual_record</i>
                                        </div>
                                        <div class="data">
                                            <p>Janette has accepted your friend request on Swipe.</p>
                                            <span>Oct 17, 2018</span>
                                        </div>

                                    </a>
                                    <a href="#" class="filterNotifications all latest notification" data-toggle="list">
                                        <img class="avatar-md" src="img/avatars/avatar-male-1.jpg" data-toggle="tooltip" data-placement="top" title="Michael" alt="avatar">
                                        <div class="status">
                                            <i class="material-icons online">fiber_manual_record</i>
                                        </div>
                                        <div class="data">
                                            <p>Michael, you have a new friend suggestion today.</p>
                                            <span>Jun 21, 2018</span>
                                        </div>
                                        <button class="btn"><span class="material-icons">add</span></button>
                                        <button class="btn"><span class="material-icons">close</span></button>
                                    </a>

                                </div>
                            </div>
                        </div>
                        <!-- End of Notifications -->
                        <!-- Start of Settings -->
                        <div class="tab-pane fade" id="settings">
                            <div class="settings">
                                <div class="profile">
                                    <img class="avatar-xl" alt="avatar">
                                    <h1>Michael Knudsen</h1>
<!--                                    <span>Helena, Montana</span>-->
<!--                                    <div class="stats">-->
<!--                                        <div class="item">-->
<!--                                            <h2>122</h2>-->
<!--                                            <h3>Fellas</h3>-->
<!--                                        </div>-->
<!--                                        <div class="item">-->
<!--                                            <h2>305</h2>-->
<!--                                            <h3>Chats</h3>-->
<!--                                        </div>-->
<!--                                        <div class="item">-->
<!--                                            <h2>1538</h2>-->
<!--                                            <h3>Posts</h3>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                </div>
                                <div class="categories" id="accordionSettings">
                                    <h1 th:text="#{settings}">Settings</h1>
                                    <!-- Start of My Account -->
                                    <div class="category">
                                        <a href="#" class="title collapsed" id="headingOne" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            <i class="material-icons md-30 online">person_outline</i>
                                            <div class="data">
                                                <h5 th:text="#{myaccount}">My Account</h5>
                                                <p th:text="#{myaccount.setting}">Update your profile details</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                        <div class="collapse" id="collapseOne" aria-labelledby="headingOne" data-parent="#accordionSettings">
                                            <div class="content">
                                                <div class="upload">
                                                    <div class="data">
                                                        <img class="avatar-xl" alt="image">
                                                        <label>
                                                            <input type="file" id="uploadInput" style="display: none;">
                                                            <span class="btn button" th:text="#{upload.avatar}" id="uploadBtn">Upload avatar</span>
                                                        </label>
                                                    </div>
                                                    <p th:text="#{avatar.content}">For best results, use an image at least 256px by 256px in either .jpg or .png format!</p>
                                                </div>
                                                <form id="change_profile" >
                                                    <div class="parent">
                                                        <div class="field">
                                                            <label for="firstName" th:text="#{first.name}">First name <span>*</span></label>
                                                            <input type="text" class="form-control" id="firstName" placeholder="First name" required>
                                                        </div>
                                                        <div class="field">
                                                            <label for="lastName" th:text="#{last.name}">Last name <span>*</span></label>
                                                            <input type="text" class="form-control" id="lastName" placeholder="Last name" required>
                                                        </div>
                                                    </div>
                                                    <div class="field">
                                                        <label for="email" th:text="#{setting.email}">Email <span>*</span></label>
                                                        <input type="email" class="form-control" id="email" placeholder="Enter your email address" required>
                                                    </div>
                                                    <div class="field">
                                                        <label for="username" th:text="#{setting.username}">Username <span>*</span></label>
                                                        <input class="form-control" id="username" placeholder="Enter your username" required>
                                                    </div>
                                                    <div class="field">
                                                        <label for="password" th:text="#{setting.password}">Password</label>
                                                        <input type="password" class="form-control" id="password" th:placeholder='#{password.content}'>
                                                    </div>
<!--                                                    <div class="field">-->
<!--                                                        <label for="location">Location</label>-->
<!--                                                        <input type="text" class="form-control" id="location" placeholder="Enter your location" value="Helena, Montana" required>-->
<!--                                                    </div>-->
                                                    <button class="btn btn-link w-100" th:text="#{delete.account}">Delete Account</button>
                                                    <button type="submit" class="btn button w-100" th:text="#{apply}">Apply</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End of My Account -->
                                    <!-- Start of Chat History -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingTwo" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">-->
<!--                                            <i class="material-icons md-30 online">mail_outline</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Chats</h5>-->
<!--                                                <p>Check your chat history</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseTwo" aria-labelledby="headingTwo" data-parent="#accordionSettings">-->
<!--                                            <div class="content layer">-->
<!--                                                <div class="history">-->
<!--                                                    <p>When you clear your conversation history, the messages will be deleted from your own device.</p>-->
<!--                                                    <p>The messages won't be deleted or cleared on the devices of the people you chatted with.</p>-->
<!--                                                    <div class="custom-control custom-checkbox">-->
<!--                                                        <input type="checkbox" class="custom-control-input" id="same-address">-->
<!--                                                        <label class="custom-control-label" for="same-address">Hide will remove your chat history from the recent list.</label>-->
<!--                                                    </div>-->
<!--                                                    <div class="custom-control custom-checkbox">-->
<!--                                                        <input type="checkbox" class="custom-control-input" id="save-info">-->
<!--                                                        <label class="custom-control-label" for="save-info">Delete will remove your chat history from the device.</label>-->
<!--                                                    </div>-->
<!--                                                    <button type="submit" class="btn button w-100">Clear blah-blah</button>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Chat History -->
                                    <!-- Start of Notifications Settings -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingThree" data-toggle="collapse" data-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">-->
<!--                                            <i class="material-icons md-30 online">notifications_none</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Notifications</h5>-->
<!--                                                <p>Turn notifications on or off</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseThree" aria-labelledby="headingThree" data-parent="#accordionSettings">-->
<!--                                            <div class="content no-layer">-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Desktop Notifications</h5>-->
<!--                                                        <p>You can set up Swipe to receive notifications when you have new messages.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Unread Message Badge</h5>-->
<!--                                                        <p>If enabled shows a red badge on the Swipe app icon when you have unread messages.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Taskbar Flashing</h5>-->
<!--                                                        <p>Flashes the Swipe app on mobile in your taskbar when you have new notifications.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Notification Sound</h5>-->
<!--                                                        <p>Set the app to alert you via notification sound when you have unread messages.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Vibrate</h5>-->
<!--                                                        <p>Vibrate when receiving new messages (Ensure system vibration is also enabled).</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Turn On Lights</h5>-->
<!--                                                        <p>When someone send you a text message you will receive alert via notification light.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingFour" data-toggle="collapse" data-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">-->
<!--                                            <i class="material-icons md-30 online">sync</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Connections</h5>-->
<!--                                                <p>Sync your social accounts</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseFour" aria-labelledby="headingFour" data-parent="#accordionSettings">-->
<!--                                            <div class="content">-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/slack.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Skrill</h5>-->
<!--                                                        <p>Read, Write, Comment</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/dropbox.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Dropbox</h5>-->
<!--                                                        <p>Read, Write, Upload</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/drive.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Google Drive</h5>-->
<!--                                                        <p>No permissions set</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="app">-->
<!--                                                    <img src="img/integrations/trello.svg" alt="app">-->
<!--                                                    <div class="permissions">-->
<!--                                                        <h5>Trello</h5>-->
<!--                                                        <p>No permissions set</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Connections -->
                                    <!-- Start of Appearance Settings -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingFive" data-toggle="collapse" data-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">-->
<!--                                            <i class="material-icons md-30 online">colorize</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Appearance</h5>-->
<!--                                                <p>Customize the look of Swipe</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseFive" aria-labelledby="headingFive" data-parent="#accordionSettings">-->
<!--                                            <div class="content no-layer">-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Turn Off Lights</h5>-->
<!--                                                        <p>The dark mode is applied to core areas of the app that are normally displayed as light.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round mode"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Appearance Settings -->
                                    <!-- Start of Language -->
                                    <div class="category">
                                        <a href="#" class="title collapsed" id="headingSix" data-toggle="collapse" data-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
                                            <i class="material-icons md-30 online">language</i>
                                            <div class="data">
                                                <h5 th:text="#{language}">Language</h5>
                                                <p th:text="#{language.setting}">Select preferred language</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                        <div class="collapse" id="collapseSix" aria-labelledby="headingSix" data-parent="#accordionSettings">
                                            <div class="content layer">
                                                <div class="language">

                                                    <select class="custom-select" id="langSelect" required>
                                                        <option value="en" th:text="#{english}" th:selected="${#locale.language == 'en'}">English</option>
                                                        <option value="vi" th:text="#{vietnamese}" th:selected="${#locale.language == 'vi'}">Vietnamese</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- End of Language -->
                                    <!-- Start of Privacy & Safety -->
<!--                                    <div class="category">-->
<!--                                        <a href="#" class="title collapsed" id="headingSeven" data-toggle="collapse" data-target="#collapseSeven" aria-expanded="true" aria-controls="collapseSeven">-->
<!--                                            <i class="material-icons md-30 online">lock_outline</i>-->
<!--                                            <div class="data">-->
<!--                                                <h5>Privacy & Safety</h5>-->
<!--                                                <p>Control your privacy settings</p>-->
<!--                                            </div>-->
<!--                                            <i class="material-icons">keyboard_arrow_right</i>-->
<!--                                        </a>-->
<!--                                        <div class="collapse" id="collapseSeven" aria-labelledby="headingSeven" data-parent="#accordionSettings">-->
<!--                                            <div class="content no-layer">-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Keep Me Safe</h5>-->
<!--                                                        <p>Automatically scan and delete direct messages you receive from everyone that contain explict content.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>My Friends Are Nice</h5>-->
<!--                                                        <p>If enabled scans direct messages from everyone unless they are listed as your friend.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Everyone can add me</h5>-->
<!--                                                        <p>If enabled anyone in or out your friends of friends list can send you a friend request.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Friends of Friends</h5>-->
<!--                                                        <p>Only your friends or your mutual friends will be able to send you a friend reuqest.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox" checked>-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Data to Improve</h5>-->
<!--                                                        <p>This settings allows us to use and process information for analytical purposes.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                                <div class="set">-->
<!--                                                    <div class="details">-->
<!--                                                        <h5>Data to Customize</h5>-->
<!--                                                        <p>This settings allows us to use your information to customize Swipe for you.</p>-->
<!--                                                    </div>-->
<!--                                                    <label class="switch">-->
<!--                                                        <input type="checkbox">-->
<!--                                                        <span class="slider round"></span>-->
<!--                                                    </label>-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
                                    <!-- End of Privacy & Safety -->
                                    <!-- Start of Logout -->
                                    <div class="category">
                                        <a href="javascript:void(0)" class="title collapsed" id="logout">
                                            <i class="material-icons md-30 online">power_settings_new</i>
                                            <div class="data">
                                                <h5>Power Off</h5>
                                                <p>Log out of your account</p>
                                            </div>
                                            <i class="material-icons">keyboard_arrow_right</i>
                                        </a>
                                    </div>
                                    <!-- End of Logout -->
                                </div>
                            </div>
                        </div>
                        <!-- End of Settings -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Sidebar -->
        <!-- Start of Add Friends -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1 th:text="#{add.friend.title}">Add your friends</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="newFriend">
                            <div class="form-group user-tag">
                                <div id="alert-message1" class="alert"></div>
                                <label for="user" th:text="#{add.friend}">Email/Username</label>
                                <input type="text" class="form-control" id="user" required>
                            </div>
                            <div class="tag-area tag-input-wrapper user-tag" id="userTag">
<!--                                <label for="welcome" th:text="#{add.friend.message}">Message:</label>-->
<!--                                <textarea class="text-control" id="welcome"></textarea>-->
                            </div>
                            <button type="submit" class="btn button w-100" th:text="#{add.friend.send}">Send Friend Request</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Add Friends -->
        <!-- Start of Create Chat -->
        <div class="modal fade" id="startnewchat" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="requests">
                    <div class="title">
                        <h1 th:text="#{converstaion.title}">Start new chat</h1>
                        <button type="button" class="btn" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button>
                    </div>
                    <div class="content">
                        <form id="groupchat">
                            <div class="form-group ">

                                <label for="participant" th:text="#{recipient}">Recipients:</label>
                                <div id="alert-message2" class="alert" ></div>
                                <div id="recipient-list" class="tag-area tag-input-wrapper">
                                    <input type="text" class="form-control" id="participant">


                                </div>
                            </div>
                            <div class="form-group">
                                <label for="topic" th:text="#{topic}">Topic:</label>
                                <input type="text" class="form-control" id="topic" required>
                            </div>
<!--                            <div class="form-group">-->
<!--                                <label for="message" th:text="#{add.friend.message}">Message:</label>-->
<!--                                <textarea class="text-control" id="message"></textarea>-->
<!--                            </div>-->
                            <button type="submit" class="btn button w-100" th:text="#{start.conversation}">Start New Chat</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Create Chat -->
        <div class="main">
            <div class="tab-content" id="nav-tabContent">
                <!-- Start of Babble -->
                <div class="babble tab-pane fade active show" id="list-chat" role="tabpanel" aria-labelledby="list-chat-list">
                    <!-- Start of Chat -->
                    <div class="chat" id="chat">
                        <div class="top" id="top">
                        </div>
                        <div class="content" id="content">
                            <div class="container">
                            <div class="col-md-12" id="show-message" ></div>
                            </div>
                        </div>
                        <div class="container">
                            <div class="col-md-12">
                                <div class="bottom" id="send-message">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End of Chat -->
                    <!-- Start of Call -->
<!--                    <div class="call" id="call1">-->
<!--                        <div class="content">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <div class="panel">-->
<!--                                            <div class="participant">-->
<!--                                                <img class="avatar-xxl" src="img/avatars/avatar-female-5.jpg" alt="avatar">-->
<!--                                                <span>Connecting</span>-->
<!--                                            </div>-->
<!--                                            <div class="options">-->
<!--                                                <button class="btn option"><i class="material-icons md-30">mic</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">videocam</i></button>-->
<!--                                                <button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">person_add</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">volume_up</i></button>-->
<!--                                            </div>-->
<!--                                            <button class="btn back" name="1"><i class="material-icons md-24">chat</i></button>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Call -->
                </div>
                <!-- End of Babble -->
                <!-- Start of Babble -->
                <div class="babble tab-pane fade" id="list-empty" role="tabpanel" aria-labelledby="list-empty-list">
                    <!-- Start of Chat -->
<!--                    <div class="chat" id="chat2">-->
<!--                        <div class="top">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <a href="#"><img class="avatar-md" src="img/avatars/avatar-female-2.jpg" data-toggle="tooltip" data-placement="top" title="Lean" alt="avatar"></a>-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons offline">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5><a href="#">Lean Avent</a></h5>-->
<!--                                            <span>Inactive</span>-->
<!--                                        </div>-->
<!--                                        <button class="btn connect d-md-block d-none" name="2"><i class="material-icons md-30">phone_in_talk</i></button>-->
<!--                                        <button class="btn connect d-md-block d-none" name="2"><i class="material-icons md-36">videocam</i></button>-->
<!--                                        <button class="btn d-md-block d-none"><i class="material-icons md-30">info</i></button>-->
<!--                                        <div class="dropdown">-->
<!--                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>-->
<!--                                            <div class="dropdown-menu dropdown-menu-right">-->
<!--                                                <button class="dropdown-item connect" name="2"><i class="material-icons">phone_in_talk</i>Voice Call</button>-->
<!--                                                <button class="dropdown-item connect" name="2"><i class="material-icons">videocam</i>Video Call</button>-->
<!--                                                <hr>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="content empty">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="no-messages">-->
<!--                                        <i class="material-icons md-48">forum</i>-->
<!--                                        <p>Seems people are shy to start the chat. Break the ice send the first message.</p>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="container">-->
<!--                            <div class="col-md-12">-->
<!--                                <div class="bottom">-->
<!--                                    <form class="position-relative w-100">-->
<!--                                        <textarea class="form-control" placeholder="Start typing for reply..." rows="1"></textarea>-->
<!--&lt;!&ndash;                                        <button class="btn emoticons"><i class="material-icons">insert_emoticon</i></button>&ndash;&gt;-->
<!--                                        <button type="submit" class="btn send"><i class="material-icons">send</i></button>-->
<!--                                    </form>-->
<!--                                    <label>-->
<!--                                        <input type="file">-->
<!--                                        <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>-->
<!--                                    </label>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Chat -->
                    <!-- Start of Call -->
<!--                    <div class="call" id="call2">-->
<!--                        <div class="content">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <div class="panel">-->
<!--                                            <div class="participant">-->
<!--                                                <img class="avatar-xxl" src="img/avatars/avatar-female-2.jpg" alt="avatar">-->
<!--                                                <span>Connecting</span>-->
<!--                                            </div>-->
<!--                                            <div class="options">-->
<!--                                                <button class="btn option"><i class="material-icons md-30">mic</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">videocam</i></button>-->
<!--                                                <button class="btn option call-end"><i class="material-icons md-30">call_end</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">person_add</i></button>-->
<!--                                                <button class="btn option"><i class="material-icons md-30">volume_up</i></button>-->
<!--                                            </div>-->
<!--                                            <button class="btn back" name="2"><i class="material-icons md-24">chat</i></button>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Call -->
                </div>
                <!-- End of Babble -->
                <!-- Start of Babble -->
                <div class="babble tab-pane fade" id="list-request" role="tabpanel" aria-labelledby="list-request-list">
                    <!-- Start of Chat -->
<!--                    <div class="chat" id="chat3">-->
<!--                        <div class="top">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="inside">-->
<!--                                        <a href="#"><img class="avatar-md" src="img/avatars/avatar-female-6.jpg" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>-->
<!--                                        <div class="status">-->
<!--                                            <i class="material-icons offline">fiber_manual_record</i>-->
<!--                                        </div>-->
<!--                                        <div class="data">-->
<!--                                            <h5><a href="#">Louis Martinez</a></h5>-->
<!--                                            <span>Inactive</span>-->
<!--                                        </div>-->
<!--                                        <button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-30">phone_in_talk</i></button>-->
<!--                                        <button class="btn disabled d-md-block d-none" disabled><i class="material-icons md-36">videocam</i></button>-->
<!--                                        <button class="btn d-md-block disabled d-none" disabled><i class="material-icons md-30">info</i></button>-->
<!--                                        <div class="dropdown">-->
<!--                                            <button class="btn disabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled><i class="material-icons md-30">more_vert</i></button>-->
<!--                                            <div class="dropdown-menu dropdown-menu-right">-->
<!--                                                <button class="dropdown-item"><i class="material-icons">phone_in_talk</i>Voice Call</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">videocam</i>Video Call</button>-->
<!--                                                <hr>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">clear</i>Clear History</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">block</i>Block Contact</button>-->
<!--                                                <button class="dropdown-item"><i class="material-icons">delete</i>Delete Contact</button>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="content empty">-->
<!--                            <div class="container">-->
<!--                                <div class="col-md-12">-->
<!--                                    <div class="no-messages request">-->
<!--                                        <a href="#"><img class="avatar-xl" src="img/avatars/avatar-female-6.jpg" data-toggle="tooltip" data-placement="top" title="Louis" alt="avatar"></a>-->
<!--                                        <h5>Louis Martinez would like to add you as a contact. <span>Hi Keith, I'd like to add you as a contact.</span></h5>-->
<!--                                        <div class="options">-->
<!--                                            <button class="btn button"><i class="material-icons">check</i></button>-->
<!--                                            <button class="btn button"><i class="material-icons">close</i></button>-->
<!--                                        </div>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="container">-->
<!--                            <div class="col-md-12">-->
<!--                                <div class="bottom">-->
<!--                                    <form class="position-relative w-100">-->
<!--                                        <textarea class="form-control" placeholder="Messaging unavailable" rows="1" disabled></textarea>-->
<!--                                        <button class="btn emoticons disabled" disabled><i class="material-icons">insert_emoticon</i></button>-->
<!--                                        <button class="btn send disabled" disabled><i class="material-icons">send</i></button>-->
<!--                                    </form>-->
<!--                                    <label>-->
<!--                                        <input type="file" disabled>-->
<!--                                        <span class="btn attach disabled d-sm-block d-none"><i class="material-icons">attach_file</i></span>-->
<!--                                    </label>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
                    <!-- End of Chat -->
                </div>
                <!-- End of Babble -->
            </div>
        </div>
    </div> <!-- Layout -->
</main>
<!-- Bootstrap/Swipe core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="js/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="js/vendor/popper.min.js"></script>
<script src="js/swipe.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>
    // const alertMessage = document.getElementsByClassName('alert-message');
    function showAlert(message, alertDiv, type = 'warning') {
        const alertMessage = document.getElementById(alertDiv);
        alertMessage.textContent = message;

        // Remove any existing type classes
        alertMessage.classList.remove('warning', 'success');

        // Add the appropriate type class
        alertMessage.classList.add(type);

        // Show the alert
        alertMessage.classList.add('show');
        alertMessage.classList.remove('fade-out');

        // Automatically hide the alert after 3 seconds
        setTimeout(() => {
            alertMessage.classList.add('fade-out');
            setTimeout(() => {
                alertMessage.classList.remove('show', type);
                alertMessage.textContent = '';
            }, 500); // Match the CSS transition duration
        }, 3000);
    }

    function scrollToBottom(el) { 
        if (!el) {
            // Nếu không có phần tử được truyền vào, thử lấy phần tử content
            el = document.getElementById('content');
            console.log("Không có phần tử để cuộn, thử lấy phần tử 'content'");
            
            // Nếu vẫn không tìm thấy
            if (!el) {
                console.error("Không thể cuộn: không tìm thấy phần tử");
                return;
            }
        }
        
        try {
            // Đảm bảo cuộn đến cuối
            const scrollHeight = el.scrollHeight;
            el.scrollTop = scrollHeight;
            console.log("Đã cuộn xuống tin nhắn mới nhất, scrollHeight:", scrollHeight);
        } catch (error) {
            console.error("Lỗi khi cuộn xuống:", error);
        }
    }
    // Biến toàn cục cho WebSocket
    let stompClient = null;
    let currentUsername = null;
    let currentUserId = null;
    let currentConversationId = null;
    let currentRecipientUsername = null;
    let currentRecipientId = null;
    let isConnected = false;
    let isGroupConversation = false; // Cờ để xác định cuộc trò chuyện hiện tại là nhóm hay không
    let messageSubscriptions = {}; // Store subscriptions for cleanup
    const baseURL = "http://localhost:8080/api";

    // Kết nối WebSocket khi người dùng đã đăng nhập
    function connectWebSocket() {
        if (isConnected && stompClient && stompClient.connected) {
            console.log("WebSocket đã được kết nối trước đó");
            return;
        }

        const token = sessionStorage.getItem("token");
        if (!token) {
            console.error("Không tìm thấy token, không thể kết nối WebSocket");
            return;
        }

        console.log("Đang kết nối tới WebSocket server...");
        // Kết nối WebSocket thuần theo cấu hình trong WebSocketConfig
        const socket = new WebSocket('ws://localhost:8080/ws');
        
        // Thêm sự kiện theo dõi trạng thái kết nối WebSocket
        socket.onopen = function() {
            console.log("WebSocket Socket đã mở");
        };
        socket.onerror = function(error) {
            console.error("Lỗi WebSocket Socket:", error);
        };
        socket.onclose = function(event) {
            console.log("WebSocket Socket đã đóng:", event);
            // Thử kết nối lại sau 5 giây nếu đóng không phải do chủ ý
            if (!event.wasClean) {
                setTimeout(reconnectWebSocket, 5000);
            }
        };
        
        stompClient = Stomp.over(socket);

        // Bật log debug của STOMP để xem chi tiết gói tin
        stompClient.debug = function(str) {
            // Chỉ log các tin nhắn quan trọng để tránh quá nhiều log
            if (str.includes("CONNECTED") || str.includes("SUBSCRIBE") || str.includes("ERROR") || str.includes("DISCONNECT")) {
                console.log("STOMP: " + str);
            }
        };

        // Thêm header Authorization để server xác thực JWT token
        const headers = {
            'Authorization': 'Bearer ' + token
        };

        console.log("Đang kết nối STOMP với headers:", headers);
        stompClient.connect(headers, onConnected, onError);
    }

    // Xử lý khi kết nối thành công
    function onConnected() {
        console.log("Kết nối WebSocket thành công!");
        isConnected = true;

        // Đăng ký nhận tin nhắn công khai (/topic/public)
        messageSubscriptions.public = stompClient.subscribe('/topic/public', onPublicMessageReceived);

        // Đăng ký nhận tin nhắn riêng tư (/user/queue/private)
        messageSubscriptions.private = stompClient.subscribe('/user/queue/private', onPrivateMessageReceived);


        // Lấy thông tin người dùng hiện tại từ sessionStorage
        currentUsername = sessionStorage.getItem('username');
        messageSubscriptions.private = stompClient.subscribe('/user/queue/private', onPrivateMessageReceived);
        // Lấy ID người dùng hiện tại từ sessionStorage
        const userData = JSON.parse(sessionStorage.getItem('user'));
        if (userData && userData.id) {
            currentUserId = userData.id;

            // Cập nhật UI với thông tin người dùng
            updateProfileUI(userData);
            
            // Tải danh sách cuộc trò chuyện
            fetchConversations(currentUserId);
            
            // Gửi tin nhắn JOIN khi kết nối thành công
            if (currentUsername) {
                const chatMessage = {
                    sender: currentUsername,
                    senderId: currentUserId?.toString(),
                    type: 'JOIN'
                };
                stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
                console.log("Đã gửi tin nhắn JOIN cho: " + currentUsername);
            }

            // Đăng ký nhận tin nhắn nhóm nếu đang trong cuộc trò chuyện nhóm
            if (currentConversationId && currentConversationId !== 'public') {
                // Kiểm tra xem có phải là nhóm không
                const conversation = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
                if (conversation && conversation.dataset.isGroup === "true") {
                    subscribeToGroupMessages(currentConversationId);
                }
            }
            
            // Thiết lập cơ chế ping-pong để giữ kết nối WebSocket
            startHeartbeat();
            setTimeout(() => {
                const groupElements = document.querySelectorAll('[data-is-group="true"]');
                if (groupElements.length > 0) {
                    console.log(`Tìm thấy ${groupElements.length} nhóm, đăng ký nhận tin nhắn`);
                    groupElements.forEach(el => {
                        const groupId = el.dataset.conversationId;
                        if (groupId) {
                            console.log(`Đăng ký nhận tin nhắn cho nhóm: ${groupId}`);
                            subscribeToGroupMessages(groupId);
                        }
                    });
                }
            }, 1000); // Chờ 1 giây để đảm bảo cuộc trò chuyện đã được tải
        } else {
            console.error("Không thể lấy thông tin người dùng từ sessionStorage");
        }
    }

    // Xử lý lỗi kết nối
    function onError(error) {
        console.error("Lỗi kết nối WebSocket:", error);
        isConnected = false;

        // Hiển thị thông báo lỗi cho người dùng
        const errorElement = document.getElementById('message-error');
        if (errorElement) {
            errorElement.textContent = "Không thể kết nối đến máy chủ. Đang thử kết nối lại...";
            errorElement.style.display = 'block';
        }

        // Thử kết nối lại sau 5 giây
        setTimeout(reconnectWebSocket, 5000);
    }

    // Thiết lập heartbeat để giữ kết nối WebSocket luôn mở
    function startHeartbeat() {
        // Gửi heartbeat mỗi 25 giây (thấp hơn timeout 30s thông thường của nhiều server)
        const heartbeatInterval = setInterval(() => {
            if (stompClient && stompClient.connected) {
                stompClient.send('/app/chat.heartbeat', {}, JSON.stringify({
                    sender: currentUsername,
                    type: MessageType.HEARTBEAT
                }));
                console.log("Đã gửi heartbeat");
            } else {
                clearInterval(heartbeatInterval);
                reconnectWebSocket();
            }
        }, 25000);
        
        // Lưu interval vào window để có thể xóa khi cần
        window.heartbeatInterval = heartbeatInterval;
    }
    
    // Hàm kết nối lại WebSocket
    function reconnectWebSocket() {
        if (stompClient) {
            try {
                stompClient.disconnect();
            } catch (e) {
                console.error("Lỗi khi ngắt kết nối WebSocket:", e);
            }
        }
        isConnected = false;
        stompClient = null;
        
        // Xóa tất cả subscriptions đã lưu
        messageSubscriptions = {};
        
        // Kết nối lại sau 2 giây
        setTimeout(connectWebSocket, 2000);
    }

    // Đăng ký nhận tin nhắn cho một nhóm cụ thể
    function subscribeToGroupMessages(groupId) {
        if (!isConnected || !stompClient) {
            console.error("Không thể đăng ký nhóm: WebSocket chưa kết nối");
            return;
        }

        // Kiểm tra nếu đã đăng ký trước đó thì không đăng ký lại
        if (messageSubscriptions[`group_${groupId}`]) {
            console.log(`Đã đăng ký nhận tin nhắn cho nhóm: ${groupId} trước đó`);
            return messageSubscriptions[`group_${groupId}`];
        }

        // Quan trọng: Đảm bảo định dạng topic khớp với định dạng server đang sử dụng
        const groupTopic = `/topic/group.${groupId}`;
        console.log(`Đăng ký nhóm với ID: ${groupId}, path=${groupTopic}`);
        
        try {
            const subscription = stompClient.subscribe(groupTopic, function(payload) {
                console.log(`NHẬN TIN NHẮN NHÓM từ ${groupTopic}:`, payload);
                onGroupMessageReceived(payload);
            });
            console.log(` ĐÃ ĐĂNG KÝ THÀNH CÔNG nhận tin nhắn cho nhóm: ${groupId}`);

            // Lưu subscription để có thể hủy đăng ký khi cần
            messageSubscriptions[`group_${groupId}`] = subscription;
            
            // Gửi tin nhắn test để kiểm tra kết nối (chỉ log, không gửi thực)
            console.log(`Muốn gửi tin nhắn đến nhóm, sử dụng destination: /app/chat.group`);
            
            // In ra danh sách đăng ký hiện tại
            console.log(`Danh sách đăng ký hiện tại:`, Object.keys(messageSubscriptions));
            
            return subscription;
        } catch (error) {
            console.error(` LỖI khi đăng ký nhóm ${groupId}:`, error);
        }
    }
    
    // Xử lý khi nhận tin nhắn công khai
    function onPublicMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn công khai:", message);

        // Hiển thị tin nhắn nếu đang xem kênh công khai
        if (currentConversationId === 'public') {
            displayMessage(message);
        }
    }

    // Xử lý khi nhận tin nhắn riêng tư
    function onPrivateMessageReceived(payload) {
        try {
            const message = JSON.parse(payload.body);
            if (message.type === "FRIEND_REQUEST" || message.type === "GROUP_REQUEST") {
                console.log('test here');
               fetchNotifications(sessionStorage.getItem('userId'));
            }
            console.log("Tin nhắn riêng tư nhận được:", message);
            console.log('test here1');
            // Kiểm tra xem tin nhắn có phải từ người gửi hiện tại không
            const isFromCurrentSender = message.sender === currentUsername || message.senderId === currentUserId?.toString();
            
            // Kiểm tra xem tin nhắn có phải cho cuộc trò chuyện hiện tại không
            // Thêm kiểm tra thông qua conversationId (nếu có)
            let isForCurrentConversation = false;
            
            if (message.conversationId && currentConversationId) {
                // Nếu có conversationId, kiểm tra trực tiếp
                isForCurrentConversation = message.conversationId.toString() === currentConversationId.toString();
                console.log("Kiểm tra theo conversationId:", message.conversationId, currentConversationId, isForCurrentConversation);
            }
            
            // Nếu không có conversationId hoặc không khớp, kiểm tra theo senderId và recipientId
            if (!isForCurrentConversation) {
                isForCurrentConversation = 
                    (message.senderId === currentRecipientId && message.recipientId === currentUserId?.toString()) || 
                    (message.recipientId === currentRecipientId && message.senderId === currentUserId?.toString());
                console.log("Kiểm tra theo người gửi/nhận:", isForCurrentConversation);
            }
            
            // Thêm log để debug
            console.log("Thông tin tin nhắn:", {
                messageConvId: message.conversationId,
                currentConvId: currentConversationId,
                messageSenderId: message.senderId,
                messageRecipientId: message.recipientId,
                currentRecipientId: currentRecipientId,
                currentUserId: currentUserId,
                isForCurrentConversation: isForCurrentConversation
            });
            
            // Cập nhật UI danh sách cuộc trò chuyện
            if (!isFromCurrentSender) {
                updateConversationList(message.sender);
                
                // Hiển thị thông báo nếu tin nhắn không phải đang trong cuộc trò chuyện hiện tại
                if (!isForCurrentConversation && Notification.permission === 'granted') {
                    new Notification('Tin nhắn mới', {
                        body: `${message.sender}: ${message.content}`
                    });
                }
            }
            
            // Nếu là tin nhắn trong cuộc trò chuyện hiện tại, hiển thị ngay
            if (isForCurrentConversation) {
                console.log("Hiển thị tin nhắn cho cuộc trò chuyện hiện tại");
                // Đánh dấu tin nhắn đã đọc nếu cần
                if (message.messageId && !isFromCurrentSender) {
                    markMessageAsRead(message.messageId);
                }
                
                // Hiển thị tin nhắn
                displayMessage(message);
                
                // Đảm bảo cuộn xuống tin nhắn mới
                setTimeout(() => {
                    const chatContainer = document.getElementById('content');
                    if (chatContainer) {
                        scrollToBottom(chatContainer);
                    }
                }, 100);
            } else {
                console.log("Tin nhắn không thuộc cuộc trò chuyện hiện tại, không hiển thị");
                // Nếu không phải cuộc trò chuyện hiện tại, cập nhật số tin nhắn chưa đọc
                const conversationElement = document.querySelector(`[data-conversation-id="${message.conversationId}"]`);
                if (conversationElement) {
                    const unreadBadge = conversationElement.querySelector('.badge');
                    if (unreadBadge) {
                        const currentCount = parseInt(unreadBadge.textContent || '0');
                        unreadBadge.textContent = currentCount + 1;
                        unreadBadge.style.display = 'block';
                    }
                }
            }
        } catch (error) {
            console.error("Lỗi khi xử lý tin nhắn riêng tư:", error);
        }
    }

    // Xử lý khi nhận tin nhắn nhóm
    function onGroupMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        console.log("Nhận tin nhắn nhóm:", message);

        // Kiểm tra cấu trúc tin nhắn
        const hasValidStructure = message && (message.groupId || message.conversationId || message.recipient);
        if (!hasValidStructure) {
            console.error("Cấu trúc tin nhắn nhóm không hợp lệ:", message);
            return;
        }
        
        // Kiểm tra xem tin nhắn có phải từ người gửi hiện tại không
        const isFromCurrentSender = message.sender === currentUsername || message.senderId === currentUserId?.toString();
        
        // Xác định ID của nhóm để so sánh
        const groupId = message.conversationId || message.groupId || message.recipient;
        
        // Kiểm tra xem tin nhắn có thuộc cuộc trò chuyện nhóm hiện tại không
        const isForCurrentGroup = currentConversationId && currentConversationId.toString() === groupId?.toString();
        
        // Log thông tin chi tiết để debug
        console.log("Thông tin tin nhắn nhóm:", {
            messageGroupId: groupId,
            currentConvId: currentConversationId,
            messageSenderId: message.senderId,
            currentUserId: currentUserId,
            isForCurrentGroup: isForCurrentGroup,
            isFromCurrentSender: isFromCurrentSender
        });
        
        // Nếu không phải từ người dùng hiện tại, cập nhật danh sách cuộc trò chuyện
        if (!isFromCurrentSender) {
            updateConversationList(message.sender || message.senderName);
            
            // Hiển thị thông báo nếu tin nhắn không phải đang xem cuộc trò chuyện nhóm này
            if (!isForCurrentGroup && Notification.permission === 'granted') {
                new Notification('Tin nhắn nhóm mới', {
                    body: `${message.sender || message.senderName}: ${message.content || message.messageText || message.message}`
                });
            }
        }
        
        // Hiển thị tin nhắn nếu đang xem cuộc trò chuyện nhóm này
        if (isForCurrentGroup) {
            console.log("Hiển thị tin nhắn cho cuộc trò chuyện nhóm hiện tại");
            
            // Đánh dấu tin nhắn đã đọc nếu cần
            if (message.messageId && !isFromCurrentSender) {
                markMessageAsRead(message.messageId);
            }
            
            // Hiển thị tin nhắn
            displayMessage(message);
            
            // Đảm bảo cuộn xuống sau khi hiển thị tin nhắn
            setTimeout(() => {
                const chatContainer = document.getElementById('content');
                if (chatContainer) {
                    scrollToBottom(chatContainer);
                }
            }, 100);
        } else {
            console.log("Tin nhắn không thuộc cuộc trò chuyện nhóm hiện tại, không hiển thị");
            
            // Cập nhật số tin nhắn chưa đọc
            const conversationElement = document.querySelector(`[data-conversation-id="${groupId}"]`);
            if (conversationElement) {
                const unreadBadge = conversationElement.querySelector('.badge');
                if (unreadBadge) {
                    const currentCount = parseInt(unreadBadge.textContent || '0');
                    unreadBadge.textContent = currentCount + 1;
                    unreadBadge.style.display = 'block';
                }
            }
        }
    }

    // Gửi tin nhắn
    function sendMessage(event) {
        event.preventDefault();
        
        if (!stompClient || !isConnected) {
            console.error("WebSocket chưa được kết nối, không thể gửi tin nhắn");
            const errorElement = document.getElementById('message-error');
            if (errorElement) {
                errorElement.textContent = "Không thể gửi tin nhắn do mất kết nối. Đang kết nối lại...";
                errorElement.style.display = 'block';
            }
            
            // Thử kết nối lại
            reconnectWebSocket();
            return;
        }
        
        const messageInput = document.getElementById('message-input');
        if (!messageInput) {
            console.error("Không tìm thấy phần tử message-input");
            return;
        }
        
        const messageContent = messageInput.value.trim();
        
        if (!messageContent) {
            console.log("Không gửi tin nhắn rỗng");
            return;
        }
        
        // Kiểm tra xem có cuộc trò chuyện đang mở không
        if (!currentConversationId) {
            console.error("Không có cuộc trò chuyện nào được chọn");
            return;
        }
        
        // Reset input và error message nếu có
        messageInput.value = '';
        const errorElement = document.getElementById('message-error');
        if (errorElement) {
            errorElement.style.display = 'none';
            errorElement.textContent = '';
        }
        
        // Tạo timestamp theo định dạng ISO
        const now = new Date();
        const timeISO = now.toISOString();
        
        // Thiết lập loại tin nhắn mặc định
        let messageType = 'CHAT';
        let destination = '/app/chat.sendMessage';

        // Kiểm tra xem các biến toàn cục đã được khởi tạo chưa
        if (!currentUsername || !currentUserId) {
            console.error("Thông tin người dùng chưa được khởi tạo đầy đủ");
            currentUsername = sessionStorage.getItem('username');
            const userData = JSON.parse(sessionStorage.getItem('user') || '{}');
            if (userData && userData.id) {
                currentUserId = userData.id;
            } else {
                console.error("Không thể lấy thông tin người dùng từ sessionStorage");
                return;
            }
        }

        // Chuẩn bị đối tượng tin nhắn với thông tin đầy đủ
        const chatMessage = {
            senderId: currentUserId,
            sender: currentUsername,
            content: messageContent,
            messageText: messageContent, // Thêm trường messageText để tương thích với phương thức hiển thị
            type: messageType,
            timestamp: timeISO,
            conversationId: currentConversationId  // Thêm conversationId vào tin nhắn
        };

        console.log("===== THÔNG TIN GỬI TIN NHẮN =====");
        console.log("SenderId:", currentUserId);
        console.log("ConversationId:", currentConversationId);
        console.log("IsGroupConversation:", isGroupConversation);
        
        // Phân biệt rõ ràng giữa tin nhắn nhóm và cá nhân dựa trên biến isGroupConversation
        if (isGroupConversation) {
            // TIN NHẮN NHÓM
            messageType = 'GROUP';
            destination = '/app/chat.group';
            chatMessage.type = messageType;
            chatMessage.groupId = currentConversationId.toString();
            chatMessage.recipient = currentConversationId.toString(); // Đặt recipient = groupId để controller có thể đọc
            
            console.log("TIN NHẮN NHÓM:");
            console.log("Destination:", destination);
            console.log("GroupId:", chatMessage.groupId);
        } else if (currentRecipientId) {
            // TIN NHẮN CÁ NHÂN
            messageType = 'PRIVATE';
            destination = '/app/chat.private';
            chatMessage.type = messageType;
            chatMessage.recipientId = currentRecipientId.toString();
            chatMessage.recipient = currentRecipientUsername;

            // Hiển thị tin nhắn ngay khi gửi (optimistic UI)
            chatMessage.isMe = true;
            displayMessage(chatMessage);
        }
        // Tin nhắn nhóm
        else if (currentConversationId && currentConversationId !== 'public') {
            const conversation = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
            if (conversation && conversation.dataset.isGroup === "true") {
                messageType = 'GROUP'; // Đúng theo enum trong MessageType.java
                destination = `/app/chat.group`;
                chatMessage.type = messageType;
                chatMessage.groupId = currentConversationId.toString(); // Thêm groupId rõ ràng
                chatMessage.recipient = currentConversationId.toString();

                // Log chi tiết thông tin tin nhắn nhóm
                console.log(`===== GỬI TIN NHẮN NHÓM ĐẾN ${destination} =====`, {
                    type: chatMessage.type,
                    groupId: chatMessage.groupId,
                    recipient: chatMessage.recipient,
                    senderId: chatMessage.senderId,
                    message: chatMessage.content
                });

                // Hiển thị tin nhắn ngay khi gửi (optimistic UI)
                chatMessage.isMe = true;
                displayMessage(chatMessage);
            }
        }
        
        try {
            // Gửi tin nhắn qua WebSocket
            console.log(`Gửi tin nhắn ${messageType} tới ${destination}:`, chatMessage);
            stompClient.send(destination, {}, JSON.stringify(chatMessage));
        } catch (error) {
            console.error("Lỗi khi gửi tin nhắn:", error);
            const errorElement = document.getElementById('message-error');
            if (errorElement) {
                errorElement.textContent = "Lỗi khi gửi tin nhắn: " + error.message;
                errorElement.style.display = 'block';
            }
        }
        
        // Focus lại vào input để người dùng có thể tiếp tục gõ
        if (messageInput) {
            messageInput.focus();
        }
    }
    
    // Hàm xử lý submit form riêng biệt để đảm bảo không reload trang
    function handleFormSubmit(event) {
        event.preventDefault();
        event.stopPropagation();
        sendMessage(event);
        return false;
    }

    // Cập nhật UI khi nhận tin nhắn mới
    function updateConversationList(senderUsername) {
        // Nếu tin nhắn từ người dùng không có trong danh sách, thêm họ vào
        const userId = currentUserId;
        if (userId) {
            // Cập nhật lại danh sách cuộc trò chuyện để hiển thị tin nhắn mới nhất
            fetchConversations(userId).then(() => {
                console.log("Đã cập nhật danh sách cuộc hội thoại sau khi nhận tin nhắn mới");
            });
        }
    }

    // Đánh dấu tin nhắn đã đọc
    function markMessageAsRead(messageId) {
        fetch(`${baseURL}/messages/${messageId}/read`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + sessionStorage.getItem('token')
            }
        })
        .then(response => {
            if (response.ok) {
                console.log(`Đã đánh dấu tin nhắn ${messageId} là đã đọc`);
            }
        })
        .catch(error => console.error('Lỗi khi đánh dấu tin nhắn đã đọc:', error));
    }

    // Hàm hiển thị tin nhắn trên giao diện
    function displayMessage(message) {
        const content = document.getElementById("show-message");
        if (!content) {
            console.error("Không tìm thấy phần tử hiển thị tin nhắn");
            return;
        }

        console.log("Hiển thị tin nhắn:", message);

        // Xác định xem đây có phải là tin nhắn của người dùng hiện tại không
        const isMe = message.isMe || message.sender === currentUsername || message.senderId === currentUserId?.toString();
        
        // Định dạng thởi gian
        let time;
        try {
            time = formatTime(message.timestamp || message.createdAt || new Date().toISOString());
        } catch(e) {
            console.error("Lỗi định dạng thởi gian:", e);
            time = "Vừa xong";
        }

        if (isMe) {
            // Tin nhắn của người dùng hiện tại (bên phải, màu xanh)
            const messageHTML = `
                <div class="message me">
                    <div class="text-main">
                        <div class="text-group me align-items-center ml-2">
                            <div class="dropdown ml-2">
                                <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="material-icons md-30">more_vert</i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item" th:text="#{message.update}">Update</button>
                                    <button class="dropdown-item" th:text="#{message.delete}">Delete</button>
                                </div>
                            </div>
                            <div class="text me">
                                <p>${escapeHtml(message.content || message.messageText)}</p>
                            </div>
                        </div>
                        <span>${time}</span>
                    </div>
                </div>
            `;
            content.insertAdjacentHTML('beforeend', messageHTML);
        } else {
            // Tin nhắn của người khác (bên trái, màu xám)
            const messageHTML = `
                <div class="message">
                    <div class="text-main">
                        <div class="text-group d-flex align-items-center mr-2">
                            <div class="text">
                                <p>${escapeHtml(message.content || message.messageText)}</p>
                            </div>
                            <div class="dropdown ml-2">
                                <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="material-icons md-30">more_vert</i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item" th:text="#{message.update}">Update</button>
                                    <button class="dropdown-item" th:text="#{message.delete}">Delete</button>
                                </div>
                            </div>
                        </div>
                        <span>${time}</span>
                    </div>
                </div>
            `;
            content.insertAdjacentHTML('beforeend', messageHTML);
        }

        // Cuộn xuống dưới để hiển thị tin nhắn mới nhất
        setTimeout(() => {
            const chatContainer = document.getElementById('content');
            if (chatContainer) {
                scrollToBottom(chatContainer);
            } else {
                console.error("Không tìm thấy container để cuộn");
            }
        }, 100);
    }
    document.getElementById("langSelect").addEventListener("change", function () {
        const selectedLang = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("lang", selectedLang);
        window.location.href = currentUrl.toString();
    });
    document.addEventListener("DOMContentLoaded", function () {
        let username = sessionStorage.getItem("username");

        // if (username) {
        //     username = decodeURIComponent(username);
        // }

        if (!username) {
            console.error("No username found in sessionStorage.");
            return;
        }

        console.log("test: ",username);
        
        // Kiểm tra flag kết nối WebSocket đã được đặt khi đăng nhập
        const shouldConnectWebSocket = sessionStorage.getItem("autoConnectWebSocket");
        if (shouldConnectWebSocket === "true") {
            console.log("Kết nối WebSocket ngay khi trang tải xong...");
            // Kết nối WebSocket ngay lập tức
            connectWebSocket();
            // Xóa flag để không kết nối lại vào lần tải trang tiếp theo
            sessionStorage.removeItem("autoConnectWebSocket");
        }
        
        fetchUserIdByUsername(username);
    });


    function fetchUserIdByUsername(username) {
        const token = sessionStorage.getItem("token");
        console.log(username);
        fetch(`${baseURL}/users/username/${username}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch user ID");
                }
                console.log(response);
                return response.json();
            })
            .then(user => {
                if (!user || !user.userId) {
                    console.error("User not found or invalid response");
                    return;
                }
                sessionStorage.setItem("userId", user.userId);
                
                // Thiết lập biến toàn cục currentUserId và user
                currentUserId = user.userId;
                
                // Lưu thông tin người dùng vào sessionStorage để truy cập sau này
                const userData = {
                    id: user.userId,
                    username: user.username,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    email: user.email
                };
                sessionStorage.setItem("user", JSON.stringify(userData));
                
                // Cập nhật UI
                document.getElementById("firstName").value = user.firstName;
                document.getElementById("lastName").value = user.lastName;
                document.getElementById("email").value = user.email;
                document.getElementById("username").value = user.username;
                document.getElementById("password").value = "";
                console.log("Đã lưu currentUserId:", user.userId);
                const profileName = `${user.firstName} ${user.lastName}`;
                const profileNameElement = document.querySelector(".profile h1");
                if (profileNameElement) {
                    profileNameElement.textContent = profileName;
                }
                const userImage = user.profilePicture ? user.profilePicture : "img/avatars/default-avatar.png";
                const avatarImages = document.querySelectorAll("img.avatar-xl");
                avatarImages.forEach(img => {
                    img.src = userImage;
                });
                fetchUserData(user.userId);
                fetchConversations(user.userId);
                fetchNotifications(user.userId);
                // loadMessages(user.userId);
            })
            .catch(error => console.error("Error fetching user ID:", error));
    }
    function fetchNotifications(userId) {
        const token = sessionStorage.getItem("token");
        fetch(`${baseURL}/contacts/notifications/${userId}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch notifications");
                }
                return response.json();
            })
            .then(data => {
                const alerts = document.getElementById('alerts');
                alerts.innerHTML = '';
                console.log('Fetched notifications:', data);

                data.forEach(req => {
                    const receiverId = Number(req.receiver.id);
                    const senderId = Number(req.sender.id);
                    const currentUserId = Number(userId);

                    const a = document.createElement('a');
                    a.className = "filterNotifications all latest notification";
                    a.href = "#";

                    const date = new Date(req.createdAt).toLocaleDateString();
                    let message = "";
                    let buttonsHtml = "";

                    if (receiverId === currentUserId && req.isAccepted === null) {
                        message = `${req.sender.firstName} ${req.sender.lastName} has sent you a friend request.`;
                        buttonsHtml = `
                        <button class="btn" onclick="acceptRequest(${req.id})">
                            <span class="material-icons">add</span>
                        </button>
                        <button class="btn" onclick="rejectRequest(${req.id})">
                            <span class="material-icons">close</span>
                        </button>
                    `;
                    } else if (senderId === currentUserId && req.isAccepted === true) {
                        message = `${req.receiver.firstName} ${req.receiver.lastName} has accepted your friend request.`;
                    } else {
                        return;
                    }

                    const profilePic = (receiverId === currentUserId
                        ? (req.sender.profilePicture || 'img/avatars/default-avatar.png')
                        : (req.receiver.profilePicture || 'img/avatars/default-avatar.png'));

                    const username = receiverId === currentUserId ? req.sender.username : req.receiver.username;

                    a.innerHTML = `
                    <img class="avatar-md" src="${profilePic}" title="${username}" alt="avatar">
                    <div class="status"><i class="material-icons online">fiber_manual_record</i></div>
                    <div class="data">
                        <p>${message}</p>
                        <span>${date}</span>
                    </div>
                    ${buttonsHtml}
                `;

                    alerts.appendChild(a);
                });
            })
            .catch(err => console.error(err));
    }

    function acceptRequest(requestId) {
        const token = sessionStorage.getItem("token");
        fetch(`${baseURL}/contacts/accept/${requestId}`, {
            method: 'POST',
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to accept request");
                return res.json();
            })
            .then(data => {
                // alert("Request accepted!");
                // Optionally reload or update UI
                // window.location.reload();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error accepting request");
            });
    }

    function rejectRequest(requestId) {
        const token = sessionStorage.getItem("token");
        fetch(`${baseURL}/contacts/decline/${requestId}`, {
            method: 'POST',
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to decline request");
                return res.json();
            })
            .then(data => {
                // alert("Request declined.");
                // Optionally reload or update UI
                // window.location.reload();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error declining request");
            });
    }


    function fetchUserData(userId) {
        const token = sessionStorage.getItem("token");
        console.log(userId);
        console.log(token);
        fetch(`${baseURL}/users/id/${userId}`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch user data");
                }
                return response.json();
            })
            .then(data => {
                let contactsList = document.getElementById('contacts');
                contactsList.innerHTML = '';

                if (!data.contacts || data.contacts.length === 0) {
                    contactsList.innerHTML = "<p>No contacts found</p>";
                    return;
                }
                data.contacts.forEach(contact => {
                    let status = contact.status ? "online" : "offline";
                    let contactCard = `
                <a href="#" class="filterMembers all ${status} contact" data-toggle="list">
                    <img class="avatar-md" src="${contact.contactProfilePicture || 'img/avatars/default-avatar.png'}" data-toggle="tooltip" data-placement="top" title="${contact.contactFirstName}" alt="avatar">
                    <div class="status">
                        <i class="material-icons ${status}">fiber_manual_record</i>
                    </div>
                    <div class="data">
                        <h5>${contact.contactFirstName} ${contact.contactLastName}</h5>
                    </div>
                </a>
            `;
                    contactsList.innerHTML += contactCard;
                });
            })
            .catch(error => console.error("Error fetching user data:", error));
    }


    async function fetchConversations(userId) {
        const token = sessionStorage.getItem("token");
        console.log("Fetching conversations for user:", userId);
        console.log("Token:", token);

        try {
            const [conversationsRes, latestMessagesRes] = await Promise.all([
                fetch(`${baseURL}/conversations/user/${userId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                }),
                fetch(`${baseURL}/messages/latest/${userId}`, {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                })
            ]);

            if (!conversationsRes.ok || !latestMessagesRes.ok) {
                throw new Error("Failed to fetch conversations or messages");
            }

            const conversations = await conversationsRes.json();
            const latestMessages = await latestMessagesRes.json();

            const chatsList = document.getElementById('chats');
            chatsList.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                chatsList.innerHTML = "<p>No conversations found</p>";
                return;
            }

            const latestMessageMap = new Map();
            latestMessages.forEach(msg => {
                latestMessageMap.set(msg.conversation.id, msg);
            });

            conversations.forEach(conversation => {
                const latestMessage = latestMessageMap.get(conversation.id) || null;
                const latestTime = latestMessage ? formatTime(latestMessage.createdAt) : '';
                const latestText = latestMessage ? truncateText(latestMessage.messageText) : 'No messages yet...';
                const unreadCount = latestMessage && latestMessage.isRead === false && latestMessage.sender.id !== userId ? 1 : 0;
                const imageUrl = conversation.imageUrl || 'img/avatars/default-avatar.png';

                const isGroup = conversation.isGroup === true;
                const chatCard = `
                <a href="#list-chat" class="filterDiscussions all single" data-toggle="list" role="tab"
                   data-conversation-id="${conversation.id}"
                   data-recipient-id="${conversation.participantId || ''}" 
                   data-recipient-name="${conversation.name}"
                   data-is-group="${isGroup}"
                   onclick="handleConversationClick(${conversation.id}, ${conversation.participantId || 'null'}, '${conversation.name}', ${isGroup});">
                    <img class="avatar-md" src="${imageUrl}" data-toggle="tooltip" data-placement="top" title="${conversation.name}" alt="avatar">
                    <div class="status">                        <i class="material-icons online">fiber_manual_record</i>
                    </div>
                    ${unreadCount > 0 ? `<div class="new bg-yellow"><span>+${unreadCount}</span></div>` : ''}
                    <div class="data">
                        <h5>${conversation.name}</h5>
                        <span style="color: black">${latestTime}</span>
                        <p style="color: black">${latestText}</p>
                    </div>
                </a>
            `;
                chatsList.insertAdjacentHTML('beforeend', chatCard);
                // fetchMessages(conversations.id, userId, conversation.name);
            });
            // $('[data-toggle="tooltip"]').tooltip();
            // if (conversations.length > 0) {
            //     await fetchMessages(conversations[0].id, userId, conversations[0].name);
            // }

        } catch (error) {
            console.error("Error fetching conversations or messages:", error);
            const chatsList = document.getElementById('chats');
            chatsList.innerHTML = "<p>Error loading conversations</p>";
        }
        
        // Cuộn đến tin nhắn mới nhất sau khi tải tin nhắn
        setTimeout(() => {
            const chatContainer = document.getElementById('content');
            if (chatContainer) {
                scrollToBottom(chatContainer);
                console.log("Đã cuộn xuống tin nhắn mới nhất sau khi chọn cuộc trò chuyện");
            }
        }, 300); // Đợi 300ms để đảm bảo tin nhắn đã được tải và hiển thị
    }
    
    function formatTime(dateTimeString) {
        const date = new Date(dateTimeString);
        const hours = date.getHours();
        const minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'pm' : 'am';
        const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
        return `${formattedHours}:${minutes.toString().padStart(2, '0')}${ampm} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear().toString().slice(-2)}`;
    }

    function truncateText(text, maxLength = 25) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function countUnreadMessages(messages, userId) {
        return messages.filter(m => m.isRead === false && m.sender.id !== userId).length;
    }

    async function fetchMessages(conversationId, userId, conversationName) {
        const token = sessionStorage.getItem("token");
        const content = document.getElementById("show-message");
        content.innerHTML = '';

        try {
            const response = await fetch(`${baseURL}/messages/conversation/${conversationId}`, {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) {
                throw new Error("Failed to fetch messages");
            }

            const topConservation = document.getElementById("top");
            topConservation.innerHTML = `
                <div class="container">
                    <div class="col-md-12">
                        <div class="inside">
                            <div class="data">
                                <h5><a href="#">${conversationName}</a></h5>
                                <span th:text="#{status.online}">Active now</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item" th:text="#{clear.history}"><i class="material-icons">clear</i>Clear History</button>
                                    <button class="dropdown-item" th:text="#{block.contact}"><i class="material-icons">block</i>Block Contact</button>
                                    <button class="dropdown-item" th:text="#{delete.contact}"><i class="material-icons">delete</i>Delete Contact</button>
                                    <button class="dropdown-item" th:text="#{rename}"><i class="material-icons">edit</i>Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            const sendMessage = document.getElementById("send-message");
            sendMessage.innerHTML = `
                <form class="position-relative w-100" id="message-form">
                    <textarea id="message-input" class="form-control" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                    <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                </form>
                <label>
                    <input type="file">
                    <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                </label>`;
                                    
            // Thêm event handler cho form ngay sau khi tạo
            const messageForm = document.getElementById('message-form');
            if (messageForm) {
                // Xóa event listener cũ trước khi thêm cái mới (tránh duplicate)
                messageForm.removeEventListener('submit', handleFormSubmit);
                
                // Thêm event listener mới với hàm xử lý riêng biệt để ngăn form submit
                messageForm.addEventListener('submit', handleFormSubmit);
            }

            // Lưu thông tin cuộc trò chuyện hiện tại
            currentConversationId = conversationId;
            currentRecipientId = userId;
            currentRecipientUsername = conversationName;
                                    
            const messages = await response.json();
            if (!messages || messages.length === 0) {
                content.innerHTML = "<p>No messages yet</p>";
                return;
            }

            messages.forEach(message => {
                const isOwnMessage = message.sender.id === userId;
                const time = formatTime(message.createdAt);
                console.log(message.sender.id, userId);
                if (isOwnMessage) {

                    //send message
                    const messageHTML = `
                                        <div class="message me" >
												<div class="text-main">
													<div class="text-group me align-items-center ml-2" >
                                                        <div class="dropdown ml-2" >
                                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="material-icons md-30">more_vert</i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <button class="dropdown-item" th:text="#{message.update}">Update</button>
                                                                <button class="dropdown-item" th:text="#{message.delete}">Delete</button>
                                                            </div>
                                                        </div>
														<div class="text me">
															<p>${escapeHtml(message.messageText)}</p>
														</div>
													</div>
													<span>${message.isread ? '<i class="material-icons">check</i>' : ''}${time}</span>
												</div>
											</div>
    `;
                    content.insertAdjacentHTML('beforeend', messageHTML);
                } else {
                    // Received Message
                    const messageHTML = `
                                <div class="message" >
												<div class="text-main">
													    <div class="text-group d-flex align-items-center mr-2" >
														<div class="text">
															<p>${escapeHtml(message.messageText)}</p>
														</div>
                                                        <div class="dropdown ml-2" >
                                                            <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="material-icons md-30">more_vert</i>
                                                            </button>
                                                            <div class="dropdown-menu">
                                                                <button class="dropdown-item" th:text="#{message.update}">Update</button>
                                                                <button class="dropdown-item" th:text="#{message.delete}">Delete</button>
                                                            </div>
                                                        </div>
													</div>
													<span>${message.isread ? '<i class="material-icons">check</i>' : ''}${time}</span>
												</div>
											</div>
`;
                    content.insertAdjacentHTML('beforeend', messageHTML);
                }
            });

        } catch (error) {
            console.error("Error fetching messages:", error);
            content.innerHTML = "<p>Error loading messages</p>";
        }
        
        // Cuộn đến tin nhắn mới nhất sau khi tải tin nhắn
        setTimeout(() => {
            const chatContainer = document.getElementById('content');
            if (chatContainer) {
                scrollToBottom(chatContainer);
                console.log("Đã cuộn xuống tin nhắn mới nhất sau khi chọn cuộc trò chuyện");
            }
        }, 300); // Đợi 300ms để đảm bảo tin nhắn đã được tải và hiển thị
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;',
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    function updateProfileUI(userData) {
        const profileNameElement = document.querySelector(".profile h1");
        if (profileNameElement) {
            profileNameElement.textContent = `${userData.firstName} ${userData.lastName}`;
        }

        // const avatarImages = document.querySelectorAll("img.avatar-xl");
        // avatarImages.forEach(img => {
        //     img.src = userData.image || 'img/avatars/default-avatar.png';
        // });
    }
    document.getElementById("change_profile").addEventListener("submit", function(event) {
        console.log("changeProfile called");
        event.preventDefault();
        const token = sessionStorage.getItem("token");
        const userId = sessionStorage.getItem("userId");
        const username = document.getElementById('username').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const update = {
            username,
            firstName,
            lastName,
            email
        };
        if (password && password.length > 8) {
            update.hashPassword = password;
        }
            fetch(`${baseURL}/users/update/${userId}`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(update),
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            }).then(update => {
                console.log(update);
                // sessionStorage.setItem("user", JSON.stringify(update));
                  updateProfileUI(update);
                  // document.getElementById("change_profile").reset();
                })
                .catch(error => console.log(error));
            console.log("this response from change profile");
    });
    function handleConversationClick(conversationId, userId, conversationName, isGroup = false) {
        console.log(`Clicked on conversation: ID=${conversationId}, Name=${conversationName}, IsGroup=${isGroup}`);
        
        // Đánh dấu cuộc trò chuyện đang được chọn trong UI
        document.querySelectorAll('.discussions .person').forEach(item => {
            item.classList.remove('active');
        });
        
        const selectedConversation = document.querySelector(`.person[data-conversation-id="${conversationId}"]`);
        if (selectedConversation) {
            selectedConversation.classList.add('active');
        }
        
        // Reset và cập nhật biến toàn cục
        currentConversationId = conversationId;
        // currentRecipientId = isGroup ? null : userId;
        // currentRecipientUsername = isGroup ? null : conversationName;
        isGroupConversation = isGroup;

        // Xử lý khác nhau cho cuộc trò chuyện nhóm và cá nhân
        if (isGroup) {
            // Đây là nhóm, reset thông tin người nhận cá nhân
            currentRecipientId = null;
            currentRecipientUsername = conversationName;

            // THÊM DÒNG NÀY - Đăng ký nhận tin nhắn nhóm
            console.log(`Đăng ký nhận tin nhắn cho nhóm ID=${conversationId}`);
            subscribeToGroupMessages(conversationId);
        } else {
            // Đây là cuộc trò chuyện cá nhân, lấy thông tin người nhận
            if (selectedConversation && selectedConversation.hasAttribute('data-members')) {
                const recipients = selectedConversation.getAttribute('data-members').split(',');
                currentRecipientId = recipients.find(id => id != currentUserId);
                currentRecipientUsername = conversationName;
            } else {
                console.log("Sử dụng userId từ tham số:", userId);
                currentRecipientId = userId;
                currentRecipientUsername = conversationName;
            }
        }

        console.log("Thông tin cuộc trò chuyện hiện tại:", {
            currentConversationId,
            currentRecipientId,
            currentRecipientUsername,
            currentUserId,
            currentUsername
        });

        const topElement = document.getElementById('top');
        if (topElement) {
            topElement.innerHTML = `
                <div class="container">
                    <div class="col-md-12">
                        <div class="inside">
                            <div class="data">
                                <h5><a href="#">${escapeHtml(conversationName)}</a></h5>
                                <span>${isGroup ? 'Nhóm chat' : 'Trực tuyến'}</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="material-icons md-30">more_vert</i></button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item" th:text="#{clear.history}"><i class="material-icons">clear</i>Clear History</button>
                                    <button class="dropdown-item" th:text="#{block.contact}"><i class="material-icons">block</i>Block Contact</button>
                                    <button class="dropdown-item" th:text="#{delete.contact}"><i class="material-icons">delete</i>Delete Contact</button>
                                    <button class="dropdown-item" th:text="#{rename}"><i class="material-icons">edit</i>Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            const sendMessageElement = document.getElementById('send-message');
            if (sendMessageElement) {
                sendMessageElement.innerHTML = `
                <form class="position-relative w-100" id="message-form">
                    <textarea id="message-input" class="form-control"  rows="1"></textarea>
                    <button type="submit" class="btn send"><i class="material-icons">send</i></button>
                </form>
                <label>
                    <input type="file">
                    <span class="btn attach d-sm-block d-none"><i class="material-icons">attach_file</i></span>
                </label>`;
                
                // Thêm event handler cho form ngay sau khi tạo
                const messageForm = document.getElementById('message-form');
                if (messageForm) {
                    // Xóa event listener cũ trước khi thêm cái mới (tránh duplicate)
                    messageForm.removeEventListener('submit', handleFormSubmit);
                    
                    // Thêm event listener mới với hàm xử lý riêng biệt để ngăn form submit
                    messageForm.addEventListener('submit', handleFormSubmit);
                }

                // Lưu thông tin cuộc trò chuyện hiện tại
                currentConversationId = conversationId;
                currentRecipientId = isGroup ? null : userId;
                currentRecipientUsername = isGroup ? null : conversationName;

                // Tải tin nhắn cho cuộc trò chuyện
                fetchMessages(conversationId, currentUserId, conversationName);
            }

            // Focus lại vào input để người dùng có thể tiếp tục gõ
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.focus();
            }
        }

        // Hàm định dạng thởi gian tin nhắn
        function formatMessageTime(timeISO) {
            const date = new Date(timeISO);
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
            return `${formattedHours}:${minutes.toString().padStart(2, '0')}${ampm}`;
        }

        // Xử lý khi có lỗi kết nối
        function onError(error) {
            console.error("Lỗi kết nối WebSocket:", error);
            isConnected = false;

            // Thử kết nối lại sau 5 giây
            setTimeout(function () {
                if (!isConnected) {
                    console.log("Đang thử kết nối lại...");
                    connectWebSocket();
                }
            }, 5000);
        }

        // Hàm cập nhật UI profile


        // Xử lý khi nhận tin nhắn công khai
        function onPublicMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            console.log("Nhận tin nhắn công khai:", message);

            // Hiển thị tin nhắn nếu đang xem kênh công khai
            if (currentConversationId === 'public') {
                displayMessage(message);
            }
        }

        // Xử lý khi nhận tin nhắn riêng tư
        function onPrivateMessageReceived(payload) {
            try {
                const message = JSON.parse(payload.body);
                console.log("Tin nhắn riêng tư nhận được:", message);
                
                // Kiểm tra xem tin nhắn có phải từ người gửi hiện tại không
                const isFromCurrentSender = message.sender === currentUsername || message.senderId === currentUserId?.toString();
                
                // Kiểm tra xem tin nhắn có phải cho cuộc trò chuyện hiện tại không
                const isForCurrentConversation =
                    (message.senderId === currentRecipientId && message.recipientId === currentUserId?.toString()) || 
                    (message.recipientId === currentRecipientId && message.senderId === currentUserId?.toString());
                
                // Cập nhật UI danh sách cuộc trò chuyện
                if (!isFromCurrentSender) {
                    updateConversationList(message.sender);
                    
                    // Hiển thị thông báo nếu tin nhắn không phải đang trong cuộc trò chuyện hiện tại
                    if (!isForCurrentConversation && Notification.permission === 'granted') {
                        new Notification('Tin nhắn mới', {
                            body: `${message.sender}: ${message.content}`
                        });
                    }
                }
                
                // Nếu là tin nhắn trong cuộc trò chuyện hiện tại, hiển thị ngay
                if (isForCurrentConversation) {
                    // Đánh dấu tin nhắn đã đọc nếu cần
                    if (message.messageId && !isFromCurrentSender) {
                        markMessageAsRead(message.messageId);
                    }
                    
                    // Hiển thị tin nhắn
                    displayMessage(message);
                    
                    // Đảm bảo cuộn xuống sau khi hiển thị tin nhắn
                    setTimeout(() => {
                        const chatContainer = document.getElementById('content');
                        if (chatContainer) {
                            scrollToBottom(chatContainer);
                        }
                    }, 150);
                }
            } catch (error) {
                console.error("Lỗi khi xử lý tin nhắn riêng tư:", error);
            }
        }

        // Xử lý khi nhận tin nhắn nhóm
        function onGroupMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            console.log("Nhận tin nhắn nhóm:", message);

            // Hiển thị tin nhắn nếu đang xem cuộc trò chuyện nhóm này
            const groupId = message.groupId || message.recipient; // Có thể lấy từ groupId hoặc recipient
            if (currentConversationId && currentConversationId.toString() === groupId.toString()) {
                displayMessage(message);
            } else {
                // Cập nhật số tin nhắn chưa đọc
                updateUnreadMessageCount(null, groupId);
            }
        }

        // Gửi tin nhắn
        function sendMessage(event) {
            event.preventDefault();
            
            if (!stompClient || !isConnected) {
                console.error("WebSocket chưa được kết nối, không thể gửi tin nhắn");
                const errorElement = document.getElementById('message-error');
                if (errorElement) {
                    errorElement.textContent = "Không thể gửi tin nhắn do mất kết nối. Đang kết nối lại...";
                    errorElement.style.display = 'block';
                }
                
                // Thử kết nối lại
                reconnectWebSocket();
                return;
            }
            
            const messageInput = document.getElementById('message-input');
            if (!messageInput) {
                console.error("Không tìm thấy phần tử message-input");
                return;
            }
            
            const messageContent = messageInput.value.trim();
            
            if (!messageContent) {
                console.log("Tin nhắn trống, không gửi");
                return;
            }
            
            // Reset input và error message nếu có
            messageInput.value = '';
            const errorElement = document.getElementById('message-error');
            if (errorElement) {
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }
            
            // Tạo timestamp theo định dạng ISO
            const now = new Date();
            const timeISO = now.toISOString();
            
            // Mặc định là tin nhắn công khai
            let messageType = 'PUBLIC';
            let destination = '/app/chat.sendMessage';

            // Kiểm tra xem các biến toàn cục đã được khởi tạo chưa
            if (!currentUsername || !currentUserId) {
                console.error("Thông tin người dùng chưa được khởi tạo đầy đủ");
                currentUsername = sessionStorage.getItem('username');
                const userData = JSON.parse(sessionStorage.getItem('user') || '{}');
                if (userData && userData.id) {
                    currentUserId = userData.id;
                } else {
                    console.error("Không thể lấy thông tin người dùng từ sessionStorage");
                    return;
                }
            }
        }
        
        // Thiết lập header khi chọn cuộc trò chuyện
        document.getElementById("chat-name").textContent = conversationName;
        
        // Tải tin nhắn
        fetchMessages(conversationId, userId, conversationName);
    }
    document.getElementById('uploadInput').addEventListener('change', async function () {
        const file = this.files[0];
        if (!file) return;

        const userId = sessionStorage.getItem('userId');
        const formData = new FormData();
        formData.append("file", file);
        console.log(formData);
        try {
            const response = await fetch(`${baseURL}/users/${userId}/profile-picture`, {
                method: "POST",
                body: formData,
                headers: {
                    "Authorization": `Bearer ${sessionStorage.getItem('token')}`
                },
            });

            if (!response.ok) throw new Error("Upload failed");

            const user = await response.json();
            console.log(user);
            const avatarImages = document.querySelectorAll("img.avatar-xl");
            avatarImages.forEach(img => {
                img.src = user.profilePicture || 'img/avatars/default-avatar.png';
            });
        } catch (error) {
            console.error("Upload failed:", error);
            alert("Failed to upload profile picture.");
        }
    });

    //group chat
    const input = document.getElementById('participant');
    const inputUser = document.getElementById('user');
    const recipientList = document.getElementById('recipient-list');
    let recipient = [sessionStorage.getItem('userId')];
    const formGroupChat = document.getElementById('groupchat');
    const formNewFriend = document.getElementById('newFriend');
    const userTag = document.getElementById('userTag');
    input.addEventListener('keydown', async function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const search = input.value.trim();
            if (search === ''){
                showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                return;
            }
            try {
                const currentUserId = sessionStorage.getItem('userId');
                const response = await fetch(`/api/users/search-contacts?info=${encodeURIComponent(search)}&user=${currentUserId}`);
                if (!response.ok) {
                    showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                    return;
                }
                const user = await response.json();
                recipient.push(user.id.toString());
                const tag = document.createElement('div');
                tag.className = 'recipient-tag';
                tag.innerHTML = `
                <img class="avatar-sm" src="${user.profilePicture || 'img/avatars/default-avatar.png'}" alt="avatar">
                <h5>${user.username}</h5>
                <button class="btn"><i class="material-icons">close</i></button>
            `;

                recipientList.insertBefore(tag, input);
                input.value = '';
                input.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } catch (error) {
                showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                console.error('Fetch error:', error);
                input.value = '';
            }
        }
    });

    recipientList.addEventListener('click', function (e) {
        const isCloseBtn = e.target.closest('button');
        if (isCloseBtn && isCloseBtn.closest('.recipient-tag')) {
            const tag = isCloseBtn.closest('.recipient-tag');
            tag.remove();
        }
    });


    formGroupChat.addEventListener('submit', async function (e) {
        e.preventDefault();

        if (recipient.length < 2) {
            showAlert('Please enter a username or email.', 'alert-message2');
            return;
        }
        console.log(recipient);
        const topic = document.getElementById('topic').value.trim();
        // const message = document.getElementById('message').value.trim();


        const payload = recipient.map(id => parseInt(id));

        try {
            const response = await fetch(`/api/conversations/group?conversationName=${encodeURIComponent(topic || '')}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    "Authorization": `Bearer ${sessionStorage.getItem('token')}`
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                showAlert('Please enter a username or email.', 'alert-message2', 'warning');
                return;
            }

            const conversation = await response.json();
            // showAlert('Conversation created successfully!', 'success');

            formGroupChat.reset();

            recipient = [currentUserId];
            recipientList.querySelectorAll('.recipient-tag').forEach(tag => tag.remove());
        } catch (error) {
            showAlert('Please enter a username or email.', 'alert-message2', 'warning');
            console.error('Fetch error:', error);
        }
    });
    let newUser = null;
    inputUser.addEventListener('keydown', async function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const userInput = document.getElementById('user').value.trim();
            if (userInput === '') {
                showAlert('Please enter a username or email.', 'alert-message1', 'warning');
                return;
            }
            try {
                const currentUserId = sessionStorage.getItem('userId');
                const response = await fetch(`/api/users/search-new?info=${encodeURIComponent(userInput)}&user=${currentUserId}`);
                if (!response.ok) {
                    showAlert('Please enter a username or email.', 'alert-message1', 'warning');
                    return;
                }
                const userData = await response.json();
                // Assuming recipient is an array to store user IDs
                // recipient.push(userData.id.toString());
                const tag = document.createElement('div');
                tag.className = 'user-tag recipient-tag';
                tag.innerHTML = `
                <img class="avatar-sm" src="${userData.profilePicture || 'img/avatars/default-avatar.png'}" alt="avatar">
                <h5>${userData.username}</h5>
                <button class="btn close-btn"><i class="material-icons">close</i></button>
            `;
                newUser = userData.id;
                // Insert tag before the input (replace recipientList with a suitable container if different)
                const container = document.querySelector('.form-group.user-tag');
                container.insertBefore(tag, document.getElementById('user'));
                inputUser.setAttribute('type','hidden');
                // inputUser.
            } catch (error) {
                showAlert('Please enter a username or email.', 'alert-message1');
                console.error('Fetch error:', error);
                // document.getElementById('user').value = '';
                inputUser.removeAttribute('type');
            }
        }
    })
    const userTagContainer = document.querySelector('.form-group.user-tag');
    userTagContainer.addEventListener('click', function (e) {
        const closeBtn = e.target.closest('.close-btn');
        if (closeBtn && closeBtn.closest('.user-tag')) {
            const tag = closeBtn.closest('.user-tag');
            tag.remove();
            newUser = null;
            inputUser.removeAttribute('type');
            inputUser.value = '';
            inputUser.focus();
        }
    });
    formNewFriend.addEventListener('submit', async function (event) {
        event.preventDefault();
        console.log('formNewFriend:', formNewFriend);
        const userOneId = sessionStorage.getItem('userId');
        if(newUser !== null){
            try{
                const response = await fetch(`/api/contacts/create?userOne=${userOneId}&userTwo=${newUser}`,{
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${sessionStorage.getItem('token')}`
                    },
                });
                if (!response.ok) {
                    showAlert('Error when send request.', 'alert-message1', 'warning');

                }
                else{
                    showAlert('Successfully send request.', 'alert-message1', 'success');
                    formNewFriend.reset();
                    newUser = null;
                }
            }catch(error){

                showAlert('Error when send request.', 'alert-message2', 'warning');
                formNewFriend.reset();
                newUser = null;
            }
        }
        else{
            showAlert('Please enter a username or email.', 'alert-message2', 'warning');
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logout');

        if (!logoutBtn) {
            console.error('Logout button not found');
            return;
        }

        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const token = sessionStorage.getItem('token');
            if (!token) {
                console.warn('No token found in sessionStorage');
                return;
            }

            try {
                const response = await fetch(`${baseURL}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        // 'Content-Type': 'application/json',
                    },
                });

                const responseBody = await response.text();
                console.log('Response status:', response.status, 'Body:', responseBody);

                if (response.ok) {
                    // Cleanup session
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('userId');

                    // Redirect to login page
                    window.location.href = 'http://localhost:8080/login';
                } else {
                    alert(`Logout failed: ${responseBody}`);
                }
            } catch (error) {
                console.error('Logout request failed:', error);
                alert('An error occurred during logout. Please try again.');
            }
        });
    });

</script>
</body>
</html>